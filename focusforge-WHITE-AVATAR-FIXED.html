<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusForge</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Accent Color (Default Indigo) */
            --accent: #4F46E5;
            --accent-light: #6366F1;
            --accent-lighter: #818CF8;
            --accent-tint: #EEF2FF;
            
            /* Light Mode Colors (Default) */
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --text-inactive: #94A3B8;
            --border: #E5E7EB;
            --primary: var(--accent);
            --primary-light: var(--accent-light);
            --primary-tint: var(--accent-tint);
            --secondary: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #38BDF8;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-md: rgba(0, 0, 0, 0.12);
            --shadow-lg: rgba(0, 0, 0, 0.2);
        }

        /* Density Modes - Compact: More content on screen */
        body.density-compact .quest-card {
            padding: 12px;
            gap: 10px;
        }

        body.density-compact .section {
            margin-bottom: 12px;
        }

        body.density-compact .content {
            padding: 12px;
        }

        body.density-compact .action-button {
            padding: 10px;
            min-height: 60px;
        }

        body.density-compact .settings-item {
            padding: 10px 0;
        }

        body.density-compact .quest-title {
            font-size: 15px;
        }

        body.density-compact .quest-description {
            font-size: 13px;
            margin-top: 3px;
        }

        body.density-compact .form-input,
        body.density-compact .form-textarea {
            padding: 8px 12px;
            min-height: 36px;
        }

        body.density-compact .submit-button {
            height: 36px;
            padding: 8px 16px;
        }

        body.density-compact .page-header {
            padding: 12px 16px;
        }

        body.density-compact .section-title {
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* Density Modes - Spacious: Better readability and touch targets */
        body.density-spacious .quest-card {
            padding: 28px;
            gap: 20px;
        }

        body.density-spacious .section {
            margin-bottom: 28px;
        }

        body.density-spacious .content {
            padding: 28px;
        }

        body.density-spacious .action-button {
            padding: 20px;
            min-height: 100px;
        }

        body.density-spacious .settings-item {
            padding: 20px 0;
        }

        body.density-spacious .quest-title {
            font-size: 18px;
        }

        body.density-spacious .quest-description {
            font-size: 15px;
            margin-top: 8px;
        }

        body.density-spacious .form-input,
        body.density-spacious .form-textarea {
            padding: 16px 20px;
            min-height: 52px;
        }

        body.density-spacious .submit-button {
            height: 52px;
            padding: 16px 24px;
        }

        body.density-spacious .page-header {
            padding: 24px 20px;
        }

        body.density-spacious .section-title {
            font-size: 20px;
            margin-bottom: 16px;
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --accent-light: var(--accent-lighter);
            --accent-tint: #2A2A40;
            --bg: #121212;
            --card: #1E1E1E;
            --text-primary: #E5E7EB;
            --text-secondary: #94A3B8;
            --text-inactive: #64748B;
            --border: #2A2A2A;
            --primary: var(--accent-light);
            --primary-light: var(--accent-lighter);
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-md: rgba(0, 0, 0, 0.4);
            --shadow-lg: rgba(0, 0, 0, 0.5);
        }

        /* Disable animations when toggle is off */
        body.no-animations * {
            animation: none !important;
            transition: none !important;
        }

        body.no-animations .view {
            animation: none !important;
            transition: none !important;
        }

        /* Dark Mode Specific Adjustments */
        body.dark-mode .auth-page {
            background: var(--bg);
        }

        body.dark-mode .auth-modal {
            background: var(--card);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .auth-input {
            background: #2A2A2A;
            border-color: var(--border);
            color: var(--text-primary);
        }

        body.dark-mode .auth-input:focus {
            background: var(--card);
        }

        body.dark-mode .auth-label {
            background: var(--card);
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        body.dark-mode .stat-card {
            background: var(--card);
            box-shadow: 0 2px 8px var(--shadow);
        }

        body.dark-mode .quest-card {
            background: var(--card);
            box-shadow: 0 2px 8px var(--shadow);
        }

        body.dark-mode .quest-card.completed {
            background: #2A2A2A;
        }

        body.dark-mode .challenge-card {
            background: var(--card);
        }

        body.dark-mode .active-challenge-card {
            background: var(--card);
        }

        body.dark-mode .challenge-progress-bar-container {
            background: #2A1F12;
        }

        body.dark-mode .settings-item {
            background: transparent;
        }

        body.dark-mode .settings-item:hover {
            background: var(--primary-tint);
        }

        body.dark-mode .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        body.dark-mode .account-stat-card {
            background: var(--card);
        }

        body.dark-mode .bottom-nav {
            background: var(--card);
            border-top: 1px solid var(--border);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Auth Page Styles */
        .auth-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .auth-header {
            margin-bottom: 48px;
        }

        .auth-logo {
            font-size: 72px;
            margin-bottom: 16px;
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
        }

        .auth-title {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .auth-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Auth Buttons */
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 48px;
        }

        .auth-btn {
            padding: 16px 32px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-family: 'Outfit', sans-serif;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .auth-btn.primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .auth-btn.primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }

        .auth-btn.outlined {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .auth-btn.outlined:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .auth-btn.guest {
            background: #EEF2FF;
            color: var(--primary);
            font-size: 14px;
            padding: 12px 24px;
        }

        .auth-btn.guest:hover {
            background: var(--primary-tint);
            transform: translateY(-2px);
        }

        .auth-btn.guest:active {
            animation: guestBounce 0.3s ease;
        }

        @keyframes guestBounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Auth Features */
        .auth-features {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .auth-feature {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--card);
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .feature-icon {
            font-size: 18px;
        }

        .feature-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Auth Modal */
        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auth-modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .auth-modal {
            background: var(--card);
            border-radius: 24px;
            padding: 32px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .auth-modal-overlay.show .auth-modal {
            transform: scale(1);
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--border);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--text-secondary);
            color: white;
            transform: rotate(90deg);
        }

        .auth-modal-title {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-modal-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 28px;
        }

        /* Auth Form */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .auth-input {
            width: 100%;
            padding: 16px 16px 16px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Outfit', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .auth-input:focus + .auth-label,
        .auth-input:not(:placeholder-shown) + .auth-label,
        .auth-input:valid + .auth-label {
            top: -10px;
            left: 12px;
            font-size: 12px;
            background: var(--card);
            padding: 0 6px;
            color: var(--primary);
        }

        .auth-input.valid {
            border-color: var(--secondary);
        }

        .auth-input.invalid {
            border-color: #EF4444;
            border-width: 2px;
            background: #FEF2F2;
        }

        .auth-label {
            position: absolute;
            top: 50%;
            left: 16px;
            transform: translateY(-50%);
            font-size: 15px;
            color: var(--text-secondary);
            pointer-events: none;
            transition: all 0.3s ease;
            background: var(--background);
            padding: 0 4px;
        }

        .input-error {
            font-size: 12px;
            color: var(--warning);
            margin-top: 6px;
            min-height: 18px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .input-error.show {
            opacity: 1;
        }

        .auth-submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .auth-submit-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.3);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
        }

        /* Auth Footer */
        .auth-footer {
            margin-top: 20px;
            text-align: center;
        }

        .auth-footer-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-footer-link {
            background: none;
            border: none;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            margin-left: 4px;
        }

        .auth-footer-link:hover {
            text-decoration: underline;
        }

        /* Hide auth page when logged in */
        body.authenticated .auth-page {
            display: none;
        }

        body.authenticated .app-container {
            display: block !important;
        }

        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --secondary: #22C55E;
            --warning: #F59E0B;
            --sky: #38BDF8;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --primary-tint: #EEF2FF;
            --border: #E5E7EB;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --text-inactive: #94A3B8;
            --completed-bg: #E5E7EB;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* View Container */
        .view {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
            opacity: 0;
            transform: translateX(12px);
            transition: opacity 200ms ease-in-out, transform 200ms ease-in-out;
        }

        .view.active {
            display: block;
        }

        .view.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .view.exiting {
            opacity: 0;
            transform: translateX(-12px);
        }

        /* Settings views have no padding at top */
        .settings-view {
            padding-top: 0;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 24px 20px 20px;
            color: white;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .user-info h1 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .user-level {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .total-xp {
            text-align: right;
        }

        .total-xp-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .total-xp-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 22px;
            font-weight: 700;
        }

        .xp-bar-container {
            position: relative;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            border-radius: 100px;
            transition: width 1s cubic-bezier(0.65, 0, 0.35, 1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .xp-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            to {
                left: 200%;
            }
        }

        .xp-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            color: var(--primary);
            mix-blend-mode: multiply;
        }

        /* Page Header (for Quests view) */
        .page-header {
            background: var(--card);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .page-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .info-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-tint);
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .info-button:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .filter-button {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--primary-tint);
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .filter-button:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .filter-button.active {
            background: var(--primary);
            color: white;
        }

        /* Filter Dropdown */
        .filter-dropdown {
            position: absolute;
            top: 48px;
            right: 0;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 8px;
            min-width: 200px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .filter-dropdown.show {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .filter-option {
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-option:hover {
            background: var(--primary-tint);
            color: var(--primary);
        }

        .filter-option.active {
            background: var(--primary);
            color: white;
        }

        .filter-icon {
            font-size: 16px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            background: var(--primary-tint);
            padding: 4px;
            border-radius: 14px;
        }

        .tab-button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }

        /* Content */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
        }

        .stat-icon.completed {
            background: linear-gradient(135deg, var(--secondary) 0%, #16A34A 100%);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .stat-icon.streak {
            background: linear-gradient(135deg, var(--warning) 0%, #F97316 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.6);
            }
        }

        .stat-icon.energy {
            background: linear-gradient(135deg, var(--sky) 0%, #0EA5E9 100%);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quest Cards */
        .quests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quest-card {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .delete-quest-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            z-index: 2;
        }

        .quest-card:hover .delete-quest-btn {
            opacity: 1;
        }

        .delete-quest-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            transform: scale(1.1);
        }

        .quest-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-tint) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .quest-card:hover::before {
            opacity: 1;
        }

        .quest-card.main-quest {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.02) 0%, var(--card) 100%);
            padding: 24px;
        }

        .quest-card.main-quest::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        /* Quest Cards - Extended version for Quests page */
        .quest-list .quest-card {
            cursor: pointer;
        }

        .quest-list .quest-card::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            transition: all 0.3s ease;
        }

        .quest-list .quest-card.main::after {
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .quest-list .quest-card.focus::after {
            background: linear-gradient(180deg, var(--sky) 0%, #0EA5E9 100%);
        }

        .quest-list .quest-card.health::after {
            background: linear-gradient(180deg, var(--secondary) 0%, #16A34A 100%);
        }

        .quest-list .quest-card.habit::after {
            background: linear-gradient(180deg, var(--warning) 0%, #F97316 100%);
        }

        .quest-list .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .quest-list .quest-card:hover::after {
            width: 6px;
        }

        .quest-card.completed {
            opacity: 0.6;
            background: var(--primary-tint);
        }

        .quest-card.completed .quest-content {
            text-decoration: line-through;
            text-decoration-color: var(--text-secondary);
        }

        .quest-content {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .quest-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .quest-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--primary);
            color: white;
        }

        .quest-badge.side {
            background: var(--text-secondary);
        }

        .quest-type-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 6px;
            color: white;
        }

        .quest-type-badge.main {
            background: var(--primary);
        }

        .quest-type-badge.focus {
            background: var(--sky);
        }

        .quest-type-badge.health {
            background: var(--secondary);
        }

        .quest-type-badge.habit {
            background: var(--warning);
        }

        .quest-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .quest-list .quest-title {
            font-size: 17px;
            font-weight: 700;
            line-height: 1.3;
        }

        .quest-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .quest-list .quest-description {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .quest-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .meta-icon {
            font-size: 16px;
        }

        .quest-xp {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-tint);
            padding: 4px 10px;
            border-radius: 8px;
        }

        .xp-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            background: var(--primary-tint);
            padding: 6px 12px;
            border-radius: 10px;
        }

        .quest-checkbox {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid var(--border);
            background: var(--card);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .quest-list .quest-checkbox {
            width: 52px;
            height: 52px;
            font-size: 26px;
        }

        .quest-checkbox:hover {
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .quest-list .quest-checkbox:hover {
            transform: scale(1.08);
            box-shadow: 0 0 0 8px rgba(34, 197, 94, 0.1);
        }

        .quest-checkbox.checked {
            background: var(--secondary);
            border-color: var(--secondary);
            animation: completeCheck 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes completeCheck {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .quest-checkbox.checked::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--secondary);
            animation: ripple 0.6s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Timer Button */
        .quest-timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .timer-button {
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid var(--primary);
            background: var(--primary);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
        }

        .timer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .timer-button.running {
            background: var(--warning);
            border-color: var(--warning);
            animation: pulse 2s ease-in-out infinite;
        }

        .timer-button.paused {
            background: var(--text-secondary);
            border-color: var(--text-secondary);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
            }
        }

        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            min-width: 80px;
            text-align: center;
        }

        .timer-display.running {
            color: var(--warning);
        }

        .timer-progress {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .timer-progress-bar.complete {
            background: linear-gradient(90deg, var(--secondary) 0%, #16A34A 100%);
        }

        .complete-button {
            padding: 8px 16px;
            border-radius: 10px;
            border: 2px solid var(--secondary);
            background: var(--secondary);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 4px;
        }

        .complete-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-button {
            background: var(--primary-tint);
            border: none;
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.15);
            background: var(--primary);
        }

        .action-button:hover .action-icon {
            color: white;
        }

        .action-button:hover .action-label {
            color: white;
        }

        .action-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s ease;
        }

        .action-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        /* Progress Chart */
        .chart-container {
            background: var(--card);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.current {
            background: var(--primary);
        }

        .legend-dot.previous {
            background: #CBD5E1;
        }

        .chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 160px;
            gap: 8px;
        }

        .chart-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .chart-bars {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 120px;
            width: 100%;
            justify-content: center;
        }

        .chart-bar {
            width: 12px;
            border-radius: 6px 6px 0 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: barGrow 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chart-bar.current {
            background: linear-gradient(180deg, var(--primary-light) 0%, var(--primary) 100%);
        }

        .chart-bar.previous {
            background: #CBD5E1;
        }

        @keyframes barGrow {
            from {
                transform: scaleY(0);
            }
            to {
                transform: scaleY(1);
            }
        }

        .chart-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Challenge Card */
        .challenge-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, var(--card) 100%);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 2px solid rgba(245, 158, 11, 0.2);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .challenge-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .challenge-timer {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(100, 116, 139, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .challenge-progress {
            margin-bottom: 12px;
        }

        .challenge-progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .challenge-progress-bar {
            height: 10px;
            background: rgba(245, 158, 11, 0.15);
            border-radius: 100px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning) 0%, #F97316 100%);
            border-radius: 100px;
            transition: width 1s cubic-bezier(0.65, 0, 0.35, 1);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        }

        /* Challenges Page Styles */
        .active-challenge-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, var(--card) 100%);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(245, 158, 11, 0.2);
            position: relative;
            overflow: hidden;
        }

        .active-challenge-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%);
            animation: challengeGlow 3s ease-in-out infinite;
        }

        @keyframes challengeGlow {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
        }

        .challenge-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .challenge-name {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .challenge-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .challenge-progress-section {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .challenge-progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .challenge-progress-bar-container {
            height: 12px;
            background: #FEF3C7;
            border-radius: 100px;
            overflow: hidden;
        }

        .challenge-progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning) 0%, #F97316 100%);
            border-radius: 100px;
            transition: width 1s cubic-bezier(0.65, 0, 0.35, 1);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.5);
            position: relative;
            overflow: hidden;
        }

        .challenge-progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: shimmer 2s infinite;
        }

        .challenge-meta-row {
            display: flex;
            gap: 24px;
            position: relative;
            z-index: 1;
        }

        .challenge-meta-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .meta-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .claim-reward-btn {
            width: 100%;
            padding: 16px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        .claim-reward-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        /* Available Challenges */
        .challenges-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .challenge-warning {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #F59E0B;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 0 20px 20px 20px;
            color: #92400E;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .challenge-warning {
            background: linear-gradient(135deg, #451A03 0%, #78350F 100%);
            border-color: #F59E0B;
            color: #FDE68A;
        }

        .challenge-warning strong {
            font-weight: 700;
        }

        .challenge-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .challenge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }

        .challenge-card.completed {
            background: var(--completed-bg);
            opacity: 0.7;
        }

        .challenge-card.completed:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .challenge-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .challenge-card-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .challenge-card.completed .challenge-card-title {
            color: var(--text-inactive);
        }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .difficulty-badge.easy {
            background: rgba(34, 197, 94, 0.15);
            color: var(--secondary);
        }

        .difficulty-badge.medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .difficulty-badge.hard {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .challenge-reward {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            background: var(--primary-tint);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .challenge-reward.completed-reward {
            color: var(--text-inactive);
            background: rgba(0, 0, 0, 0.05);
        }

        .challenge-card-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .challenge-card.completed .challenge-card-desc {
            color: var(--text-inactive);
        }

        .challenge-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .challenge-duration {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .duration-icon {
            font-size: 16px;
        }

        .start-challenge-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .start-challenge-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .start-challenge-btn:active {
            transform: translateY(0);
        }

        .abandon-challenge-btn {
            margin-top: 16px;
            padding: 12px 24px;
            border: 2px solid #EF4444;
            background: transparent;
            color: #EF4444;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            z-index: 20;
            position: relative;
            pointer-events: auto !important;
        }

        .abandon-challenge-btn:hover {
            background: #EF4444;
            color: white;
            transform: translateY(-1px);
        }

        .abandon-challenge-btn:active {
            transform: translateY(0);
        }

        .no-challenges-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-challenges-message .challenge-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .no-challenges-message h3 {
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .no-challenges-message p {
            font-size: 14px;
            line-height: 1.5;
        }

        #activeChallengesContainer {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .completed-challenge-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .completed-challenge-item.failed {
            border-color: #EF4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
        }

        body.dark-mode .completed-challenge-item.failed {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        }

        .challenge-failure-note {
            font-size: 13px;
            color: #EF4444;
            font-weight: 500;
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border-left: 3px solid #EF4444;
        }

        .completed-challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .completed-challenge-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .completed-challenge-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .completed-challenge-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 8px 0;
        }

        .completed-challenge-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .completed-challenge-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .completed-challenge-xp {
            font-size: 14px;
            font-weight: 600;
            color: var(--success);
        }

        /* Account/Profile Page Styles */
        .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 40px 20px;
            text-align: center;
            border-radius: 0 0 24px 24px;
            margin: -20px -20px 20px -20px;
            color: white;
        }

        .profile-avatar {
            margin-bottom: 16px;
        }

        .profile-avatar-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }

        .avatar-menu-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: 2px solid var(--card);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .avatar-menu-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .avatar-menu-dropdown {
            position: absolute;
            top: 35px;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .avatar-menu-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .avatar-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .avatar-menu-item:hover {
            background: var(--bg-secondary);
        }

        .avatar-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin: 0 auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .avatar-circle:hover {
            transform: scale(1.05);
        }

        /* Avatar Selector Modal */
        .avatar-selector-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        body.dark-mode .avatar-selector-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        .avatar-selector-overlay.show {
            display: flex;
        }

        .avatar-selector-modal {
            background: var(--card);
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .avatar-selector-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .avatar-selector-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .avatar-selector-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .avatar-selector-note {
            font-size: 13px;
            color: var(--warning);
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--warning);
        }

        .avatar-grid {
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
            overflow-y: auto;
            max-height: 400px;
        }

        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .avatar-option:hover {
            border-color: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }

        .avatar-option.selected {
            border-color: var(--success);
            border-width: 4px;
            transform: scale(1.15);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
        }

        .avatar-option.camera-option {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 32px;
            border-color: var(--primary);
        }

        .avatar-option.camera-option:hover {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
        }

        .avatar-option.custom-image {
            padding: 0;
            overflow: hidden;
        }

        .avatar-option.custom-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-selector-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .avatar-cancel-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: var(--border);
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-cancel-btn:hover {
            background: var(--text-secondary);
            color: var(--bg);
        }

        .avatar-save-btn {
            padding: 12px 32px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-save-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        /* Image Cropper Modal */
        .cropper-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .cropper-overlay.show {
            display: flex;
        }

        .cropper-modal {
            background: var(--card);
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }

        .cropper-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .cropper-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .cropper-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cropper-container {
            padding: 24px;
        }

        .cropper-canvas-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #cropperCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            touch-action: none;
        }

        .cropper-circle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            border: 3px solid var(--primary);
        }

        .cropper-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cropper-control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cropper-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .cropper-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        .cropper-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .cropper-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .cropper-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .cropper-cancel-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: var(--border);
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cropper-cancel-btn:hover {
            background: var(--text-secondary);
            color: var(--bg);
        }

        .cropper-save-btn {
            padding: 12px 32px;
            border-radius: 12px;
            border: none;
            background: var(--success);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cropper-save-btn:hover {
            background: #16A34A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        .profile-name {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 8px;
            color: white;
        }

        .profile-level-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .profile-xp-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 16px;
        }

        .profile-xp-bar-container {
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            overflow: hidden;
            margin: 0 auto 8px;
            max-width: 300px;
        }

        .profile-xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            border-radius: 100px;
            transition: width 1s cubic-bezier(0.65, 0, 0.35, 1);
        }

        .profile-xp-progress {
            font-size: 12px;
            opacity: 0.8;
        }

        .edit-profile-btn {
            margin-top: 16px;
            padding: 10px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .edit-profile-btn:active {
            transform: translateY(0);
        }

        /* Edit Profile Page */
        .edit-profile-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 1000;
            overflow-y: auto;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(100%);
            }
        }

        .edit-profile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: var(--primary-tint);
        }

        .back-button:active {
            transform: scale(0.95);
        }

        .edit-profile-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .edit-profile-content {
            padding: 24px 16px;
            max-width: 500px;
            margin: 0 auto;
        }

        .edit-avatar-section {
            text-align: center;
            margin-bottom: 32px;
            overflow: hidden;
            position: relative;
        }

        .edit-avatar-container {
            position: relative;
            display: inline-block;
        }

        .edit-avatar-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            border: 4px solid var(--primary);
            box-shadow: 0 4px 12px var(--shadow-md);
            overflow: hidden;
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-avatar-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px var(--shadow-lg);
        }

        .edit-avatar-circle:active {
            transform: scale(0.98);
        }

        .change-photo-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid var(--card);
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .change-photo-btn:hover {
            transform: scale(1.1);
        }

        .change-photo-btn:active {
            transform: scale(0.95);
        }

        .edit-profile-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .edit-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .edit-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .edit-input {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            color: var(--text-primary);
            background: var(--card);
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
        }

        .edit-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .edit-input.valid {
            border-color: var(--secondary);
        }

        .edit-input.invalid {
            border-color: var(--warning);
        }

        .edit-input.readonly {
            background: var(--bg);
            color: var(--text-inactive);
            cursor: not-allowed;
        }

        .edit-helper-text {
            font-size: 12px;
            color: var(--text-inactive);
        }

        .edit-error-message {
            font-size: 12px;
            color: var(--warning);
            display: none;
        }

        .edit-error-message.show {
            display: block;
        }

        .edit-form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .edit-cancel-btn, .edit-save-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: 'Outfit', sans-serif;
        }

        .edit-cancel-btn {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-secondary);
        }

        .edit-cancel-btn:hover {
            background: var(--bg);
            border-color: var(--text-secondary);
        }

        .edit-save-btn {
            background: var(--primary);
            color: white;
        }

        .edit-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .edit-save-btn:active, .edit-cancel-btn:active {
            transform: scale(0.98);
        }

        /* Account Stats Grid */
        .account-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .account-stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .account-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .account-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .account-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .account-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Settings List */
        .settings-list {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--primary-tint);
        }

        .settings-item:active {
            background: var(--border);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-icon {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-chevron {
            font-size: 24px;
            color: var(--text-inactive);
        }

        /* Account Actions */
        .account-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .account-action-btn {
            width: 100%;
            padding: 16px 20px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .account-action-btn.warning {
            background: transparent;
            border: 2px solid var(--warning);
            color: var(--warning);
        }

        .account-action-btn.warning:hover {
            background: var(--warning);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .account-action-btn.danger {
            background: transparent;
            border: 2px solid #EF4444;
            color: #EF4444;
        }

        .account-action-btn.danger:hover {
            background: #EF4444;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .action-icon {
            font-size: 18px;
        }

        /* ==================== BADGES SYSTEM ==================== */
        
        /* Badges Screen - Main Container */
        .badges-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #F8FAFC;
            z-index: 1000;
            overflow-y: auto;
            padding-bottom: 80px;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 250ms cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode .badges-screen {
            background: #020617;
        }

        .badges-screen.active {
            transform: translateX(0);
            opacity: 1;
        }

        /* Header */
        .badges-screen-header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E7EB;
            padding: 20px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        body.dark-mode .badges-screen-header {
            background: #0F172A;
            border-bottom-color: #334155;
        }

        .badges-back-btn {
            background: transparent;
            border: none;
            color: #4F46E5;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        body.dark-mode .badges-back-btn {
            color: #818CF8;
        }

        .badges-back-btn:hover {
            transform: translateX(-4px);
        }

        .back-arrow {
            font-weight: bold;
        }

        .badges-screen-title {
            font-size: 24px;
            font-weight: 700;
            color: #4F46E5;
            margin: 0;
        }

        body.dark-mode .badges-screen-title {
            color: #818CF8;
        }

        /* Progress Bar */
        .badges-progress-bar {
            background: #FFFFFF;
            padding: 16px 20px;
            margin: 16px 20px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
            text-align: center;
        }

        body.dark-mode .badges-progress-bar {
            background: #0F172A;
            border-color: #334155;
        }

        .badges-progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
        }

        body.dark-mode .badges-progress-text {
            color: #F1F5F9;
        }

        /* Content */
        .badges-screen-content {
            padding: 0 20px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .badge-category-section {
            margin-bottom: 32px;
        }

        .badge-category-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E5E7EB;
        }

        body.dark-mode .badge-category-title {
            color: #F1F5F9;
            border-bottom-color: #334155;
        }

        /* Badge Grid */
        .badges-grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
        }

        /* Badge Cards */
        .badge-card-item {
            background: #FFFFFF;
            border: 2px solid #E5E7EB;
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        body.dark-mode .badge-card-item {
            background: #0F172A;
            border-color: #334155;
        }

        /* Earned Badge */
        .badge-card-item.earned {
            background: #FFFFFF;
            border-color: #22C55E;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2),
                        0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .badge-card-item.earned {
            background: #0F172A;
            border-color: #22C55E;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2),
                        0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .badge-card-item.earned:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3),
                        0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* Locked Badge */
        .badge-card-item.locked {
            filter: grayscale(100%) blur(0.5px);
            opacity: 0.6;
        }

        .badge-card-item.locked:hover {
            opacity: 0.8;
        }

        .badge-card-icon {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
        }

        .badge-card-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #1F2937;
        }

        body.dark-mode .badge-card-title {
            color: #F1F5F9;
        }

        .badge-card-description {
            font-size: 11px;
            color: #6B7280;
            line-height: 1.4;
        }

        body.dark-mode .badge-card-description {
            color: #94A3B8;
        }

        .badge-card-lock {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 18px;
            color: #94A3B8;
        }

        body.dark-mode .badge-card-lock {
            color: #64748B;
        }

        .badge-card-date {
            font-size: 10px;
            color: #22C55E;
            margin-top: 8px;
            font-weight: 600;
        }

        /* Badge Detail Modal */
        .badge-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            opacity: 0;
            transition: opacity 200ms;
            pointer-events: none;
        }

        .badge-modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .badge-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: #FFFFFF;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10001;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 400px;
            width: 90%;
            opacity: 0;
            pointer-events: none;
        }

        body.dark-mode .badge-modal {
            background: #020617;
        }

        .badge-modal.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .badge-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .badge-modal-icon {
            font-size: 80px;
            margin-bottom: 16px;
            animation: modalBounce 0.5s ease;
        }

        @keyframes modalBounce {
            0% { transform: scale(0.5); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .badge-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: #4F46E5;
            margin: 0 0 12px 0;
        }

        body.dark-mode .badge-modal-title {
            color: #6366F1;
        }

        .badge-modal-description {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.6;
            margin: 0 0 16px 0;
        }

        body.dark-mode .badge-modal-description {
            color: #94A3B8;
        }

        .badge-modal-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-modal-status.earned {
            background: rgba(34, 197, 94, 0.1);
            color: #22C55E;
        }

        .badge-modal-status.locked {
            background: rgba(148, 163, 184, 0.1);
            color: #94A3B8;
        }

        body.dark-mode .badge-modal-status.locked {
            color: #64748B;
        }

        /* Badge Unlock Notification */
        .badge-unlock-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10000;
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        body.dark-mode .badge-unlock-popup {
            background: #020617;
        }

        .badge-unlock-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .badge-unlock-popup .badge-icon {
            font-size: 80px;
            animation: bounceIn 0.6s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .badge-unlock-title {
            font-size: 24px;
            font-weight: 800;
            color: #4F46E5;
            margin: 16px 0 8px 0;
        }

        body.dark-mode .badge-unlock-title {
            color: #6366F1;
        }

        .badge-unlock-desc {
            font-size: 14px;
            color: #6B7280;
        }

        body.dark-mode .badge-unlock-desc {
            color: #94A3B8;
        }

        .badge-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .badge-unlock-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .badges-grid-layout {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
                gap: 12px;
            }

            .badge-card-item {
                padding: 16px 12px;
            }

            .badge-card-icon {
                font-size: 40px;
            }

            .badge-card-title {
                font-size: 12px;
            }

            .badge-card-description {
                font-size: 10px;
            }
        }

        /* ==================== END BADGES SYSTEM ==================== */

        /* Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-modal-overlay.show {
            display: flex;
        }

        .confirm-modal {
            background: var(--card);
            border-radius: 20px;
            padding: 28px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .confirm-modal-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .confirm-modal-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .confirm-modal-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .confirm-btn.cancel {
            background: var(--border);
            color: var(--text-primary);
        }

        .confirm-btn.cancel:hover {
            background: var(--text-secondary);
            color: white;
        }

        .confirm-btn.confirm {
            background: #EF4444;
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        /* Settings Views */
        .settings-view {
            background: var(--background);
        }

        .settings-header {
            background: var(--card);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-tint);
            border: none;
            color: var(--primary);
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .settings-header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .settings-subtext {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Toggle Switch */
        .toggle-item {
            cursor: default;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Select Input */
        .setting-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: var(--card);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setting-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Time Input */
        .time-input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: var(--card);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .time-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .test-notification-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-notification-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .test-notification-btn:active {
            transform: translateY(0);
        }

        /* Color Picker */
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .color-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-radius: 14px;
            background: var(--card);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .color-option.selected {
            border-color: var(--primary);
            background: var(--primary-tint);
        }

        .color-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .color-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Info Card */
        .info-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .info-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .info-content {
            flex: 1;
        }

        .info-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Quests Page Specific */
        .quests-container {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 4px;
        }

        .section-title-alt {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quest-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--primary-tint);
            padding: 4px 10px;
            border-radius: 8px;
        }

        /* Completed Section */
        .completed-section {
            margin-top: 32px;
        }

        .completed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--card);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .completed-header:hover {
            background: var(--primary-tint);
        }

        .completed-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .completed-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .completed-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: var(--secondary);
            padding: 4px 10px;
            border-radius: 8px;
        }

        .collapse-icon {
            font-size: 20px;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .completed-list {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 1;
        }

        .completed-list.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 96px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fabBounce 3s ease-in-out infinite;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 30px rgba(79, 70, 229, 0.6);
        }

        @keyframes fabBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .nav-icon {
            font-size: 24px;
            color: var(--text-inactive);
            transition: all 200ms ease-in-out;
        }

        .nav-label {
            font-size: 11px;
            color: var(--text-inactive);
            font-weight: 500;
            transition: all 200ms ease-in-out;
        }

        .nav-item.active .nav-icon,
        .nav-item.active .nav-label {
            color: var(--primary);
        }

        .nav-item.active .nav-icon {
            animation: navIconPulse 300ms ease-in-out;
        }

        @keyframes navIconPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .nav-item.active {
            background: var(--primary-tint);
        }

        /* XP Popup */
        .xp-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--secondary);
            color: white;
            padding: 24px 32px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.4);
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
        }

        .xp-popup.show {
            animation: popupBurst 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popupBurst {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: var(--card);
            border-radius: 24px 24px 0 0;
            padding: 32px 24px;
            z-index: 201;
            transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal.show {
            bottom: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--border);
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .category-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .category-option {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }

        .category-option:hover {
            border-color: var(--primary);
            background: var(--primary-tint);
        }

        .category-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .submit-button {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        .submit-button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }

        /* Responsive */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .category-select {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Fullscreen Timer View */
        .timer-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .timer-fullscreen.active {
            display: flex;
        }

        .timer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .timer-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .timer-quest-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 60px;
            text-align: center;
            opacity: 0.9;
        }

        .timer-circle {
            position: relative;
            width: 280px;
            height: 280px;
            margin-bottom: 60px;
        }

        .timer-circle-svg {
            transform: rotate(-90deg);
        }

        .timer-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 12;
        }

        .timer-circle-progress {
            fill: none;
            stroke: white;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }

        .timer-time-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 56px;
            font-weight: 700;
            color: white;
            text-align: center;
        }

        .timer-controls {
            display: flex;
            gap: 20px;
            margin-top: 40px;
        }

        .timer-control-btn {
            padding: 16px 40px;
            border-radius: 16px;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .timer-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .timer-control-btn.primary {
            background: white;
            color: var(--primary);
        }

        .timer-control-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.3);
        }
        /* Break Games Section */
        .break-games-section {
            padding: 24px 16px;
            margin-top: 20px;
        }

        .break-games-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
            border: none;
            border-radius: 16px;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            transition: all 0.3s;
        }

        .break-games-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
        }

        .break-icon {
            font-size: 32px;
        }

        .break-text {
            font-size: 18px;
            font-weight: 700;
        }

        .break-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Platform Hopper Styles */
        .break-games-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #6D83F2 0%, #8B5CF6 100%);
            z-index: 1000;
            overflow: hidden;
            animation: slideUpFade 0.4s ease-out;
        }

        @keyframes slideUpFade {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .platformer-start-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .platformer-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #6D83F2 0%, #8B5CF6 100%);
            z-index: -1;
        }

        .platformer-title {
            font-size: 48px;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 8px rgba(79, 70, 229, 0.5),
                        -2px -2px 0 #4F46E5,
                        2px -2px 0 #4F46E5,
                        -2px 2px 0 #4F46E5,
                        2px 2px 0 #4F46E5;
            letter-spacing: 2px;
            margin-bottom: 40px;
            animation: titleBounce 2s ease-in-out infinite;
        }

        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .platformer-platforms-float {
            position: absolute;
            width: 100%;
            height: 200px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .float-platform {
            position: absolute;
            width: 120px;
            height: 20px;
            background: #E5E7EB;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: floatUp 3s ease-in-out infinite;
        }

        @keyframes floatUp {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .platformer-play-btn {
            padding: 18px 48px;
            background: #22C55E;
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
            animation: btnBounce 1.5s ease-in-out infinite;
            transition: all 0.2s;
            margin-top: 60px;
        }

        @keyframes btnBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .platformer-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.5);
        }

        .platformer-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .platformer-back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Game Container */
        .platformer-game-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #87CEEB;
        }

        .platformer-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.3);
            color: #000000;
            font-size: 18px;
            font-weight: 700;
            z-index: 10;
        }

        .platformer-controls-hint {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 13px;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
        }

        /* Mobile Touch Controls */
        .mobile-controls {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 15;
            pointer-events: none;
        }

        .mobile-controls > * {
            pointer-events: all;
        }

        .mobile-dpad {
            display: flex;
            gap: 12px;
        }

        .mobile-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.4);
            background: rgba(79, 70, 229, 0.7);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            transition: all 0.1s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .mobile-btn:active {
            transform: scale(0.9);
            background: rgba(79, 70, 229, 0.9);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .mobile-jump {
            width: 80px;
            height: 80px;
            background: rgba(34, 197, 94, 0.7);
            flex-direction: column;
            gap: 4px;
            font-size: 24px;
        }

        .mobile-jump:active {
            background: rgba(34, 197, 94, 0.9);
        }

        #platformerCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .platformer-game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 20;
        }

        .platformer-game-over h2 {
            font-size: 32px;
            color: #EF4444;
            margin-bottom: 20px;
        }

        .final-score, .final-coins {
            font-size: 20px;
            margin: 10px 0;
            color: #1E293B;
        }

        .high-score-display {
            font-size: 18px;
            margin: 15px 0;
            color: #1E293B;
        }

        .platformer-retry-btn, .platformer-menu-btn {
            padding: 14px 32px;
            margin: 10px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .platformer-retry-btn {
            background: #22C55E;
            color: white;
        }

        .platformer-menu-btn {
            background: #94A3B8;
            color: white;
        }

        .platformer-retry-btn:hover, .platformer-menu-btn:hover {
            transform: scale(1.05);
        }

        /* ==================== GUIDED BANNER ==================== */
        
        .guided-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #F8FAFC;
            padding: 16px 20px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-100%);
            transition: all 0.5s ease;
        }

        body.dark-mode .guided-banner {
            background: #0F172A;
        }

        .guided-banner.show {
            opacity: 1;
            transform: translateY(0);
        }

        .guided-banner.hide {
            opacity: 0;
            transform: translateY(-100%);
        }

        .guided-banner-text {
            font-size: 16px;
            font-weight: 600;
        }

        /* Different text colors for different steps */
        .guided-banner.step-scroll .guided-banner-text {
            color: #334155;
        }

        body.dark-mode .guided-banner.step-scroll .guided-banner-text {
            color: #E5E7EB;
        }

        .guided-banner.step-quest .guided-banner-text {
            color: #4F46E5;
        }

        body.dark-mode .guided-banner.step-quest .guided-banner-text {
            color: #6366F1;
        }

        .guided-banner.step-badges .guided-banner-text {
            color: #22C55E;
        }

        .guided-banner.step-explore .guided-banner-text {
            color: #4F46E5;
        }

        body.dark-mode .guided-banner.step-explore .guided-banner-text {
            color: #6366F1;
        }

        /* ==================== END GUIDED BANNER ==================== */

    </style>
</head>
<body>
    <!-- Login/Sign-Up Page (PAUSED FOR NOW) -->
    <!-- PAUSED FOR DEVELOPMENT: Auth page hidden -->
    <div class="auth-page" id="authPage" style="display: none !important;">
        <div class="auth-container">
            <!-- Logo & Title -->
            <div class="auth-header">
                <div class="auth-logo"></div>
                <h1 class="auth-title">FocusForge</h1>
                <p class="auth-subtitle">Build habits. Level up yourself.</p>
            </div>

            <!-- Auth Buttons -->
            <div class="auth-buttons">
                <button class="auth-btn primary" onclick="showLoginModal()">
                    Log In
                </button>
                <button class="auth-btn outlined" onclick="showSignUpModal()">
                    Sign Up
                </button>
                <button class="auth-btn guest" onclick="continueAsGuest()">
                    Continue as Guest
                </button>
            </div>

            <!-- Features -->
            <div class="auth-features">
                <div class="auth-feature">
                    <span class="feature-icon"></span>
                    <span class="feature-text">Track daily quests</span>
                </div>
                <div class="auth-feature">
                    <span class="feature-icon"></span>
                    <span class="feature-text">Complete challenges</span>
                </div>
                <div class="auth-feature">
                    <span class="feature-icon"></span>
                    <span class="feature-text">Earn XP & level up</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="auth-modal-overlay" id="loginModalOverlay">
        <div class="auth-modal">
            <button class="modal-close" onclick="closeAuthModal()"></button>
            <h2 class="auth-modal-title">Welcome Back!</h2>
            <p class="auth-modal-subtitle">Log in to continue your progress</p>
            
            <form class="auth-form" id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="auth-input" placeholder=" " required>
                    <label for="loginEmail" class="auth-label">Email</label>
                    <div class="input-error" id="loginEmailError"></div>
                </div>
                
                <div class="form-group">
                    <input type="password" id="loginPassword" class="auth-input" placeholder=" " required>
                    <label for="loginPassword" class="auth-label">Password</label>
                    <div class="input-error" id="loginPasswordError"></div>
                </div>

                <button type="button" class="auth-submit-btn" onclick="handleLogin(event)">
                    Log In
                </button>
            </form>

            <div class="auth-footer">
                <span class="auth-footer-text">Don't have an account?</span>
                <button class="auth-footer-link" onclick="switchToSignUp()">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="auth-modal-overlay" id="signUpModalOverlay">
        <div class="auth-modal">
            <button class="modal-close" onclick="closeAuthModal()"></button>
            <h2 class="auth-modal-title">Join FocusForge</h2>
            <p class="auth-modal-subtitle">Start building better habits today</p>
            
            <form class="auth-form" id="signUpForm">
                <div class="form-group">
                    <input type="text" id="signUpName" class="auth-input" placeholder=" " required>
                    <label for="signUpName" class="auth-label">Name</label>
                    <div class="input-error" id="signUpNameError"></div>
                </div>

                <div class="form-group">
                    <input type="email" id="signUpEmail" class="auth-input" placeholder=" " required>
                    <label for="signUpEmail" class="auth-label">Email</label>
                    <div class="input-error" id="signUpEmailError"></div>
                </div>
                
                <div class="form-group">
                    <input type="password" id="signUpPassword" class="auth-input" placeholder=" " required minlength="6">
                    <label for="signUpPassword" class="auth-label">Password (min 6 characters)</label>
                    <div class="input-error" id="signUpPasswordError"></div>
                </div>

                <div class="form-group">
                    <input type="password" id="signUpConfirmPassword" class="auth-input" placeholder=" " required minlength="6">
                    <label for="signUpConfirmPassword" class="auth-label">Confirm Password</label>
                    <div class="input-error" id="signUpConfirmPasswordError"></div>
                </div>

                <button type="button" class="auth-submit-btn" onclick="handleSignUp(event)">
                    Create Account
                </button>
            </form>

            <div class="auth-footer">
                <span class="auth-footer-text">Already have an account?</span>
                <button class="auth-footer-link" onclick="switchToLogin()">Log In</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <!-- PAUSED FOR DEVELOPMENT: App container shown immediately -->
    <div class="app-container" id="appContainer" style="display: block;">

    <!-- Dashboard View -->
    <div class="view active visible" id="dashboardView">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="user-info">
                    <h1>Welcome, Guest!</h1>
                    <div class="user-level">LEVEL 1 FORGE BEGINNER</div>
                </div>
                <div class="total-xp">
                    <div class="total-xp-label">Total XP</div>
                    <div class="total-xp-value" id="totalXP">0</div>
                </div>
            </div>
            <div class="xp-bar-container">
                <div class="xp-bar-fill" id="xpBarFill" style="width: 0%"></div>
                <div class="xp-bar-text" id="xpBarText">0 / 100 XP</div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Today's Overview -->
            <div class="section">
                <div class="section-title">Today's Overview</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon completed"></div>
                        <div class="stat-value" id="questsDoneCount">0</div>
                        <div class="stat-label">Quests Done</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon streak"></div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon energy"></div>
                        <div class="stat-value">100%</div>
                        <div class="stat-label">Energy</div>
                    </div>
                </div>
            </div>

            <!-- Today's Quests -->
            <div class="section">
                <div class="section-title">Today's Quests</div>
                <div class="quests-list" id="dashboardQuestsList">
                    <div class="quest-card main-quest" data-xp="150" data-quest-id="quest-morning-routine">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-badge">Main</span>
                            </div>
                            <div class="quest-title">Morning Exercise Routine</div>
                            <div class="quest-description">30 minutes of cardio or strength training</div>
                            <span class="quest-xp"> +150 XP</span>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuest(this)"></div>
                    </div>

                    <div class="quest-card main-quest" data-xp="150" data-quest-id="quest-deep-work">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-badge">Main</span>
                            </div>
                            <div class="quest-title">Read for 20 Minutes</div>
                            <div class="quest-description">Continue current book or start a new one</div>
                            <span class="quest-xp"> +150 XP</span>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuest(this)"></div>
                    </div>

                    <div class="quest-card" data-xp="60" data-quest-id="quest-evening-review">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-badge side">Side</span>
                            </div>
                            <div class="quest-title">Plan Tomorrow's Tasks</div>
                            <div class="quest-description">Set up priorities and schedule for next day</div>
                            <span class="quest-xp"> +60 XP</span>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuest(this)"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section">
                <div class="section-title">Quick Actions</div>
                <div class="quick-actions">
                    <button class="action-button" onclick="openModal()">
                        <div class="action-icon"></div>
                        <div class="action-label">Add Quest</div>
                    </button>
                    <button class="action-button" onclick="openBreakGames()">
                        <div class="action-icon"></div>
                        <div class="action-label">Take Break</div>
                    </button>
                </div>
            </div>

            <!-- Active Challenge -->
            <div class="section">
                <div class="section-title">Active Challenges</div>
                <div id="dashboardActiveChallenges">
                    <div class="challenge-card">
                        <div class="challenge-header">
                            <div class="challenge-title"> No Active Challenge</div>
                            <div class="challenge-timer">-- left</div>
                        </div>
                        <div class="challenge-progress">
                            <div class="challenge-progress-text">
                                <span>Progress</span>
                                <span><strong>0/0 days</strong></span>
                            </div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Need a Break Button -->
        <div class="break-games-section">
            <button class="break-games-btn" onclick="openBreakGames()">
                <span class="break-icon"></span>
                <span class="break-text">Need a break?</span>
                <span class="break-subtitle">Play mini-games to relax</span>
            </button>
        </div>
    </div>

    <!-- Quests View -->
    <div class="view" id="questsView">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-top">
                <h1 class="page-title">Your Quests</h1>
                <button class="filter-button" onclick="toggleFilterDropdown()"></button>
                
                <!-- Filter Dropdown -->
                <div class="filter-dropdown" id="filterDropdown">
                    <div class="filter-option active" data-filter="all">
                        <span class="filter-icon"></span>
                        <span>All Quests</span>
                    </div>
                    <div class="filter-option" data-filter="main">
                        <span class="filter-icon"></span>
                        <span>Main Quests</span>
                    </div>
                    <div class="filter-option" data-filter="side">
                        <span class="filter-icon"></span>
                        <span>Side Quests</span>
                    </div>
                    <div class="filter-option" data-filter="completed">
                        <span class="filter-icon"></span>
                        <span>Completed</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Content -->
        <div class="content">
            <!-- Active Quests -->
            <div class="quests-container" id="activeQuests">
                <div class="section-header">
                    <h2 class="section-title-alt">Active</h2>
                    <span class="quest-count" id="activeCount">8 quests</span>
                </div>

                <div class="quest-list" id="questList">
                    <!-- Deep Work Quest -->
                    <div class="quest-card focus" data-xp="150" data-category="main" data-quest-id="quest-focus-block">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-type-badge main">Main</span>
                            </div>
                            <h3 class="quest-title">Deep Work Session</h3>
                            <p class="quest-description">Complete 90 minutes of uninterrupted focused work on priority tasks.</p>
                            <div class="quest-meta">
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>90 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>Focus</span>
                                </span>
                                <span class="xp-badge"> +150 XP</span>
                            </div>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuestDetailed(this)"></div>
                    </div>

                    <!-- Health Quest -->
                    <div class="quest-card health" data-xp="150" data-category="main" data-quest-id="quest-workout">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-type-badge main">Main</span>
                            </div>
                            <h3 class="quest-title">Morning Exercise</h3>
                            <p class="quest-description">Complete 30 minutes of cardio or strength training to start the day energized.</p>
                            <div class="quest-meta">
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>30 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>Fitness</span>
                                </span>
                                <span class="xp-badge"> +150 XP</span>
                            </div>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuestDetailed(this)"></div>
                    </div>

                    <!-- Habit Quest -->
                    <div class="quest-card habit" data-xp="150" data-category="main" data-quest-id="quest-meditation">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-type-badge main">Main</span>
                            </div>
                            <h3 class="quest-title">Daily Reading</h3>
                            <p class="quest-description">Read for 20 minutes to maintain your 12-day streak.</p>
                            <div class="quest-meta">
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>20 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>Learning</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>12 day streak</span>
                                </span>
                                <span class="xp-badge"> +150 XP</span>
                            </div>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuestDetailed(this)"></div>
                    </div>

                    <!-- Hydration Quest -->
                    <div class="quest-card health" data-xp="60" data-category="side" data-quest-id="quest-water">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-type-badge health">Side</span>
                            </div>
                            <h3 class="quest-title">Hydration Goal</h3>
                            <p class="quest-description">Drink 8 glasses of water throughout the day.</p>
                            <div class="quest-meta">
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>All day</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>Wellness</span>
                                </span>
                                <span class="xp-badge"> +60 XP</span>
                            </div>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuestDetailed(this)"></div>
                    </div>

                    <!-- Planning Quest -->
                    <div class="quest-card habit" data-xp="60" data-category="side" data-quest-id="quest-reading">
                        <div class="quest-content">
                            <div class="quest-header">
                                <span class="quest-type-badge habit">Side</span>
                            </div>
                            <h3 class="quest-title">Evening Planning</h3>
                            <p class="quest-description">Set up tomorrow's schedule and prioritize top 3 tasks.</p>
                            <div class="quest-meta">
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>15 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>Planning</span>
                                </span>
                                <span class="xp-badge"> +60 XP</span>
                            </div>
                        </div>
                        <div class="quest-checkbox" onclick="completeQuestDetailed(this)"></div>
                    </div>
                </div>
            </div>

            <!-- Completed Section -->
            <div class="completed-section">
                <div class="completed-header" onclick="toggleCompleted()">
                    <div class="completed-header-left">
                        <h2 class="completed-title">Completed Today</h2>
                        <span class="completed-count" id="completedCount">0</span>
                    </div>
                    <span class="collapse-icon collapsed" id="collapseIcon"></span>
                </div>
                <div class="completed-list collapsed" id="completedList"></div>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" onclick="openModal()">+</button>

    <!-- XP Popup -->
    <div class="xp-popup" id="xpPopup">+150 XP</div>

    <!-- Guided Banner -->
    <div class="guided-banner" id="guidedBanner" style="display: none;">
        <span class="guided-banner-text" id="guidedBannerText"></span>
    </div>

    <!-- Badge Unlock Popup -->
    <div class="badge-unlock-overlay" id="badgeUnlockOverlay" onclick="closeBadgeUnlock()"></div>
    <div class="badge-unlock-popup" id="badgeUnlockPopup">
        <div class="badge-icon" id="badgeUnlockIcon"></div>
        <h2 class="badge-unlock-title" id="badgeUnlockTitle">Badge Unlocked!</h2>
        <p class="badge-unlock-desc" id="badgeUnlockDesc">You earned a new badge!</p>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
    <div class="modal" id="modal">
        <div class="modal-header">
            <h2 class="modal-title">Create New Quest</h2>
            <button class="modal-close" onclick="closeModal()"></button>
        </div>
        
        <form id="createQuestForm">
            <div class="form-group">
                <label class="form-label">Quest Title</label>
                <input type="text" id="questTitle" class="form-input" placeholder="What do you want to accomplish?" required>
            </div>

            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea id="questDescription" class="form-input form-textarea" placeholder="Add details about this quest..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Category</label>
                <div class="category-select">
                    <div class="category-option" onclick="window.selectCategory(this)" data-category="main"> Main</div>
                    <div class="category-option" onclick="window.selectCategory(this)" data-category="side"> Side</div>
                </div>
            </div>

            <button type="submit" class="submit-button">Create Quest</button>
        </form>
    </div>

    <!-- Challenges View -->
    <div class="view" id="challengesView">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-top">
                <div>
                    <h1 class="page-title">Challenges</h1>
                    <p class="page-subtitle">Push yourself a little further</p>
                </div>
                <button class="info-button" onclick="showChallengeInfo()"></button>
            </div>
        </div>

        <!-- Warning Message -->
        <div class="challenge-warning">
             <strong>Remember:</strong> Not doing challenges properly doesn't gain anything for you or anyone else. Doing them properly helps only you, not anyone else.
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Active Challenges -->
            <div class="section">
                <div class="section-title">Active Challenges</div>
                <div id="activeChallengesContainer">
                    <!-- Active challenges will be inserted here -->
                    <div class="no-challenges-message">
                        <div class="challenge-icon"></div>
                        <h3>No Active Challenges</h3>
                        <p>Start a challenge below to begin tracking your progress and earn bonus rewards!</p>
                    </div>
                </div>
            </div>

            <!-- Available Challenges -->
            <div class="section">
                <div class="section-title">Available Challenges</div>
                <div class="challenges-list">
                    <!-- Easy Challenge -->
                    <div class="challenge-card" data-challenge-id="morning-streak-3" data-days="3" data-xp="150" data-quest-id="quest-morning-routine">
                        <div class="challenge-card-header">
                            <div>
                                <h4 class="challenge-card-title">3-Day Morning Streak</h4>
                                <span class="difficulty-badge easy">Easy</span>
                            </div>
                            <div class="challenge-reward"> +150 XP</div>
                        </div>
                        <p class="challenge-card-desc">Complete your morning exercise routine for 3 consecutive days</p>
                        <div class="challenge-card-footer">
                            <div class="challenge-duration">
                                <span class="duration-icon"></span>
                                <span>3 days</span>
                            </div>
                            <button class="start-challenge-btn" onclick="startChallenge(this)">Start Challenge</button>
                        </div>
                    </div>

                    <!-- Medium Challenge -->
                    <div class="challenge-card" data-challenge-id="reading-master-7" data-days="7" data-xp="300" data-quest-id="quest-deep-work">
                        <div class="challenge-card-header">
                            <div>
                                <h4 class="challenge-card-title">Reading Master</h4>
                                <span class="difficulty-badge medium">Medium</span>
                            </div>
                            <div class="challenge-reward"> +300 XP</div>
                        </div>
                        <p class="challenge-card-desc">Read for 20+ minutes every day for a full week</p>
                        <div class="challenge-card-footer">
                            <div class="challenge-duration">
                                <span class="duration-icon"></span>
                                <span>7 days</span>
                            </div>
                            <button class="start-challenge-btn" onclick="startChallenge(this)">Start Challenge</button>
                        </div>
                    </div>

                    <!-- Hard Challenge -->
                    <div class="challenge-card" data-challenge-id="deep-work-marathon-14" data-days="14" data-xp="750" data-quest-id="quest-focus-block">
                        <div class="challenge-card-header">
                            <div>
                                <h4 class="challenge-card-title">Deep Work Marathon</h4>
                                <span class="difficulty-badge hard">Hard</span>
                            </div>
                            <div class="challenge-reward"> +750 XP</div>
                        </div>
                        <p class="challenge-card-desc">Complete 90 minutes of deep work daily for 14 days straight</p>
                        <div class="challenge-card-footer">
                            <div class="challenge-duration">
                                <span class="duration-icon"></span>
                                <span>14 days</span>
                            </div>
                            <button class="start-challenge-btn" onclick="startChallenge(this)">Start Challenge</button>
                        </div>
                    </div>

                    <!-- Easy Challenge -->
                    <div class="challenge-card" data-challenge-id="hydration-hero-5" data-days="5" data-xp="200" data-quest-id="quest-water">
                        <div class="challenge-card-header">
                            <div>
                                <h4 class="challenge-card-title">Hydration Hero</h4>
                                <span class="difficulty-badge easy">Easy</span>
                            </div>
                            <div class="challenge-reward"> +200 XP</div>
                        </div>
                        <p class="challenge-card-desc">Meet your daily hydration goal for 5 consecutive days</p>
                        <div class="challenge-card-footer">
                            <div class="challenge-duration">
                                <span class="duration-icon"></span>
                                <span>5 days</span>
                            </div>
                            <button class="start-challenge-btn" onclick="startChallenge(this)">Start Challenge</button>
                        </div>
                    </div>

                    <!-- Medium Challenge -->
                    <div class="challenge-card" data-challenge-id="consistency-king-10" data-days="10" data-xp="500" data-quest-id="all">
                        <div class="challenge-card-header">
                            <div>
                                <h4 class="challenge-card-title">Consistency King</h4>
                                <span class="difficulty-badge medium">Medium</span>
                            </div>
                            <div class="challenge-reward"> +500 XP</div>
                        </div>
                        <p class="challenge-card-desc">Complete all daily quests without missing a single day for 10 days</p>
                        <div class="challenge-card-footer">
                            <div class="challenge-duration">
                                <span class="duration-icon"></span>
                                <span>10 days</span>
                            </div>
                            <button class="start-challenge-btn" onclick="startChallenge(this)">Start Challenge</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Challenges -->
            <div class="completed-section">
                <div class="completed-header" onclick="toggleCompletedChallenges()">
                    <div class="completed-header-left">
                        <h2 class="completed-title">Completed Challenges</h2>
                        <span class="completed-count" id="completedChallengesCount">0</span>
                    </div>
                    <span class="collapse-icon collapsed" id="collapseChallengesIcon"></span>
                </div>
                <div class="completed-list collapsed" id="completedChallengesList">
                    <!-- No completed challenges yet -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Settings View -->
    <div class="view settings-view" id="notificationSettingsView">
        <div class="settings-header">
            <button class="back-button" onclick="backToAccount()"></button>
            <h2 class="settings-header-title">Notification Preferences</h2>
        </div>
        <div class="content">
            <div class="section">
                <div class="section-title">Daily Reminders</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Daily Quest Reminders</div>
                                <div class="settings-subtext" id="reminderSubtext">Get notified at 11:00 PM if you haven't completed tasks</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dailyQuestRemindersToggle" checked onchange="toggleDailyQuestReminders(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div class="settings-text">Your Age</div>
                        </div>
                        <input type="number" id="userAge" class="time-input" min="1" max="120" placeholder="18" onchange="saveUserAge(this.value)" style="width: 80px; text-align: center;">
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div class="settings-text">Test Notification</div>
                        </div>
                        <button class="test-notification-btn" onclick="testNotification()">Send Test Now</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Updates</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Challenge Updates</div>
                                <div class="settings-subtext">Progress and completion updates</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="challengeUpdatesToggle" checked onchange="toggleChallengeUpdates(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Quiet Hours</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Enable Quiet Hours</div>
                                <div class="settings-subtext">Silence all notifications during set times</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="quietHoursToggle" onchange="toggleQuietHours(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div class="settings-text">Start Time</div>
                        </div>
                        <input type="time" id="quietHoursStart" class="time-input" value="22:00" onchange="saveQuietHours()">
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div class="settings-text">End Time</div>
                        </div>
                        <input type="time" id="quietHoursEnd" class="time-input" value="08:00" onchange="saveQuietHours()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Focus Session Settings View -->
    <div class="view settings-view" id="focusSettingsView">
        <div class="settings-header">
            <button class="back-button" onclick="backToAccount()"></button>
            <h2 class="settings-header-title">Focus Session Settings</h2>
        </div>
        <div class="content">
            <div class="section">
                <div class="section-title">Timer Configuration</div>
                <div class="settings-list">
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Default Session Length</div>
                                <div class="settings-subtext">Standard focus session duration</div>
                            </div>
                        </div>
                        <select class="setting-select">
                            <option value="15">15 min</option>
                            <option value="25" selected>25 min</option>
                            <option value="30">30 min</option>
                            <option value="45">45 min</option>
                            <option value="60">60 min</option>
                            <option value="90">90 min</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Short Break Duration</div>
                                <div class="settings-subtext">Break after each session</div>
                            </div>
                        </div>
                        <select class="setting-select">
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="10">10 min</option>
                            <option value="15">15 min</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Long Break Duration</div>
                                <div class="settings-subtext">Extended break after 4 sessions</div>
                            </div>
                        </div>
                        <select class="setting-select">
                            <option value="15" selected>15 min</option>
                            <option value="20">20 min</option>
                            <option value="30">30 min</option>
                            <option value="45">45 min</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Session Behavior</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Auto-Start Breaks</div>
                                <div class="settings-subtext">Begin break automatically after session</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" onchange="toggleSetting('autoStartBreaks', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Auto-Start Next Session</div>
                                <div class="settings-subtext">Continue to next session after break</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" onchange="toggleSetting('autoStartSession', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Sounds & Feedback</div>
                <div class="settings-list">
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Session Start Sound</div>
                                <div class="settings-subtext">Audio cue when timer begins</div>
                            </div>
                        </div>
                        <select class="setting-select">
                            <option value="none">None</option>
                            <option value="bell" selected>Bell</option>
                            <option value="chime">Chime</option>
                            <option value="gong">Gong</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Session End Sound</div>
                                <div class="settings-subtext">Audio cue when timer completes</div>
                            </div>
                        </div>
                        <select class="setting-select">
                            <option value="none">None</option>
                            <option value="bell">Bell</option>
                            <option value="chime" selected>Chime</option>
                            <option value="gong">Gong</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Quest Integration</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Auto-Grant XP</div>
                                <div class="settings-subtext">Earn XP for completing sessions</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked onchange="toggleSetting('autoGrantXP', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Count Toward Quests</div>
                                <div class="settings-subtext">Sessions mark focus quests as complete</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked onchange="toggleSetting('countTowardQuests', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Settings View -->
    <div class="view settings-view" id="appearanceSettingsView">
        <div class="settings-header">
            <button class="back-button" onclick="backToAccount()"></button>
            <h2 class="settings-header-title">Appearance</h2>
        </div>
        <div class="content">
            <div class="section">
                <div class="section-title">Theme</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Dark Mode</div>
                                <div class="settings-subtext">Switch to dark theme</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Animations</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Enable Transitions and Animations</div>
                                <div class="settings-subtext">Motion effects when switching tabs</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="animationsToggle" checked onchange="toggleAnimations(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">UI Style</div>
                <div class="settings-list">
                    <div class="settings-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Interface Style</div>
                                <div class="settings-subtext">Control layout density</div>
                            </div>
                        </div>
                        <select class="setting-select" id="densitySelect" onchange="changeDensity(this.value)">
                            <option value="comfortable" selected>Comfortable</option>
                            <option value="compact">Compact</option>
                            <option value="spacious">Spacious</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data & Privacy Settings View -->
    <div class="view settings-view" id="privacySettingsView">
        <div class="settings-header">
            <button class="back-button" onclick="backToAccount()"></button>
            <h2 class="settings-header-title">Data & Privacy</h2>
        </div>
        <div class="content">
            <div class="section">
                <div class="section-title">Data Storage</div>
                <div class="info-card">
                    <div class="info-icon"></div>
                    <div class="info-content">
                        <h4 class="info-title">What We Store</h4>
                        <p class="info-text">FocusForge stores your quest completion history, XP progress, challenge data, and focus session records locally on your device. No personal data is shared with third parties.</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Data Management</div>
                <div class="settings-list">
                    <div class="settings-item" onclick="viewStoredData()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">View Stored Data</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="exportData()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Export All Data</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="confirmDeleteData()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text" style="color: #EF4444;">Delete All Data</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Permissions</div>
                <div class="settings-list">
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Notifications</div>
                                <div class="settings-subtext">Allow reminders and alerts</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked onchange="toggleSetting('notificationPermission', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item toggle-item">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <div>
                                <div class="settings-text">Local Storage</div>
                                <div class="settings-subtext">Save progress on this device</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked onchange="toggleSetting('localStoragePermission', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Legal</div>
                <div class="settings-list">
                    <div class="settings-item" onclick="viewPrivacyPolicy()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Privacy Policy</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="viewTermsOfService()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Terms of Service</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account/Profile View -->
    <div class="view" id="accountView">
        <!-- Content -->
        <div class="content">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar-wrapper">
                    <div class="profile-avatar" onclick="openAvatarSelector()" style="cursor: pointer;">
                        <div class="avatar-circle" id="profileAvatar"></div>
                    </div>
                    <button class="avatar-menu-btn" id="avatarMenuBtn" onclick="toggleAvatarMenu(event)">
                        
                    </button>
                    <div class="avatar-menu-dropdown" id="avatarMenuDropdown">
                        <div class="avatar-menu-item" onclick="openCropperForAvatar(); closeAvatarMenu();">
                             Crop Image
                        </div>
                    </div>
                </div>
                <h2 class="profile-name" id="profileName">Guest</h2>
                <p class="profile-level-text" id="profileLevel">Level 1 Forge Beginner</p>
                <p class="profile-xp-text" id="profileTotalXP">0 Total XP</p>
                
                <div class="profile-xp-bar-container">
                    <div class="profile-xp-bar-fill" id="profileXPBar" style="width: 0%"></div>
                </div>
                <p class="profile-xp-progress" id="profileXPProgress">0 / 100 XP to next level</p>
                
                <button class="edit-profile-btn" onclick="openEditProfile()">
                     Edit Profile
                </button>
            </div>

            <!-- Your Stats -->
            <div class="section">
                <div class="section-title">Your Stats</div>
                <div class="account-stats-grid">
                    <div class="account-stat-card">
                        <div class="account-stat-icon" style="background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);"></div>
                        <div class="account-stat-value" id="totalQuestsCompleted">0</div>
                        <div class="account-stat-label">Total Quests</div>
                    </div>
                    <div class="account-stat-card">
                        <div class="account-stat-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #F97316 100%);"></div>
                        <div class="account-stat-value" id="currentStreak">0</div>
                        <div class="account-stat-label">Current Streak</div>
                    </div>
                    <div class="account-stat-card">
                        <div class="account-stat-icon" style="background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);"></div>
                        <div class="account-stat-value" id="longestStreak">0</div>
                        <div class="account-stat-label">Longest Streak</div>
                    </div>
                    <div class="account-stat-card">
                        <div class="account-stat-icon" style="background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);"></div>
                        <div class="account-stat-value" id="challengesCompleted">0</div>
                        <div class="account-stat-label">Challenges Done</div>
                    </div>
                </div>
            </div>

            <!-- Account Settings -->
            <div class="section">
                <div class="section-title">Account Settings</div>
                <div class="settings-list">
                    <div class="settings-item" onclick="openEditProfile()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Edit Profile</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="notificationSettings()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Notification Preferences</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="focusSettings()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Focus Session Settings</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="appearanceSettings()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Appearance</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="privacySettings()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Data & Privacy</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                </div>
            </div>

            <!-- Progress & History -->
            <div class="section">
                <div class="section-title">Progress & History</div>
                <div class="settings-list">
                    <div class="settings-item" onclick="openBadgesPage()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Badges</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="viewWeeklySummary()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Weekly Summary</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                    <div class="settings-item" onclick="exportData()">
                        <div class="settings-item-left">
                            <div class="settings-icon"></div>
                            <span class="settings-text">Export Activity Data</span>
                        </div>
                        <div class="settings-chevron"></div>
                    </div>
                </div>
            </div>

            <!-- Account Actions -->
            <div class="section">
                <div class="section-title">Account Actions</div>
                <div class="account-actions">
                    <button class="account-action-btn warning" onclick="confirmResetProgress()">
                        <span class="action-icon"></span>
                        <span>Reset Progress </span>
                    </button>
                    <button class="account-action-btn danger" onclick="confirmLogout()">
                        <span class="action-icon"></span>
                        <span>Log Out</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Badges Screen -->
    <div class="badges-screen" id="badgesScreen">
        <div class="badges-screen-header">
            <button class="badges-back-btn" onclick="closeBadgesScreen()">
                <span class="back-arrow"></span>
            </button>
            <h1 class="badges-screen-title">Your Badges</h1>
        </div>

        <div class="badges-screen-content">
            <div class="badges-progress-bar">
                <div class="badges-progress-text">
                    <span id="badgesEarnedCount">0</span> / <span id="badgesTotalCount">30</span> Earned
                </div>
            </div>

            <!-- Category: Getting Started -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Getting Started</h2>
                <div class="badges-grid-layout" id="category-getting-started"></div>
            </div>

            <!-- Category: Consistency & Habit -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Consistency & Habit</h2>
                <div class="badges-grid-layout" id="category-consistency"></div>
            </div>

            <!-- Category: Progress & XP -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Progress & XP</h2>
                <div class="badges-grid-layout" id="category-progress"></div>
            </div>

            <!-- Category: Quest-Based -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Quest-Based</h2>
                <div class="badges-grid-layout" id="category-quest"></div>
            </div>

            <!-- Category: Time & Commitment -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Time & Commitment</h2>
                <div class="badges-grid-layout" id="category-time"></div>
            </div>

            <!-- Category: Personalization -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Personalization</h2>
                <div class="badges-grid-layout" id="category-personalization"></div>
            </div>

            <!-- Category: Milestone -->
            <div class="badge-category-section">
                <h2 class="badge-category-title"> Milestone</h2>
                <div class="badges-grid-layout" id="category-milestone"></div>
            </div>
        </div>
    </div>

    <!-- Badge Detail Modal -->
    <div class="badge-modal-overlay" id="badgeModalOverlay" onclick="closeBadgeModal()"></div>
    <div class="badge-modal" id="badgeModal">
        <div class="badge-modal-content">
            <div class="badge-modal-icon" id="badgeModalIcon"></div>
            <h2 class="badge-modal-title" id="badgeModalTitle">Badge Name</h2>
            <p class="badge-modal-description" id="badgeModalDescription">Description</p>
            <div class="badge-modal-status" id="badgeModalStatus">
                <span id="badgeModalStatusText"> Locked</span>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item active" data-view="dashboard" onclick="switchView('dashboard')">
            <div class="nav-icon"></div>
            <div class="nav-label">Dashboard</div>
        </div>
        <div class="nav-item" data-view="quests" onclick="switchView('quests')">
            <div class="nav-icon"></div>
            <div class="nav-label">Quests</div>
        </div>
        <div class="nav-item" data-view="challenges" onclick="switchView('challenges')">
            <div class="nav-icon"></div>
            <div class="nav-label">Challenges</div>
        </div>
        <div class="nav-item" data-view="account" onclick="switchView('account')">
            <div class="nav-icon"></div>
            <div class="nav-label">Profile</div>
        </div>
    </div>

    <!-- Fullscreen Timer -->
    <div class="timer-fullscreen" id="timerFullscreen">
        <button class="timer-close" onclick="closeTimerFullscreen()"></button>
        <div class="timer-quest-title" id="timerQuestTitle">Morning Exercise Routine</div>
        
        <div class="timer-circle">
            <svg class="timer-circle-svg" width="280" height="280">
                <circle class="timer-circle-bg" cx="140" cy="140" r="130"></circle>
                <circle class="timer-circle-progress" id="timerCircleProgress" cx="140" cy="140" r="130" 
                    stroke-dasharray="817" stroke-dashoffset="0"></circle>
            </svg>
            <div class="timer-time-display" id="timerTimeDisplay">30:00</div>
        </div>

        <div class="timer-controls">
            <button class="timer-control-btn" id="timerPauseBtn" onclick="pauseTimer()">Pause</button>
            <button class="timer-control-btn primary" id="timerCompleteBtn" onclick="completeTimerQuest()">Complete Quest</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal-overlay" id="confirmModalOverlay">
        <div class="confirm-modal">
            <h3 class="confirm-modal-title" id="confirmModalTitle">Confirm Action</h3>
            <p class="confirm-modal-text" id="confirmModalText">Are you sure you want to proceed?</p>
            <div class="confirm-modal-actions">
                <button class="confirm-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="confirm-btn confirm" id="confirmModalButton" onclick="executeConfirmedAction()">Confirm</button>
            </div>
        </div>
    </div>

    </div> <!-- Close app-container -->

    <!-- Edit Profile Page -->
    <div class="edit-profile-page" id="editProfilePage" style="display: none;">
        <div class="edit-profile-header">
            <button class="back-button" onclick="closeEditProfile()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <h2 class="edit-profile-title">Edit Profile</h2>
            <div style="width: 40px;"></div> <!-- Spacer for centering -->
        </div>

        <div class="edit-profile-content">
            <!-- Avatar Section -->
            <div class="edit-avatar-section">
                <div class="edit-avatar-container">
                    <div class="edit-avatar-circle" id="editAvatar" onclick="openAvatarSelector()" style="cursor: pointer;"></div>
                </div>
            </div>

            <!-- Form -->
            <form class="edit-profile-form" onsubmit="saveProfileChanges(event)">
                <!-- Display Name -->
                <div class="edit-form-group">
                    <label class="edit-label" for="editDisplayName">Display Name</label>
                    <input 
                        type="text" 
                        id="editDisplayName" 
                        class="edit-input" 
                        placeholder="Enter your display name"
                        required
                        minlength="2"
                        maxlength="30"
                    >
                    <div class="edit-error-message" id="displayNameError"></div>
                </div>

                <!-- Username -->
                <div class="edit-form-group">
                    <label class="edit-label" for="editUsername">Username</label>
                    <input 
                        type="text" 
                        id="editUsername" 
                        class="edit-input" 
                        placeholder="Enter your username"
                        pattern="[a-zA-Z0-9_]+"
                        title="Only letters, numbers, and underscores"
                        minlength="3"
                        maxlength="20"
                    >
                    <div class="edit-helper-text">Letters, numbers, and underscores only</div>
                    <div class="edit-error-message" id="usernameError"></div>
                </div>

                <!-- Email (Read-only) -->
                <div class="edit-form-group">
                    <label class="edit-label" for="editEmail">Email</label>
                    <input 
                        type="email" 
                        id="editEmail" 
                        class="edit-input readonly" 
                        value="guest@focusforge.app"
                        readonly
                    >
                    <div class="edit-helper-text">Email cannot be changed</div>
                </div>

                <!-- Buttons -->
                <div class="edit-form-buttons">
                    <button type="button" class="edit-cancel-btn" onclick="closeEditProfile()">
                        Cancel
                    </button>
                    <button type="submit" class="edit-save-btn">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Break Games Page -->
    <div class="break-games-page" id="breakGamesPage" style="display: none;">
        <!-- Platform Hopper Start Screen -->
        <div class="platformer-start-screen" id="platformerStartScreen">
            <div class="platformer-bg"></div>
            <h1 class="platformer-title">PLATFORM HOPPER</h1>
            <div class="platformer-platforms-float">
                <div class="float-platform" style="left: 15%; animation-delay: 0s;"></div>
                <div class="float-platform" style="left: 45%; animation-delay: 0.5s;"></div>
                <div class="float-platform" style="left: 75%; animation-delay: 1s;"></div>
            </div>
            <button class="platformer-play-btn" onclick="startPlatformerGame()">
                Play Endless
            </button>
            <button class="platformer-back-btn" onclick="closeBreakGames()">
                 Back to Dashboard
            </button>
        </div>

        <!-- Game Canvas -->
        <div class="platformer-game-container" id="platformerGameContainer" style="display: none;">
            <div class="platformer-hud">
                <div class="platformer-score">Score: <span id="platformerScore">0</span></div>
                <div class="platformer-coins"> <span id="platformerCoins">0</span></div>
            </div>
            <canvas id="platformerCanvas"></canvas>
            <div class="platformer-controls-hint">
                 Up Arrow: Jump (Hold for higher jump) |  Left/Right Arrows: Move | Tap screen to jump
            </div>
            
            <!-- Mobile Touch Controls -->
            <div class="mobile-controls">
                <div class="mobile-dpad">
                    <button class="mobile-btn mobile-left" id="mobileLeft"></button>
                    <button class="mobile-btn mobile-right" id="mobileRight"></button>
                </div>
                <button class="mobile-btn mobile-jump" id="mobileJump"><br><span style="font-size: 12px;">JUMP</span></button>
            </div>
            
            <div class="platformer-game-over" id="platformerGameOver" style="display: none;">
                <h2>Game Over!</h2>
                <p class="final-score">Score: <span id="finalScore">0</span></p>
                <p class="final-coins">Coins: <span id="finalCoins">0</span></p>
                <p class="high-score-display">
                    <span id="highScoreText">High Score:</span> 
                    <span id="highScoreValue" style="color: #F59E0B; font-weight: 700;">0</span>
                </p>
                <button class="platformer-retry-btn" onclick="startPlatformerGame()">Try Again</button>
                <button class="platformer-menu-btn" onclick="backToPlatformerMenu()">Main Menu</button>
            </div>
        </div>
    </div>

    <!-- Game Canvas Container -->
    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="game-overlay-header">
            <button class="game-back-btn" onclick="exitGame()"> Back to Games</button>
            <div class="game-stats" id="gameStats"></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="game-controls" id="gameControls"></div>
    </div>

    <!-- Load Supabase - Using specific working version -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0"></script>

    <script>
        // Prevent duplicate initialization
        if (window.FocusForgeApp) {
            console.warn('FocusForge already initialized, skipping...');
        } else {
            window.FocusForgeApp = true;
            
        // Initialize Supabase client (will be set when library loads)
        var supabaseClient;
        var initAttempts = 0;
        var maxAttempts = 30; // Try for 3 seconds
        
        // Initialize once Supabase library is loaded
        (function initSupabase() {
            initAttempts++;
            
            if (initAttempts > maxAttempts) {
                console.error(' Failed to load Supabase library after 30 attempts');
                console.error('Please check your internet connection');
                return;
            }
            
            console.log('Checking for Supabase... (attempt ' + initAttempts + ')');
            console.log('window.supabase:', typeof window.supabase);
            console.log('window.supabaseClient:', typeof window.supabaseClient);
            
            // The UMD build exposes it directly
            if (typeof window.supabase !== 'undefined' && !supabaseClient) {
                const SUPABASE_URL = 'https://kvzenytdmvomrrjmbfpt.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2emVueXRkbXZvbXJyam1iZnB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMzUxNDMsImV4cCI6MjA4MjYxMTE0M30.jWbunMW2PYInaQGSPrclgYVOppUKhZ_WFVR4Xss3-2c';
                
                try {
                    console.log('window.supabase object:', window.supabase);
                    console.log('Has createClient?', typeof window.supabase.createClient);
                    
                    // Correct way - not destructuring
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    console.log(' Supabase client created');
                    console.log('Client object:', supabaseClient);
                    console.log('Has .from?', typeof supabaseClient.from);
                    console.log('Has .auth?', typeof supabaseClient.auth);
                    
                    // Test if it actually works
                    if (typeof supabaseClient.from !== 'function') {
                        console.error(' .from is not a function! Something is wrong with the client.');
                    }
                } catch (error) {
                    console.error(' Failed to create Supabase client:', error);
                }
            } else if (!supabaseClient) {
                // Retry after a short delay
                setTimeout(initSupabase, 100);
            }
        })();

        // Authentication state
        let isAuthenticated = false;
        let userName = 'Guest';
        let userType = 'guest'; // 'guest', 'logged-in', 'signed-up'
        let currentUser = null;

        // Edit Profile variables
        let userDisplayName = 'Guest';
        let userUsername = 'guest';
        let userEmail = 'guest@focusforge.app';
        let userAvatar = '';

        // Check if user is already logged in on page load
        //  PAUSED FOR DEVELOPMENT: Auto-enter as guest
        window.addEventListener('DOMContentLoaded', async function() {
            console.log(' Auth paused - entering as guest automatically');
            
            // CLEAR ANY OLD SESSION DATA
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('focusforge_userId');
            sessionStorage.clear();
            
            // Set guest mode
            userName = 'Guest';
            userType = 'guest';
            currentUser = null;
            isAuthenticated = true;
            
            // Set Edit Profile variables EXPLICITLY
            userDisplayName = 'Guest';
            userUsername = 'guest';
            userEmail = 'guest@focusforge.app';
            userAvatar = '';
            
            console.log(' Variables set:', { userDisplayName, userUsername, userEmail, userAvatar });
            
            // Update UI
            document.querySelector('.user-info h1').textContent = `Welcome, Guest!`;
            document.querySelector('.profile-name').textContent = 'Guest';
            
            // Hide logout button for guest
            const logoutBtn = document.querySelector('.account-action-btn.danger');
            if (logoutBtn) logoutBtn.style.display = 'none';
            
            // Show first view
            document.getElementById('dashboardView').classList.add('visible');
            
            // Load any saved guest data
            setTimeout(() => {
                loadCustomQuests();
                loadCompletedQuests();
                loadAnimationPreference();
                loadDensityPreference();
                loadSavedAvatar();
                loadChallengeState();
                loadStreakData();
                attachChallengeButtonListeners();
            }, 100);
            
            /* ORIGINAL AUTH CODE (PAUSED - EASY TO RESTORE):
            // Wait for supabase to be initialized
            while (!supabaseClient) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session?.user) {
                currentUser = session.user;
                
                // Get user profile from database
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (profile) {
                    userName = profile.name || session.user.email.split('@')[0];
                    userType = 'logged-in';
                    enterApp(true); // true = skip welcome popup
                }
            }
            */
        });

        // Auth modal functions - Define immediately
        window.showLoginModal = function() {
            document.getElementById('loginModalOverlay').classList.add('show');
        }

        window.showSignUpModal = function() {
            document.getElementById('signUpModalOverlay').classList.add('show');
        }

        window.closeAuthModal = function() {
            document.getElementById('loginModalOverlay').classList.remove('show');
            document.getElementById('signUpModalOverlay').classList.remove('show');
        }

        window.switchToSignUp = function() {
            closeAuthModal();
            setTimeout(() => showSignUpModal(), 100);
        }

        window.switchToLogin = function() {
            closeAuthModal();
            setTimeout(() => showLoginModal(), 100);
        }

        window.continueAsGuest = function() {
            userName = 'Guest';
            userType = 'guest';
            currentUser = null;
            enterApp();
        }

        window.handleLogin = async function(event) {
            console.log('Login form submitted');
            
            // Wait for Supabase to be initialized
            if (!supabaseClient) {
                console.error('Supabase not initialized yet');
                showInputError('loginEmailError', 'Please wait a moment and try again');
                return;
            }
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            console.log('Email:', email);

            // Simple validation
            if (!email || !password) {
                showInputError('loginEmailError', 'Please fill in all fields');
                return;
            }

            if (!isValidEmail(email)) {
                showInputError('loginEmailError', 'Please enter a valid email');
                document.getElementById('loginEmail').classList.add('invalid');
                return;
            }

            // Disable submit button
            const submitBtn = event.target;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                // Sign in with Supabase
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                
                // Get user profile
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();
                
                userName = profile?.name || email.split('@')[0];
                userType = 'logged-in';
                
                document.getElementById('loginEmail').classList.add('valid');
                document.getElementById('loginPassword').classList.add('valid');
                
                console.log('Login successful, username:', userName);
                
                setTimeout(() => {
                    closeAuthModal();
                    enterApp();
                }, 300);

            } catch (error) {
                console.error('Login error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error cause:', error.cause);
                
                let errorMessage = 'Login failed. ';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Check your internet connection or try a different network.';
                } else if (error.message.includes('Invalid')) {
                    errorMessage = 'Invalid email or password';
                } else {
                    errorMessage = error.message || 'Login failed. Please try again.';
                }
                
                showInputError('loginPasswordError', errorMessage);
                document.getElementById('loginPassword').classList.add('invalid');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Log In';
            }
        }

        window.handleSignUp = async function(event) {
            console.log('Sign up form submitted');
            
            // Wait for Supabase to be initialized
            if (!supabaseClient) {
                console.error('Supabase not initialized yet');
                showInputError('signUpNameError', 'Please wait a moment and try again');
                return;
            }
            
            const name = document.getElementById('signUpName').value;
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('signUpConfirmPassword').value;

            console.log('Name:', name, 'Email:', email);

            // Validation
            if (!name || !email || !password || !confirmPassword) {
                showInputError('signUpNameError', 'Please fill in all fields');
                return;
            }

            if (!isValidEmail(email)) {
                showInputError('signUpEmailError', 'Please enter a valid email');
                document.getElementById('signUpEmail').classList.add('invalid');
                return;
            }

            if (password.length < 6) {
                showInputError('signUpPasswordError', 'Password must be at least 6 characters');
                document.getElementById('signUpPassword').classList.add('invalid');
                return;
            }

            if (password !== confirmPassword) {
                showInputError('signUpConfirmPasswordError', 'Passwords do not match');
                document.getElementById('signUpConfirmPassword').classList.add('invalid');
                return;
            }

            // Disable submit button
            const submitBtn = event.target;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Account...';

            try {
                // Sign up with Supabase
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name
                        }
                    }
                });

                if (error) throw error;

                if (data.user) {
                    console.log(' User created in auth.users:', data.user.id);
                    console.log(' Attempting to create profile row...');
                    
                    // Create profile in database with all progress fields
                    const { data: profileData, error: profileError } = await supabaseClient
                        .from('profiles')
                        .insert([
                            {
                                id: data.user.id,
                                name: name,
                                email: email,
                                level: 1,
                                current_xp: 0,
                                total_xp: 0,
                                max_xp: 100,
                                quests_done: 0,
                                completed_quests: [],
                                custom_quests: [],
                                active_challenges: [],
                                completed_challenges: [],
                                avatar_data: null,
                                preferences: {
                                    density: 'comfortable',
                                    animations: true
                                }
                            }
                        ])
                        .select();

                    if (profileError) {
                        console.error(' PROFILE CREATION FAILED! ');
                        console.error('Error:', profileError);
                        console.error('Error message:', profileError.message);
                        console.error('Error details:', JSON.stringify(profileError, null, 2));
                        
                        // Show error to user
                        throw new Error(`Profile creation failed: ${profileError.message}`);
                    } else {
                        console.log(' Profile created successfully! ');
                        console.log('Profile data:', profileData);
                    }

                    currentUser = data.user;
                    userName = name;
                    userType = 'logged-in'; // Changed from 'signed-up' to match login
                    
                    document.getElementById('signUpName').classList.add('valid');
                    document.getElementById('signUpEmail').classList.add('valid');
                    document.getElementById('signUpPassword').classList.add('valid');
                    document.getElementById('signUpConfirmPassword').classList.add('valid');
                    
                    console.log('Sign up successful, username:', userName);
                    
                    // Award signup badge
                    setTimeout(() => awardSignupBadge(), 1000);
                    
                    setTimeout(() => {
                        closeAuthModal();
                        enterApp();
                    }, 300);
                } else {
                    throw new Error('Please check your email to confirm your account');
                }

            } catch (error) {
                console.error('Sign up error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error cause:', error.cause);
                
                let errorMessage = 'Sign up failed. ';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Check your internet connection or try a different network.';
                } else if (error.message.includes('already registered')) {
                    errorMessage = 'This email is already registered. Try logging in instead.';
                } else {
                    errorMessage = error.message || 'Sign up failed. Please try again.';
                }
                
                showInputError('signUpEmailError', errorMessage);
                document.getElementById('signUpEmail').classList.add('invalid');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showInputError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 3000);
        }

        function enterApp(skipPopup = false) {
            console.log(' Entering app with userName:', userName, 'userType:', userType);
            
            isAuthenticated = true;
            
            // Sync userDisplayName with userName for logged-in users
            if (userType === 'logged-in' && userName && userName !== 'Guest') {
                userDisplayName = userName;
                localStorage.setItem('focusforge_displayName', userName);
                console.log(' Set userDisplayName to:', userDisplayName);
            }
            
            // Update user name in header
            document.querySelector('.user-info h1').textContent = `Welcome, ${userName}!`;
            document.querySelector('.profile-name').textContent = userName;
            
            console.log(' Updated header to show:', userName);
            
            // Show/hide logout button based on user type
            updateLogoutButton();
            
            // Hide auth page and show app
            document.getElementById('authPage').style.display = 'none';
            document.body.classList.add('authenticated');
            document.getElementById('appContainer').style.display = 'block';
            
            // IMPORTANT: Reset all quest checkboxes before loading new user's data
            document.querySelectorAll('.quest-checkbox').forEach(checkbox => {
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                const questCard = checkbox.closest('.quest-card');
                if (questCard) questCard.classList.remove('completed');
            });
            console.log(' Reset all quest checkboxes in DOM');
            
            // Show success popup
            if (!skipPopup) {
                const popup = document.getElementById('xpPopup');
                popup.textContent = ` Welcome, ${userName}!`;
                popup.style.background = '#22C55E';
                popup.classList.add('show');
                
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.background = '#22C55E';
                }, 2000);
            }
            
            // Load progress from database (for logged-in users)
            setTimeout(async () => {
                console.log(' Starting data load for userType:', userType);
                await loadProgress();
                loadCustomQuests();
                loadCompletedQuests(); // This will re-check the correct quests
                loadProfileData();
                loadAnimationPreference();
                loadDensityPreference();
                loadSavedAvatar();
                loadNotificationSettings();
                loadChallengeState();
                loadStreakData();
                attachChallengeButtonListeners();
                console.log(' All data loaded after login');
                
                // Initialize first view
                document.getElementById('dashboardView').classList.add('visible');
                
                // Start guided experience for new users
                startGuidedExperience();
            }, 100);
        }

        function updateLogoutButton() {
            const logoutBtn = document.querySelector('.account-action-btn.danger');
            if (logoutBtn) {
                if (userType === 'guest') {
                    logoutBtn.style.display = 'none';
                } else {
                    logoutBtn.style.display = 'flex';
                }
            }
        }

        // Input validation on blur
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up input handlers');
            
            const inputs = document.querySelectorAll('.auth-input');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value) {
                        this.classList.remove('invalid');
                        this.classList.add('valid');
                    }
                });
                
                input.addEventListener('input', function() {
                    this.classList.remove('invalid');
                    const errorEl = this.parentElement.querySelector('.input-error');
                    if (errorEl) {
                        errorEl.classList.remove('show');
                    }
                });
            });
            
            // Real-time password matching validation
            const signUpPassword = document.getElementById('signUpPassword');
            const signUpConfirmPassword = document.getElementById('signUpConfirmPassword');
            
            if (signUpPassword && signUpConfirmPassword) {
                console.log('Password matching validation set up');
                
                const checkPasswordMatch = function() {
                    const password = signUpPassword.value;
                    const confirmPassword = signUpConfirmPassword.value;
                    
                    if (confirmPassword.length > 0) {
                        if (password !== confirmPassword) {
                            signUpConfirmPassword.classList.add('invalid');
                            signUpConfirmPassword.classList.remove('valid');
                            showInputError('signUpConfirmPasswordError', 'Passwords do not match');
                        } else {
                            signUpConfirmPassword.classList.remove('invalid');
                            signUpConfirmPassword.classList.add('valid');
                            const errorEl = document.getElementById('signUpConfirmPasswordError');
                            if (errorEl) {
                                errorEl.classList.remove('show');
                            }
                        }
                    }
                };
                
                signUpPassword.addEventListener('input', checkPasswordMatch);
                signUpConfirmPassword.addEventListener('input', checkPasswordMatch);
                signUpConfirmPassword.addEventListener('blur', checkPasswordMatch);
            }
            
            // Test if functions are accessible
            console.log('handleSignUp exists:', typeof window.handleSignUp);
            console.log('handleLogin exists:', typeof window.handleLogin);
        });

        // App state variables
        let currentXP = 0;
        let maxXP = 100;
        let totalXP = 0;
        let questsDone = 0;
        let currentFilter = 'all';
        let currentTab = 'today';
        let currentLevel = 1;
        
        // Streak tracking
        let currentStreak = 0;
        let longestStreak = 0;
        let lastActiveDate = null;
        let questsCompletedToday = 0;

        // Level titles
        const levelTitles = {
            1: 'FORGE BEGINNER',
            2: 'FORGE BEGINNER',
            3: 'FORGE APPRENTICE',
            4: 'FORGE APPRENTICE',
            5: 'FORGE CRAFTSMAN',
            6: 'FORGE CRAFTSMAN',
            7: 'FORGE EXPERT',
            8: 'FORGE EXPERT',
            9: 'FORGE MASTER',
            10: 'FORGE MASTER',
            11: 'FORGE LEGEND',
            12: 'FORGE LEGEND',
            13: 'FORGE CHAMPION',
            14: 'FORGE CHAMPION',
            15: 'FORGE ELITE'
        };

        // XP requirements for each level (doubles each time)
        function getXPForLevel(level) {
            return 100 * Math.pow(2, level - 1); // Level 1: 100, Level 2: 200, Level 3: 400, Level 4: 800, etc.
        }

        // View switching with animations
        let isTransitioning = false;
        
        window.switchView = function(viewName) {
            if (isTransitioning) return; // Prevent rapid tab switching
            isTransitioning = true;

            // Find current and new views
            const currentView = document.querySelector('.view.active');
            let newView;

            if (viewName === 'dashboard') {
                newView = document.getElementById('dashboardView');
            } else if (viewName === 'quests') {
                newView = document.getElementById('questsView');
            } else if (viewName === 'challenges') {
                newView = document.getElementById('challengesView');
                refreshChallengeStatus();
            } else if (viewName === 'account') {
                newView = document.getElementById('accountView');
                updateProfileStats();
            } else if (viewName === 'notificationSettings') {
                newView = document.getElementById('notificationSettingsView');
            } else if (viewName === 'focusSettings') {
                newView = document.getElementById('focusSettingsView');
            } else if (viewName === 'appearanceSettings') {
                newView = document.getElementById('appearanceSettingsView');
            } else if (viewName === 'privacySettings') {
                newView = document.getElementById('privacySettingsView');
            }

            if (!newView || currentView === newView) {
                isTransitioning = false;
                return;
            }

            // Start exit animation on current view
            if (currentView) {
                currentView.classList.add('exiting');
            }

            // Show new view and prepare for entrance
            newView.classList.add('active');
            
            // Force reflow to ensure transition happens
            void newView.offsetWidth;
            
            // Start entrance animation
            setTimeout(() => {
                newView.classList.add('visible');
            }, 10);

            // Clean up after transition
            setTimeout(() => {
                if (currentView) {
                    currentView.classList.remove('active', 'visible', 'exiting');
                }
                isTransitioning = false;
            }, 200);

            // Update navigation only for main tabs
            if (['dashboard', 'quests', 'challenges', 'account'].includes(viewName)) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                const navItem = document.querySelector(`[data-view="${viewName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
                
                // Track visited sections for Explorer badge
                const visitedSections = JSON.parse(localStorage.getItem('focusforge_visitedSections') || '[]');
                if (!visitedSections.includes(viewName)) {
                    visitedSections.push(viewName);
                    localStorage.setItem('focusforge_visitedSections', JSON.stringify(visitedSections));
                    
                    // Award Explorer badge if all 4 sections visited
                    if (visitedSections.length >= 4 && userType === 'logged-in') {
                        awardBadge('explorer');
                    }
                }
                
                // Check guidance for account navigation
                checkAccountNavigation(viewName);
            }

            window.scrollTo(0, 0);
        }

        // Update profile stats when viewing account page
        function updateProfileStats() {
            const levelTitle = levelTitles[currentLevel] || 'FORGE ELITE';
            document.getElementById('profileLevel').textContent = `Level ${currentLevel} ${levelTitle}`;
            document.getElementById('profileTotalXP').textContent = `${totalXP.toLocaleString()} Total XP`;
            document.getElementById('profileXPProgress').textContent = `${currentXP} / ${maxXP} XP to next level`;
            
            const profileXPBar = document.getElementById('profileXPBar');
            const percentage = Math.min((currentXP / maxXP) * 100, 100);
            profileXPBar.style.width = percentage + '%';

            // Update stat cards
            document.getElementById('totalQuestsCompleted').textContent = questsDone;
            document.getElementById('currentStreak').textContent = '0'; // Will be implemented with streak tracking
            document.getElementById('longestStreak').textContent = '0'; // Will be implemented with streak tracking
            document.getElementById('challengesCompleted').textContent = '0'; // Will be implemented with challenge tracking
        }

        // Quest completion functions
        function completeQuest(checkbox) {
            if (checkbox.classList.contains('checked')) return;

            const card = checkbox.closest('.quest-card');
            const xpValue = parseInt(card.getAttribute('data-xp'));
            const questId = card.getAttribute('data-quest-id');

            checkbox.classList.add('checked');
            checkbox.innerHTML = '';
            card.classList.add('completed');

            // Save to localStorage
            saveQuestCompletion(questId);

            showXPPopup(xpValue);

            setTimeout(() => {
                updateXP(xpValue);
            }, 300);
        }

        function completeQuestDetailed(checkbox) {
            if (checkbox.classList.contains('checked')) return;

            const card = checkbox.closest('.quest-card');
            const xpValue = parseInt(card.getAttribute('data-xp'));
            const questId = card.getAttribute('data-quest-id');

            checkbox.classList.add('checked');
            checkbox.innerHTML = '';

            // Save to localStorage
            saveQuestCompletion(questId);

            showXPPopup(xpValue);

            setTimeout(() => {
                card.classList.add('completed');
                
                setTimeout(() => {
                    const completedList = document.getElementById('completedList');
                    completedList.insertBefore(card, completedList.firstChild);
                    updateQuestCounts();
                    
                    if (completedList.classList.contains('collapsed')) {
                        toggleCompleted();
                    }
                }, 300);
            }, 500);

            setTimeout(() => {
                updateXP(xpValue);
            }, 300);
        }

        // Challenge functions
        function showChallengeInfo() {
            alert('Challenges are special multi-day goals that test your consistency and dedication. Complete them to earn bonus XP and exclusive rewards!');
        }

        // Challenge Tracking System
        window.startChallenge = function(button) {
            console.log(' ========== START CHALLENGE BUTTON CLICKED ==========');
            console.log(' startChallenge called, button:', button);
            
            try {
                const card = button.closest('.challenge-card');
                console.log(' Found card:', card);
                
                if (!card) {
                    console.error(' No challenge card found!');
                    alert('Error: Could not find challenge card. Please refresh the page.');
                    return;
                }
                
                const challengeId = card.dataset.challengeId;
                const days = parseInt(card.dataset.days);
                const xp = parseInt(card.dataset.xp);
                const title = card.querySelector('.challenge-card-title').textContent;
                const desc = card.querySelector('.challenge-card-desc').textContent;
                const difficulty = card.querySelector('.difficulty-badge').textContent;
                
                console.log(' Challenge data:', { challengeId, days, xp, title });
                
                // Get all active challenges (allow multiple)
                let activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
                console.log(' Current active challenges:', activeChallenges);
                
                // Check if this specific challenge is already active
                if (activeChallenges.some(c => c.id === challengeId)) {
                    console.log(' This specific challenge is already active');
                    alert('You already started this challenge!');
                    return;
                }
                
                console.log(' Starting challenge:', title);
                
                // Create challenge data
                const challengeData = {
                    id: challengeId,
                    title: title,
                    description: desc,
                    difficulty: difficulty,
                    totalDays: days,
                    xpReward: xp,
                    startDate: new Date().toISOString()
                };
                
                // Add to active challenges array
                activeChallenges.push(challengeData);
                localStorage.setItem('focusforge_activeChallenges', JSON.stringify(activeChallenges));
                console.log(' Challenge saved to localStorage');
                console.log(' Total active challenges:', activeChallenges.length);
                
                // Update UI
                button.textContent = 'In Progress';
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
                
                // Update active challenge display
                updateActiveChallengeDisplay();
                
                // Show notification
                const popup = document.getElementById('xpPopup');
                popup.textContent = ` Challenge Started! Complete in ${days} days!`;
                popup.style.background = '#4F46E5';
                popup.classList.add('show');
                
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.background = '#22C55E';
                }, 2000);
                
            } catch (error) {
                console.error(' Error in startChallenge:', error);
                alert('Error starting challenge: ' + error.message);
            }
        }

        window.abandonChallenge = function(challengeId) {
            console.log(' ========== ABANDON BUTTON CLICKED ==========');
            console.log(' abandonChallenge called for:', challengeId);
            
            try {
                // If no challengeId passed, get it from the active challenge card
                if (!challengeId) {
                    const activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
                    if (activeChallenges.length > 0) {
                        challengeId = activeChallenges[0].id; // Default to first challenge
                    }
                }
                
                console.log(' Abandoning challenge ID:', challengeId);
                console.log(' Abandoning challenge immediately (no confirmation)');
                
                // Remove from active challenges array
                let activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
                const beforeCount = activeChallenges.length;
                activeChallenges = activeChallenges.filter(c => c.id !== challengeId);
                localStorage.setItem('focusforge_activeChallenges', JSON.stringify(activeChallenges));
                console.log(` Challenge removed. ${beforeCount}  ${activeChallenges.length} challenges`);
                
                // Reset UI
                updateActiveChallengeDisplay();
                resetChallengeButtons();
                console.log(' UI reset complete');
                
                // Show notification
                const popup = document.getElementById('xpPopup');
                popup.textContent = ' Challenge Abandoned';
                popup.style.background = '#EF4444';
                popup.classList.add('show');
                
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.background = '#22C55E';
                }, 1500);
                
                console.log(' ========== ABANDON COMPLETE ==========');
                
            } catch (error) {
                console.error(' Error in abandonChallenge:', error);
                alert('Error abandoning challenge: ' + error.message);
            }
        }

        function updateActiveChallengeDisplay() {
            const activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
            const container = document.getElementById('activeChallengesContainer');
            
            if (!container) {
                console.error(' Active challenges container not found!');
                return;
            }
            
            if (activeChallenges.length === 0) {
                // Show "no challenges" message
                container.innerHTML = `
                    <div class="no-challenges-message">
                        <div class="challenge-icon"></div>
                        <h3>No Active Challenges</h3>
                        <p>Start a challenge below to begin tracking your progress and earn bonus rewards!</p>
                    </div>
                `;
                return;
            }
            
            // Render ALL active challenges
            container.innerHTML = activeChallenges.map(challenge => {
                // Calculate days passed and remaining
                const startDate = new Date(challenge.startDate);
                const today = new Date();
                const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(0, challenge.totalDays - daysPassed);
                const progress = Math.min(100, Math.floor((daysPassed / challenge.totalDays) * 100));
                
                const difficultyIcons = { Easy: '', Medium: '', Hard: '' };
                const icon = difficultyIcons[challenge.difficulty] || '';
                
                return `
                    <div class="active-challenge-card" data-challenge-id="${challenge.id}">
                        <div class="challenge-icon">${icon}</div>
                        <h3 class="challenge-name">${challenge.title}</h3>
                        <p class="challenge-desc">${challenge.description}</p>
                        
                        <div class="challenge-progress-section">
                            <div class="challenge-progress-text">
                                <span>Progress</span>
                                <span><strong>${progress}% Complete (Day ${daysPassed + 1}/${challenge.totalDays})</strong></span>
                            </div>
                            <div class="challenge-progress-bar-container">
                                <div class="challenge-progress-bar-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div class="challenge-meta-row">
                            <div class="challenge-meta-item">
                                <span class="meta-label">Days Remaining</span>
                                <span class="meta-value">${daysRemaining} ${daysRemaining === 1 ? 'day' : 'days'}</span>
                            </div>
                            <div class="challenge-meta-item">
                                <span class="meta-label">Reward</span>
                                <span class="meta-value"> +${challenge.xpReward} XP</span>
                            </div>
                        </div>
                        
                        <button class="abandon-challenge-btn" data-challenge-id="${challenge.id}">Abandon Challenge</button>
                    </div>
                `;
            }).join('');
            
            // Attach abandon button handlers
            const abandonButtons = container.querySelectorAll('.abandon-challenge-btn');
            console.log(` Attaching listeners to ${abandonButtons.length} abandon buttons`);
            
            abandonButtons.forEach((btn, index) => {
                btn.addEventListener('click', function(e) {
                    console.log(` ========== ABANDON BUTTON ${index + 1} CLICKED ==========`);
                    e.preventDefault();
                    e.stopPropagation();
                    const challengeId = this.getAttribute('data-challenge-id');
                    console.log(' Challenge ID:', challengeId);
                    abandonChallenge(challengeId);
                }, true); // Use capture phase
            });
            
            console.log(` Abandon button listeners attached!`);
            console.log(` Displaying ${activeChallenges.length} active challenge(s)`);
            
            // Also update dashboard display
            updateDashboardChallenges();
        }

        function updateDashboardChallenges() {
            const activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
            const dashboardContainer = document.getElementById('dashboardActiveChallenges');
            
            if (!dashboardContainer) return;
            
            if (activeChallenges.length === 0) {
                // Show "no challenges" message
                dashboardContainer.innerHTML = `
                    <div class="challenge-card">
                        <div class="challenge-header">
                            <div class="challenge-title"> No Active Challenge</div>
                            <div class="challenge-timer">-- left</div>
                        </div>
                        <div class="challenge-progress">
                            <div class="challenge-progress-text">
                                <span>Progress</span>
                                <span><strong>0/0 days</strong></span>
                            </div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Show ALL active challenges (summary version for dashboard)
            dashboardContainer.innerHTML = activeChallenges.map(challenge => {
                // Calculate days passed and remaining
                const startDate = new Date(challenge.startDate);
                const today = new Date();
                const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(0, challenge.totalDays - daysPassed);
                const progress = Math.min(100, Math.floor((daysPassed / challenge.totalDays) * 100));
                
                const difficultyIcons = { Easy: '', Medium: '', Hard: '' };
                const icon = difficultyIcons[challenge.difficulty] || '';
                
                return `
                    <div class="challenge-card">
                        <div class="challenge-header">
                            <div class="challenge-title">${icon} ${challenge.title}</div>
                            <div class="challenge-timer">${daysRemaining} ${daysRemaining === 1 ? 'day' : 'days'} left</div>
                        </div>
                        <div class="challenge-progress">
                            <div class="challenge-progress-text">
                                <span>Progress</span>
                                <span><strong>Day ${daysPassed + 1}/${challenge.totalDays}</strong></span>
                            </div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resetChallengeButtons() {
            document.querySelectorAll('.start-challenge-btn').forEach(btn => {
                btn.textContent = 'Start Challenge';
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        }

        function checkChallengeProgress() {
            const challengeData = localStorage.getItem('focusforge_activeChallenge');
            if (!challengeData) return;
            
            const challenge = JSON.parse(challengeData);
            const today = new Date().toDateString();
            
            // Check if already counted today
            if (challenge.completedDays.includes(today)) {
                console.log(' Challenge: Already counted today');
                return;
            }
            
            // Check if the required quest was completed
            const completedQuests = JSON.parse(localStorage.getItem('focusforge_completedQuests') || '[]');
            
            let questCompleted = false;
            if (challenge.questId === 'all') {
                // Check if ALL quests completed (for Consistency King)
                const allQuestIds = ['quest-morning-routine', 'quest-deep-work', 'quest-evening-review'];
                questCompleted = allQuestIds.every(id => completedQuests.includes(id));
                console.log(' Consistency check - All quests completed:', questCompleted);
            } else {
                // Check specific quest
                questCompleted = completedQuests.includes(challenge.questId);
            }
            
            if (questCompleted) {
                console.log(' Challenge quest completed today!');
                challenge.completedDays.push(today);
                challenge.daysCompleted++;
                
                // Save updated challenge
                localStorage.setItem('focusforge_activeChallenge', JSON.stringify(challenge));
                
                // Update display
                updateActiveChallengeDisplay();
                
                // Check if challenge is complete
                if (challenge.daysCompleted >= challenge.totalDays) {
                    completeChallenge(challenge);
                }
            }
        }

        function checkForMissedDay() {
            const challengeData = localStorage.getItem('focusforge_activeChallenge');
            if (!challengeData) return;
            
            const challenge = JSON.parse(challengeData);
            
            // Only check for Consistency King
            if (challenge.questId !== 'all') return;
            
            const startDate = new Date(challenge.startDate);
            const today = new Date();
            startDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            // Calculate how many days should have passed
            const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            
            console.log(` Consistency King: ${daysSinceStart} days passed, ${challenge.daysCompleted} days completed`);
            
            // If more days have passed than completed, they missed a day
            if (daysSinceStart > challenge.daysCompleted && daysSinceStart < challenge.totalDays) {
                console.log(' Consistency King: Missed a day! Challenge failed.');
                failChallenge(challenge);
            }
        }

        function failChallenge(challenge) {
            console.log(' Challenge failed:', challenge.title);
            
            // Award only 60 XP for failure
            const failureXP = 60;
            currentXP += failureXP;
            totalXP += failureXP;
            
            // Check for level up
            while (currentXP >= maxXP) {
                levelUp();
            }
            
            updateXPDisplay();
            saveProgress();
            
            // Add to completed challenges as failed
            const completedChallenges = JSON.parse(localStorage.getItem('focusforge_completedChallenges') || '[]');
            completedChallenges.push({
                ...challenge,
                completedDate: new Date().toISOString(),
                failed: true,
                xpReward: failureXP
            });
            localStorage.setItem('focusforge_completedChallenges', JSON.stringify(completedChallenges));
            
            // Remove active challenge
            localStorage.removeItem('focusforge_activeChallenge');
            
            // Update UI
            updateActiveChallengeDisplay();
            resetChallengeButtons();
            loadCompletedChallenges();
            
            // Show failure message
            const popup = document.getElementById('xpPopup');
            popup.textContent = ` Challenge Failed! +${failureXP} XP (consolation)`;
            popup.style.background = '#EF4444';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 3000);
        }

        function completeChallenge(challenge) {
            console.log(' Challenge completed!', challenge.title);
            
            // Award XP
            currentXP += challenge.xpReward;
            totalXP += challenge.xpReward;
            
            // Check for level up
            while (currentXP >= maxXP) {
                levelUp();
            }
            
            updateXPDisplay();
            saveProgress();
            
            // Add to completed challenges
            const completedChallenges = JSON.parse(localStorage.getItem('focusforge_completedChallenges') || '[]');
            completedChallenges.push({
                ...challenge,
                completedDate: new Date().toISOString()
            });
            localStorage.setItem('focusforge_completedChallenges', JSON.stringify(completedChallenges));
            
            // Remove active challenge
            localStorage.removeItem('focusforge_activeChallenge');
            
            // Update UI
            updateActiveChallengeDisplay();
            resetChallengeButtons();
            loadCompletedChallenges();
            
            // Show celebration
            const popup = document.getElementById('xpPopup');
            popup.textContent = ` Challenge Complete! +${challenge.xpReward} XP`;
            popup.style.background = '#22C55E';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }

        function loadCompletedChallenges() {
            const completedChallenges = JSON.parse(localStorage.getItem('focusforge_completedChallenges') || '[]');
            const completedList = document.getElementById('completedChallengesList');
            const completedCount = document.getElementById('completedChallengesCount');
            
            completedCount.textContent = completedChallenges.length;
            
            if (completedChallenges.length === 0) {
                completedList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No completed challenges yet. Keep pushing! </p>';
                return;
            }
            
            // Sort by completion date (newest first)
            completedChallenges.sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
            
            completedList.innerHTML = completedChallenges.map(challenge => {
                const completedDate = new Date(challenge.completedDate);
                const dateStr = completedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const difficultyColors = { Easy: '#22C55E', Medium: '#F59E0B', Hard: '#EF4444' };
                
                const isFailed = challenge.failed || false;
                const statusIcon = isFailed ? '' : '';
                const statusText = isFailed ? 'Failed' : 'Completed';
                const xpColor = isFailed ? '#EF4444' : '#22C55E';
                
                return `
                    <div class="completed-challenge-item ${isFailed ? 'failed' : ''}">
                        <div class="completed-challenge-header">
                            <h4 class="completed-challenge-title">${challenge.title}</h4>
                            <span class="completed-challenge-badge" style="background: ${difficultyColors[challenge.difficulty] || '#4F46E5'}">
                                ${challenge.difficulty}
                            </span>
                        </div>
                        <p class="completed-challenge-desc">${challenge.description}</p>
                        ${isFailed ? '<p class="challenge-failure-note"> Challenge incomplete - missed required daily tasks</p>' : ''}
                        <div class="completed-challenge-footer">
                            <span class="completed-challenge-date">${statusIcon} ${statusText} - ${dateStr}</span>
                            <span class="completed-challenge-xp" style="color: ${xpColor};"> +${challenge.xpReward} XP</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadChallengeState() {
            // Check if any challenge should be completed
            checkChallengeProgress();
            
            // Update active challenge display
            updateActiveChallengeDisplay();
            
            // Load completed challenges
            loadCompletedChallenges();
            
            // Set button states for active challenges
            const activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
            const activeIds = activeChallenges.map(c => c.id);
            
            document.querySelectorAll('.challenge-card').forEach(card => {
                const challengeId = card.dataset.challengeId;
                if (activeIds.includes(challengeId)) {
                    const btn = card.querySelector('.start-challenge-btn');
                    if (btn) {
                        btn.textContent = 'In Progress';
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    }
                }
            });
            
            // Attach event listeners
            attachChallengeButtonListeners();
        }

        function attachChallengeButtonListeners() {
            console.log(' Attaching event listeners to challenge buttons...');
            
            const buttons = document.querySelectorAll('.start-challenge-btn');
            console.log(` Found ${buttons.length} challenge buttons`);
            
            buttons.forEach((button, index) => {
                // Remove old onclick
                button.removeAttribute('onclick');
                
                // Add new event listener with capture phase
                button.addEventListener('click', function(e) {
                    console.log(` ========== BUTTON ${index + 1} CLICKED ==========`);
                    e.preventDefault();
                    e.stopPropagation();
                    window.startChallenge(this);
                }, true);
            });
            
            console.log(' Event listeners attached to all buttons!');
        }

        // Check challenges periodically (every time user visits challenges page)
        function refreshChallengeStatus() {
            checkChallengeProgress();
        }

        function toggleCompletedChallenges() {
            const completedList = document.getElementById('completedChallengesList');
            const collapseIcon = document.getElementById('collapseChallengesIcon');
            
            completedList.classList.toggle('collapsed');
            collapseIcon.classList.toggle('collapsed');
        }

        // Show XP popup
        function showXPPopup(xpValue) {
            const popup = document.getElementById('xpPopup');
            popup.textContent = `+${xpValue} XP`;
            popup.classList.add('show');

            setTimeout(() => {
                popup.classList.remove('show');
            }, 1000);
        }

        // Update XP
        function updateXP(xpValue) {
            currentXP += xpValue;
            totalXP += xpValue;
            questsDone++;
            questsCompletedToday++;
            
            // Update streak
            updateStreak();
            
            // Save daily quest count
            localStorage.setItem('focusforge_questsToday', questsCompletedToday);
            
            // Check guidance progress (for first quest completion)
            checkGuidanceProgress();

            // Check for level up
            while (currentXP >= maxXP) {
                levelUp();
            }

            const percentage = Math.min((currentXP / maxXP) * 100, 100);
            const xpBar = document.getElementById('xpBarFill');
            const xpText = document.getElementById('xpBarText');
            const totalXPEl = document.getElementById('totalXP');
            const questsDoneEl = document.getElementById('questsDoneCount');

            if (xpBar && xpText && totalXPEl && questsDoneEl) {
                xpBar.style.width = percentage + '%';
                xpText.textContent = `${currentXP} / ${maxXP} XP`;
                totalXPEl.textContent = totalXP.toLocaleString();
                questsDoneEl.textContent = questsDone;
            }
            
            // Save progress to localStorage
            saveProgress();
        }

        // Level up function
        function levelUp() {
            currentXP -= maxXP; // Carry over excess XP
            currentLevel++;
            maxXP = getXPForLevel(currentLevel);

            // Update level display
            const levelTitle = levelTitles[currentLevel] || 'FORGE ELITE';
            const userLevelEl = document.querySelector('.user-level');
            if (userLevelEl) {
                userLevelEl.textContent = `LEVEL ${currentLevel} ${levelTitle}`;
            }

            // Show level up popup
            const popup = document.getElementById('xpPopup');
            popup.textContent = ` LEVEL ${currentLevel}!`;
            popup.style.background = 'var(--primary)';
            popup.style.fontSize = '36px';
            popup.classList.add('show');

            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
                popup.style.fontSize = '32px';
            }, 2000);
            
            // Save progress to localStorage
            saveProgress();
        }

        // Update quest counts
        function updateQuestCounts() {
            const activeQuests = document.querySelectorAll('#questList .quest-card:not(.completed)').length;
            const completedCount = document.querySelectorAll('#completedList .quest-card').length;
            
            document.getElementById('activeCount').textContent = `${activeQuests} quest${activeQuests !== 1 ? 's' : ''}`;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // Toggle completed section
        function toggleCompleted() {
            const completedList = document.getElementById('completedList');
            const collapseIcon = document.getElementById('collapseIcon');
            
            completedList.classList.toggle('collapsed');
            collapseIcon.classList.toggle('collapsed');
        }

        // Filter dropdown
        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filterDropdown');
            const button = document.querySelector('.filter-button');
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('filterDropdown');
            const button = document.querySelector('.filter-button');
            if (dropdown && button && !dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.classList.remove('show');
                button.classList.remove('active');
            }
        });

        // Filter options
        document.querySelectorAll('.filter-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');
                filterQuests();
            });
        });

        // Tab navigation
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.getAttribute('data-tab');
            });
        });

        // Filter quests
        function filterQuests() {
            const allQuests = document.querySelectorAll('#questList .quest-card, #completedList .quest-card');
            
            allQuests.forEach(quest => {
                const category = quest.getAttribute('data-category');
                const isCompleted = quest.classList.contains('completed');
                
                if (currentFilter === 'all') {
                    quest.style.display = isCompleted ? 'none' : 'flex';
                } else if (currentFilter === 'completed') {
                    quest.style.display = isCompleted ? 'flex' : 'none';
                } else if (currentFilter === 'main') {
                    quest.style.display = category === 'main' && !isCompleted ? 'flex' : 'none';
                } else if (currentFilter === 'side') {
                    quest.style.display = category !== 'main' && !isCompleted ? 'flex' : 'none';
                }
            });
        }

        // Modal functions
        function openModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('modal').classList.remove('show');
        }

        window.selectCategory = function(element) {
            document.querySelectorAll('.category-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }

        window.createQuest = function(event) {
            console.log(' createQuest called!');
            event.preventDefault();
            
            // Get form values
            const title = document.getElementById('questTitle').value.trim();
            const description = document.getElementById('questDescription').value.trim();
            
            console.log(' Form values:', { title, description });
            
            // Get selected category
            const selectedCategory = document.querySelector('.category-option.selected');
            const category = selectedCategory ? selectedCategory.dataset.category : 'side';
            const categoryIcon = selectedCategory ? selectedCategory.textContent.split(' ')[0] : '';
            
            console.log(' Category:', { category, categoryIcon });
            
            // Automatic XP assignment based on category
            let xp;
            if (category === 'main') {
                xp = 150;
            } else {
                xp = 60; // side quests
            }
            
            console.log(' Automatic XP:', xp);
            
            if (!title) {
                alert('Please enter a quest title!');
                return;
            }
            
            // Generate unique ID
            const questId = 'custom-quest-' + Date.now();
            console.log(' Quest ID:', questId);
            
            // Save to localStorage first
            const customQuests = JSON.parse(localStorage.getItem('focusforge_customQuests') || '[]');
            customQuests.push({
                id: questId,
                title,
                description,
                xp,
                category,
                categoryIcon,
                createdAt: Date.now()
            });
            localStorage.setItem('focusforge_customQuests', JSON.stringify(customQuests));
            console.log(' Saved to localStorage:', customQuests);
            
            // Create quest card in DOM
            try {
                addQuestCardToDOM({
                    id: questId,
                    title,
                    description,
                    xp,
                    category,
                    categoryIcon
                });
                console.log(' Quest card added to DOM');
            } catch (error) {
                console.error(' Error adding quest card:', error);
            }
            
            // Update counts
            updateQuestCounts();
            
            // Clear form
            document.getElementById('questTitle').value = '';
            document.getElementById('questDescription').value = '';
            document.querySelectorAll('.category-option').forEach(opt => opt.classList.remove('selected'));
            
            closeModal();
            
            // Stay on current view (don't switch views)
            // The quest will appear on dashboard immediately
            
            const popup = document.getElementById('xpPopup');
            popup.textContent = ' Quest Created!';
            popup.style.background = '#4F46E5';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 1500);
            
            console.log(' Quest creation complete!');
        }

        function addQuestCardToDOM(quest) {
            // Add to Daily Quests view
            const questCard = document.createElement('div');
            questCard.className = 'quest-card custom-quest';
            if (quest.category === 'main') {
                questCard.classList.add('main-quest');
            }
            questCard.dataset.xp = quest.xp;
            questCard.dataset.questId = quest.id;
            
            questCard.innerHTML = `
                <div class="quest-checkbox" onclick="toggleQuest(this)"></div>
                <div class="quest-content">
                    <div class="quest-header">
                        <span class="quest-category">${quest.categoryIcon} ${quest.category.charAt(0).toUpperCase() + quest.category.slice(1)}</span>
                        <span class="quest-xp">+${quest.xp} XP</span>
                    </div>
                    <div class="quest-title">${quest.title}</div>
                    ${quest.description ? `<div class="quest-description">${quest.description}</div>` : ''}
                </div>
                <button class="delete-quest-btn" onclick="deleteQuest('${quest.id}', event)" title="Delete Quest"></button>
            `;
            
            // Add to appropriate section in Daily Quests view
            let targetSection;
            if (quest.category === 'main') {
                targetSection = document.querySelector('#dailyQuestsView .content > .section:first-child .quests-list');
            } else {
                targetSection = document.querySelector('#dailyQuestsView .content > .section:nth-child(2) .quests-list');
            }
            
            if (targetSection) {
                targetSection.appendChild(questCard);
            }
            
            // Also add to Dashboard's "Today's Quests" section
            const dashboardCard = document.createElement('div');
            dashboardCard.className = 'quest-card custom-quest';
            if (quest.category === 'main') {
                dashboardCard.classList.add('main-quest');
            }
            dashboardCard.dataset.xp = quest.xp;
            dashboardCard.dataset.questId = quest.id;
            
            dashboardCard.innerHTML = `
                <div class="quest-content">
                    <div class="quest-header">
                        <span class="quest-badge ${quest.category === 'main' ? '' : 'side'}">${quest.category.charAt(0).toUpperCase() + quest.category.slice(1)}</span>
                    </div>
                    <div class="quest-title">${quest.title}</div>
                    ${quest.description ? `<div class="quest-description">${quest.description}</div>` : ''}
                    <span class="quest-xp"> +${quest.xp} XP</span>
                </div>
                <div class="quest-checkbox" onclick="completeQuest(this)"></div>
                <button class="delete-quest-btn" onclick="deleteQuest('${quest.id}', event)" title="Delete Quest"></button>
            `;
            
            const dashboardList = document.getElementById('dashboardQuestsList');
            if (dashboardList) {
                dashboardList.appendChild(dashboardCard);
            }
        }

        window.deleteQuest = function(questId, event) {
            console.log(' deleteQuest called with ID:', questId);
            
            // Stop event from triggering other handlers (like checkbox toggle)
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            
            console.log(' Deleting quest immediately...');
            
            // Remove from DOM (both dashboard and daily quests view)
            const questCards = document.querySelectorAll(`[data-quest-id="${questId}"]`);
            console.log(' Found quest cards to delete:', questCards.length);
            
            if (questCards.length === 0) {
                console.error(' No quest cards found with ID:', questId);
                const allCards = document.querySelectorAll('.quest-card[data-quest-id]');
                console.log(' All quest cards on page:', allCards.length);
                allCards.forEach(card => {
                    console.log('  - Card ID:', card.dataset.questId);
                });
            }
            
            questCards.forEach((card, index) => {
                console.log(`Removing card ${index + 1}:`, card);
                card.style.transition = 'all 0.2s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    card.remove();
                    console.log(` Card ${index + 1} removed from DOM`);
                }, 200);
            });
            
            // Remove from localStorage
            const customQuests = JSON.parse(localStorage.getItem('focusforge_customQuests') || '[]');
            console.log(' Custom quests before delete:', customQuests.length);
            const updatedQuests = customQuests.filter(q => q.id !== questId);
            console.log(' Custom quests after delete:', updatedQuests.length);
            localStorage.setItem('focusforge_customQuests', JSON.stringify(updatedQuests));
            
            // Remove from completed quests if it was completed
            const completedQuests = JSON.parse(localStorage.getItem('focusforge_completedQuests') || '[]');
            const updatedCompleted = completedQuests.filter(id => id !== questId);
            localStorage.setItem('focusforge_completedQuests', JSON.stringify(updatedCompleted));
            
            // Update counts
            setTimeout(() => {
                updateQuestCounts();
            }, 250);
            
            const popup = document.getElementById('xpPopup');
            popup.textContent = ' Quest Deleted';
            popup.style.background = '#EF4444';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 1500);
            
            console.log(' Delete complete!');
        }

        // Initialize
        updateQuestCounts();

        // Account page functions
        let confirmAction = null;

        function editProfile() {
            alert('Edit Profile - Coming soon! You can customize your name, avatar, and preferences.');
        }

        function notificationSettings() {
            switchView('notificationSettings');
        }

        function focusSettings() {
            switchView('focusSettings');
        }

        function appearanceSettings() {
            switchView('appearanceSettings');
        }

        function privacySettings() {
            switchView('privacySettings');
        }

        function backToAccount() {
            switchView('account');
        }

        function viewWeeklySummary() {
            alert('Weekly Summary - Coming soon! View your productivity stats and achievements for the week.');
        }

        function exportData() {
            alert('Export Data - Your data will be downloaded as a JSON file.');
            // In a real app, this would trigger a download
        }

        // Settings toggle function
        function toggleSetting(settingName, value) {
            console.log(`Setting ${settingName} changed to: ${value}`);
            // In a real app, this would save to localStorage or backend
        }

        // Toggle animations function
        function toggleAnimations(enabled) {
            if (enabled) {
                document.body.classList.remove('no-animations');
                localStorage.setItem('focusforge_animations', 'true');
                console.log(' Animations enabled');
            } else {
                document.body.classList.add('no-animations');
                localStorage.setItem('focusforge_animations', 'false');
                console.log(' Animations disabled');
            }
        }

        // Load animation preference
        function loadAnimationPreference() {
            const animationsEnabled = localStorage.getItem('focusforge_animations') !== 'false';
            
            if (!animationsEnabled) {
                document.body.classList.add('no-animations');
                const toggle = document.getElementById('animationsToggle');
                if (toggle) toggle.checked = false;
            }
        }

        // Density Control Functions
        window.changeDensity = function(density) {
            console.log(' Changing density to:', density);
            
            // Remove all density classes
            document.body.classList.remove('density-compact', 'density-spacious');
            
            // Add the new density class (comfortable is default, no class needed)
            if (density === 'compact') {
                document.body.classList.add('density-compact');
            } else if (density === 'spacious') {
                document.body.classList.add('density-spacious');
            }
            
            // Save to localStorage
            localStorage.setItem('focusforge_density', density);
            console.log(' Density saved:', density);
        }

        function loadDensityPreference() {
            const savedDensity = localStorage.getItem('focusforge_density') || 'comfortable';
            console.log(' Loading density preference:', savedDensity);
            
            // Apply density class
            if (savedDensity === 'compact') {
                document.body.classList.add('density-compact');
            } else if (savedDensity === 'spacious') {
                document.body.classList.add('density-spacious');
            }
            
            // Update dropdown
            const select = document.getElementById('densitySelect');
            if (select) {
                select.value = savedDensity;
            }
        }

        // Avatar Selector Functions
        const animalAvatars = [
            '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', ''
        ];

        let selectedAvatar = null;
        let selectedAvatarType = 'emoji'; // 'emoji' or 'custom'
        let customAvatarData = null;

        window.openAvatarSelector = function() {
            console.log(' Opening avatar selector');
            
            const overlay = document.getElementById('avatarSelectorOverlay');
            const grid = document.getElementById('avatarGrid');
            
            // Load current avatar
            const savedData = localStorage.getItem('focusforge_avatar_data');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    selectedAvatar = parsed.avatar;
                    selectedAvatarType = parsed.type || 'emoji';
                    customAvatarData = parsed.customData || null;
                } catch (e) {
                    selectedAvatar = localStorage.getItem('focusforge_avatar') || '';
                    selectedAvatarType = 'emoji';
                }
            } else {
                selectedAvatar = localStorage.getItem('focusforge_avatar') || '';
                selectedAvatarType = 'emoji';
            }
            
            // Clear grid except camera button
            grid.innerHTML = '<div class="avatar-option camera-option" onclick="document.getElementById(\'avatarUpload\').click()"></div>';
            
            // Add custom image if exists
            if (selectedAvatarType === 'custom' && customAvatarData) {
                const customOption = document.createElement('div');
                customOption.className = 'avatar-option custom-image selected';
                customOption.innerHTML = `<img src="${customAvatarData}" alt="Custom avatar">`;
                customOption.onclick = () => selectAvatarOption(customOption, customAvatarData, 'custom');
                grid.appendChild(customOption);
            }
            
            // Populate emoji avatars
            animalAvatars.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                option.textContent = emoji;
                if (emoji === selectedAvatar && selectedAvatarType === 'emoji') {
                    option.classList.add('selected');
                }
                option.onclick = () => selectAvatarOption(option, emoji, 'emoji');
                grid.appendChild(option);
            });
            
            overlay.classList.add('show');
        }

        window.handleAvatarUpload = function(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log(' File selected:', file.name, 'Type:', file.type, 'Size:', file.size);
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file!');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onerror = function(error) {
                console.error(' FileReader error:', error);
                alert('Error reading file. Please try again.');
            };
            
            reader.onload = function(e) {
                const imageData = e.target.result;
                console.log(' Image loaded, data length:', imageData.length);
                
                // Validate the image data
                if (!imageData || !imageData.startsWith('data:image')) {
                    console.error(' Invalid image data');
                    alert('Invalid image format. Please try another image.');
                    return;
                }
                
                // Create or update custom image option
                const grid = document.getElementById('avatarGrid');
                let customOption = grid.querySelector('.custom-image');
                
                if (!customOption) {
                    customOption = document.createElement('div');
                    customOption.className = 'avatar-option custom-image';
                    // Insert after camera button
                    grid.insertBefore(customOption, grid.children[1]);
                    console.log(' Created new custom avatar option');
                } else {
                    console.log(' Updating existing custom avatar option');
                }
                
                customOption.innerHTML = `<img src="${imageData}" 
                    alt="Custom avatar" 
                    style="width: 100%; height: 100%; object-fit: cover;"
                    onerror="console.error('Failed to load image in grid')"
                    onload="console.log('Grid image loaded')">`;
                customOption.onclick = () => selectAvatarOption(customOption, imageData, 'custom');
                
                // Auto-select the uploaded image
                selectAvatarOption(customOption, imageData, 'custom');
                console.log(' Custom avatar auto-selected');
            };
            
            reader.readAsDataURL(file);
            console.log(' Reading file as Data URL...');
        }

        window.closeAvatarSelector = function() {
            const overlay = document.getElementById('avatarSelectorOverlay');
            overlay.classList.remove('show');
            
            // Reset file input
            document.getElementById('avatarUpload').value = '';
        }

        function selectAvatarOption(element, data, type) {
            // Remove selection from all options
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select this option
            element.classList.add('selected');
            selectedAvatar = data;
            selectedAvatarType = type;
            if (type === 'custom') {
                customAvatarData = data;
            }
        }

        window.saveAvatar = function() {
            if (!selectedAvatar) {
                alert('Please select an avatar!');
                return;
            }
            
            console.log(' Saving avatar:', selectedAvatar, 'Type:', selectedAvatarType);
            
            // Save to localStorage with type information
            const avatarData = {
                avatar: selectedAvatar,
                type: selectedAvatarType,
                customData: selectedAvatarType === 'custom' ? customAvatarData : null
            };
            localStorage.setItem('focusforge_avatar_data', JSON.stringify(avatarData));
            
            // Backward compatibility
            localStorage.setItem('focusforge_avatar', selectedAvatar);
            
            // Update all avatar displays
            updateAllAvatars(selectedAvatar, selectedAvatarType);
            
            // Close modal
            closeAvatarSelector();
            
            // Check personalization badges
            checkPersonalizationBadges();
            
            // Show confirmation
            const popup = document.getElementById('xpPopup');
            popup.textContent = ' Avatar Updated!';
            popup.style.background = '#4F46E5';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 1500);
        }

        function updateAllAvatars(avatar, type) {
            console.log(' Updating all avatars:', { avatar: avatar.substring(0, 50) + '...', type });
            
            const elements = [
                document.getElementById('profileAvatar'),
                document.getElementById('editProfileAvatar'),
                document.getElementById('editAvatar')  // Edit Profile page avatar
            ];
            
            // Update userAvatar variable for Edit Profile
            userAvatar = avatar;
            
            // Show/hide menu button based on avatar type
            const menuBtn = document.getElementById('avatarMenuBtn');
            if (menuBtn) {
                menuBtn.style.display = (type === 'custom') ? 'flex' : 'none';
            }
            
            elements.forEach(el => {
                if (!el) return;
                
                if (type === 'custom') {
                    console.log(' Setting custom avatar for:', el.id);
                    // Display custom image
                    el.style.padding = '0';
                    el.style.overflow = 'hidden';
                    el.style.background = 'transparent';  // Remove white background
                    el.innerHTML = `<img src="${avatar}" 
                        style="width: 100%; 
                               height: 100%; 
                               object-fit: cover; 
                               border-radius: 50%; 
                               display: block;
                               background: #f0f0f0;"
                        onerror="console.error(' Failed to load avatar image for ${el.id}'); this.parentElement.style.background='white'; this.parentElement.innerHTML='';"
                        onload="console.log(' Avatar image loaded successfully for ${el.id}')">`;
                } else {
                    console.log(' Setting emoji avatar for:', el.id);
                    // Display emoji
                    el.style.padding = '';
                    el.style.overflow = '';
                    el.style.background = 'white';  // Restore white background for emojis
                    el.innerHTML = '';
                    el.textContent = avatar;
                }
            });
            
            console.log(' All avatars updated to type:', type);
        }

        window.toggleAvatarMenu = function(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('avatarMenuDropdown');
            dropdown.classList.toggle('show');
            
            // Close menu when clicking outside
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closeAvatarMenuOnClickOutside);
                }, 0);
            }
        }

        function closeAvatarMenuOnClickOutside(event) {
            const dropdown = document.getElementById('avatarMenuDropdown');
            const menuBtn = document.getElementById('avatarMenuBtn');
            
            if (!dropdown.contains(event.target) && event.target !== menuBtn) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeAvatarMenuOnClickOutside);
            }
        }

        function loadSavedAvatar() {
            const savedData = localStorage.getItem('focusforge_avatar_data');
            
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    updateAllAvatars(parsed.avatar, parsed.type);
                } catch (e) {
                    // Fallback to old format
                    const savedAvatar = localStorage.getItem('focusforge_avatar') || '';
                    updateAllAvatars(savedAvatar, 'emoji');
                }
            } else {
                // Legacy support
                const savedAvatar = localStorage.getItem('focusforge_avatar') || '';
                updateAllAvatars(savedAvatar, 'emoji');
            }
        }

        // Image Cropper Functionality
        let cropperImage = null;
        let cropperCtx = null;
        let cropperCanvas = null;
        let imageScale = 1;
        let imageX = 0;
        let imageY = 0;
        let isDragging = false;
        let longPressTimer = null;

        window.openCropperForAvatar = function() {
            console.log(' Opening cropper for current avatar');
            
            // Close menu dropdown
            const dropdown = document.getElementById('avatarMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            const savedData = localStorage.getItem('focusforge_avatar_data');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.type === 'custom' && parsed.customData) {
                        openCropper(parsed.customData);
                    } else {
                        alert('No custom image to crop. Please upload an image first!');
                    }
                } catch (e) {
                    console.error('Error loading avatar for cropping:', e);
                    alert('Error loading your avatar. Please try uploading a new image.');
                }
            } else {
                alert('No custom image to crop. Please upload an image first!');
            }
        }

        window.toggleAvatarMenu = function(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('avatarMenuDropdown');
            dropdown.classList.toggle('show');
            
            // Close menu when clicking outside
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closeAvatarMenu, { once: true });
                }, 0);
            }
        }

        window.closeAvatarMenu = function() {
            const dropdown = document.getElementById('avatarMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function showAvatarMenuButton() {
            const menuBtn = document.getElementById('avatarMenuBtn');
            if (menuBtn) {
                menuBtn.style.display = 'flex';
                console.log(' Avatar menu button shown');
            }
        }

        function hideAvatarMenuButton() {
            const menuBtn = document.getElementById('avatarMenuBtn');
            if (menuBtn) {
                menuBtn.style.display = 'none';
                console.log(' Avatar menu button hidden');
            }
        }

        function openCropper(imageDataUrl) {
            console.log(' Opening image cropper');
            
            const overlay = document.getElementById('cropperOverlay');
            cropperCanvas = document.getElementById('cropperCanvas');
            cropperCtx = cropperCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                cropperImage = img;
                
                // Set canvas size
                const containerSize = Math.min(400, window.innerWidth - 100);
                cropperCanvas.width = containerSize;
                cropperCanvas.height = containerSize;
                
                // Calculate initial scale to fit image
                const scale = Math.max(
                    containerSize / img.width,
                    containerSize / img.height
                );
                imageScale = scale;
                
                // Center image
                imageX = (containerSize - img.width * scale) / 2;
                imageY = (containerSize - img.height * scale) / 2;
                
                drawCropper();
                setupCropperControls();
                
                overlay.classList.add('show');
            };
            img.src = imageDataUrl;
        }

        function setupCropperControls() {
            const zoomSlider = document.getElementById('zoomSlider');
            const canvas = cropperCanvas;
            
            // Zoom control
            const minScale = Math.max(
                cropperCanvas.width / cropperImage.width,
                cropperCanvas.height / cropperImage.height
            );
            zoomSlider.min = minScale;
            zoomSlider.max = 3;
            zoomSlider.value = imageScale;
            
            zoomSlider.oninput = function() {
                const newScale = parseFloat(this.value);
                const scaleDiff = newScale / imageScale;
                
                // Zoom towards center
                const centerX = cropperCanvas.width / 2;
                const centerY = cropperCanvas.height / 2;
                
                imageX = centerX - (centerX - imageX) * scaleDiff;
                imageY = centerY - (centerY - imageY) * scaleDiff;
                imageScale = newScale;
                
                drawCropper();
            };
            
            // Mouse dragging
            let startX, startY;
            
            canvas.onmousedown = e => {
                isDragging = true;
                startX = e.clientX - imageX;
                startY = e.clientY - imageY;
            };
            
            canvas.onmousemove = e => {
                if (isDragging) {
                    imageX = e.clientX - startX;
                    imageY = e.clientY - startY;
                    drawCropper();
                }
            };
            
            canvas.onmouseup = () => isDragging = false;
            canvas.onmouseleave = () => isDragging = false;
            
            // Touch dragging
            canvas.ontouchstart = e => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                isDragging = true;
                startX = touch.clientX - rect.left - imageX;
                startY = touch.clientY - rect.top - imageY;
            };
            
            canvas.ontouchmove = e => {
                e.preventDefault();
                if (isDragging) {
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    imageX = touch.clientX - rect.left - startX;
                    imageY = touch.clientY - rect.top - startY;
                    drawCropper();
                }
            };
            
            canvas.ontouchend = e => {
                e.preventDefault();
                isDragging = false;
            };
        }

        function drawCropper() {
            if (!cropperImage || !cropperCtx) return;
            
            // Clear canvas
            cropperCtx.clearRect(0, 0, cropperCanvas.width, cropperCanvas.height);
            
            // Draw image
            cropperCtx.drawImage(
                cropperImage,
                imageX,
                imageY,
                cropperImage.width * imageScale,
                cropperImage.height * imageScale
            );
        }

        window.closeCropper = function() {
            const overlay = document.getElementById('cropperOverlay');
            overlay.classList.remove('show');
            cropperImage = null;
            cropperCtx = null;
            isDragging = false;
        }

        window.saveCroppedImage = function() {
            console.log(' Saving cropped image');
            
            // Create circular crop
            const size = cropperCanvas.width;
            const outputCanvas = document.createElement('canvas');
            outputCanvas.width = size;
            outputCanvas.height = size;
            const ctx = outputCanvas.getContext('2d');
            
            // Draw circular clip
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
            
            // Draw the cropped image
            ctx.drawImage(
                cropperImage,
                imageX,
                imageY,
                cropperImage.width * imageScale,
                cropperImage.height * imageScale
            );
            
            // Get cropped image data
            const croppedDataUrl = outputCanvas.toDataURL('image/png');
            
            // Update avatar
            selectedAvatar = croppedDataUrl;
            selectedAvatarType = 'custom';
            customAvatarData = croppedDataUrl;
            
            // Save immediately
            const avatarData = {
                avatar: croppedDataUrl,
                type: 'custom',
                customData: croppedDataUrl
            };
            localStorage.setItem('focusforge_avatar_data', JSON.stringify(avatarData));
            localStorage.setItem('focusforge_avatar', croppedDataUrl);
            
            // Update all avatars
            updateAllAvatars(croppedDataUrl, 'custom');
            
            // Close cropper
            closeCropper();
            
            // Show success message
            const popup = document.getElementById('xpPopup');
            popup.textContent = ' Image Cropped!';
            popup.style.background = '#22C55E';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 1500);
            
            console.log(' Cropped image saved');
        }

        // Notification Management Functions
        window.toggleDailyQuestReminders = function(enabled) {
            console.log(' Daily Quest Reminders:', enabled ? 'ON' : 'OFF');
            localStorage.setItem('focusforge_dailyQuestReminders', enabled);
            
            if (enabled) {
                requestNotificationPermission();
                scheduleQuestReminder();
            } else {
                cancelQuestReminder();
            }
        }

        window.toggleChallengeUpdates = function(enabled) {
            console.log(' Challenge Updates:', enabled ? 'ON' : 'OFF');
            localStorage.setItem('focusforge_challengeUpdates', enabled);
        }

        window.toggleQuietHours = function(enabled) {
            console.log(' Quiet Hours:', enabled ? 'ON' : 'OFF');
            localStorage.setItem('focusforge_quietHours', enabled);
            saveQuietHours();
        }

        window.saveReminderTime = function(time) {
            console.log(' Reminder time set to:', time);
            localStorage.setItem('focusforge_reminderTime', time);
            scheduleQuestReminder();
        }

        window.saveQuietHours = function() {
            const start = document.getElementById('quietHoursStart').value;
            const end = document.getElementById('quietHoursEnd').value;
            
            localStorage.setItem('focusforge_quietHoursStart', start);
            localStorage.setItem('focusforge_quietHoursEnd', end);
            
            console.log(' Quiet Hours:', start, '-', end);
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.error(' This browser does not support notifications');
                alert(' Your browser does not support notifications. Please use Chrome, Firefox, or Edge.');
                return Promise.resolve('unsupported');
            }
            
            console.log(' Current notification permission:', Notification.permission);
            
            if (Notification.permission === 'default') {
                console.log(' Requesting notification permission...');
                return Notification.requestPermission().then(permission => {
                    console.log(' Notification permission result:', permission);
                    if (permission === 'granted') {
                        alert(' Notifications enabled! You\'ll receive daily reminders.\n\nClick "Send Test Now" to test it!');
                    } else if (permission === 'denied') {
                        showNotificationHelp();
                    }
                    return permission;
                });
            } else if (Notification.permission === 'denied') {
                showNotificationHelp();
                return Promise.resolve('denied');
            } else if (Notification.permission === 'granted') {
                console.log(' Notifications already enabled');
                return Promise.resolve('granted');
            }
        }

        function showNotificationHelp() {
            const isChromebook = navigator.userAgent.includes('CrOS');
            let message = ' Notifications are currently blocked.\n\n';
            
            if (isChromebook) {
                message += ' ON CHROMEBOOK:\n\n';
                message += '1. Click the  lock icon (or  info icon) in the address bar\n';
                message += '2. Look for "Notifications"\n';
                message += '3. Change it to "Allow"\n';
                message += '4. Reload this page\n';
                message += '5. Come back here and toggle notifications ON again';
            } else {
                message += 'TO ENABLE:\n\n';
                message += '1. Click the lock/info icon in the address bar\n';
                message += '2. Find "Notifications"\n';
                message += '3. Change to "Allow"\n';
                message += '4. Reload the page\n';
                message += '5. Toggle notifications ON again';
            }
            
            alert(message);
        }

        function isQuietHours() {
            const quietEnabled = localStorage.getItem('focusforge_quietHours') === 'true';
            if (!quietEnabled) return false;
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const start = localStorage.getItem('focusforge_quietHoursStart') || '22:00';
            const end = localStorage.getItem('focusforge_quietHoursEnd') || '08:00';
            
            const [startHour, startMin] = start.split(':').map(Number);
            const [endHour, endMin] = end.split(':').map(Number);
            
            const startTime = startHour * 60 + startMin;
            const endTime = endHour * 60 + endMin;
            
            // Handle overnight quiet hours (e.g., 22:00 - 08:00)
            if (startTime > endTime) {
                return currentTime >= startTime || currentTime < endTime;
            } else {
                return currentTime >= startTime && currentTime < endTime;
            }
        }

        function scheduleQuestReminder() {
            const enabled = localStorage.getItem('focusforge_dailyQuestReminders') === 'true';
            if (!enabled) return;
            
            const reminderTime = localStorage.getItem('focusforge_reminderTime') || '20:00';
            const [hour, minute] = reminderTime.split(':').map(Number);
            
            const now = new Date();
            const scheduled = new Date();
            scheduled.setHours(hour, minute, 0, 0);
            
            // If time has passed today, schedule for tomorrow
            if (scheduled <= now) {
                scheduled.setDate(scheduled.getDate() + 1);
            }
            
            const timeUntil = scheduled - now;
            
            console.log(' Next reminder scheduled for:', scheduled.toLocaleString());
            
            setTimeout(() => {
                checkAndNotifyIncompleteQuests();
                // Schedule next day's reminder
                scheduleQuestReminder();
            }, timeUntil);
        }

        function checkAndNotifyIncompleteQuests() {
            if (isQuietHours()) {
                console.log(' In quiet hours, skipping notification');
                return;
            }
            
            const completedQuests = JSON.parse(localStorage.getItem('focusforge_completedQuests') || '[]');
            
            if (completedQuests.length === 0) {
                showNotification(
                    ' Daily Quest Reminder',
                    "You haven't completed any quests today! Time to get started! "
                );
            }
        }

        function cancelQuestReminder() {
            console.log(' Quest reminders cancelled');
            // Note: Individual timeouts can't be cancelled without storing their IDs
            // This mainly prevents new reminders from being scheduled
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '',
                    badge: '',
                    tag: 'focusforge-reminder'
                });
                console.log(' Notification sent:', title);
            } else {
                console.log(' Notifications not available or not permitted');
            }
        }

        window.testNotification = function() {
            console.log(' Testing notification...');
            
            // Check if browser supports notifications
            if (!('Notification' in window)) {
                alert(' Your browser does not support notifications.\n\nNotifications work on:\n Chrome/Edge on Android\n Safari on iOS\n Desktop browsers (limited)');
                return;
            }
            
            // Check current permission
            if (Notification.permission === 'denied') {
                alert(' Notifications are blocked!\n\nTo enable:\n1. Click the  lock icon in your address bar\n2. Allow notifications for this site\n3. Reload the page and try again');
                return;
            }
            
            // Request permission if needed
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log(' Permission result:', permission);
                    if (permission === 'granted') {
                        sendTestNotification();
                    } else {
                        alert(' Notification permission denied.\n\nYou need to allow notifications to use this feature.');
                    }
                });
            } else {
                // Permission already granted
                sendTestNotification();
            }
        }

        function sendTestNotification() {
            // Show in-app notification
            const popup = document.getElementById('xpPopup');
            popup.textContent = ' Test notification sent!';
            popup.style.background = '#4F46E5';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 2000);
            
            // Send browser notification
            new Notification(' FocusForge Test', {
                body: "This is a test notification! You'll receive reminders like this when you have incomplete quests.",
                icon: '',
                badge: '',
                tag: 'focusforge-test',
                requireInteraction: false
            });
            
            console.log(' Test notification sent successfully!');
        }

        function loadNotificationSettings() {
            // Load Daily Quest Reminders
            const dailyReminders = localStorage.getItem('focusforge_dailyQuestReminders') !== 'false';
            const dailyToggle = document.getElementById('dailyQuestRemindersToggle');
            if (dailyToggle) dailyToggle.checked = dailyReminders;
            
            // Load Challenge Updates
            const challengeUpdates = localStorage.getItem('focusforge_challengeUpdates') !== 'false';
            const challengeToggle = document.getElementById('challengeUpdatesToggle');
            if (challengeToggle) challengeToggle.checked = challengeUpdates;
            
            // Load Quiet Hours
            const quietHours = localStorage.getItem('focusforge_quietHours') === 'true';
            const quietToggle = document.getElementById('quietHoursToggle');
            if (quietToggle) quietToggle.checked = quietHours;
            
            // Load times
            const reminderTime = localStorage.getItem('focusforge_reminderTime') || '20:00';
            const reminderInput = document.getElementById('reminderTime');
            if (reminderInput) reminderInput.value = reminderTime;
            
            const quietStart = localStorage.getItem('focusforge_quietHoursStart') || '22:00';
            const quietEnd = localStorage.getItem('focusforge_quietHoursEnd') || '08:00';
            const startInput = document.getElementById('quietHoursStart');
            const endInput = document.getElementById('quietHoursEnd');
            if (startInput) startInput.value = quietStart;
            if (endInput) endInput.value = quietEnd;
            
            // Schedule reminder if enabled
            if (dailyReminders) {
                scheduleQuestReminder();
            }
        }

        // Update XP display across all elements
        function updateXPDisplay() {
            const percentage = Math.min((currentXP / maxXP) * 100, 100);
            const xpBar = document.getElementById('xpBarFill');
            const xpText = document.getElementById('xpBarText');
            const totalXPEl = document.getElementById('totalXP');
            const questsDoneEl = document.getElementById('questsDoneCount');
            const levelTitle = levelTitles[currentLevel] || 'FORGE ELITE';
            const userLevelEl = document.querySelector('.user-level');

            if (xpBar) xpBar.style.width = percentage + '%';
            if (xpText) xpText.textContent = `${currentXP} / ${maxXP} XP`;
            if (totalXPEl) totalXPEl.textContent = totalXP.toLocaleString();
            if (questsDoneEl) questsDoneEl.textContent = questsDone;
            if (userLevelEl) userLevelEl.textContent = `LEVEL ${currentLevel} ${levelTitle}`;
        }

        // Save progress to localStorage
        async function saveProgress() {
            console.log(' saveProgress called for userType:', userType);
            
            // Save to localStorage (for guests and backup)
            localStorage.setItem('focusforge_xp', currentXP);
            localStorage.setItem('focusforge_totalXP', totalXP);
            localStorage.setItem('focusforge_level', currentLevel);
            localStorage.setItem('focusforge_maxXP', maxXP);
            localStorage.setItem('focusforge_questsDone', questsDone);
            console.log(' Saved to localStorage:', { currentXP, totalXP, currentLevel });
            
            // If logged in, save to database
            if (userType === 'logged-in' && currentUser && supabaseClient) {
                console.log(' Attempting to save to database for user:', currentUser.id);
                
                try {
                    const completedQuests = JSON.parse(localStorage.getItem('focusforge_completedQuests') || '[]');
                    const customQuests = JSON.parse(localStorage.getItem('focusforge_customQuests') || '[]');
                    const activeChallenges = JSON.parse(localStorage.getItem('focusforge_activeChallenges') || '[]');
                    const completedChallenges = JSON.parse(localStorage.getItem('focusforge_completedChallenges') || '[]');
                    const avatarData = localStorage.getItem('focusforge_avatar_data');
                    
                    const dataToSave = {
                        level: currentLevel,
                        current_xp: currentXP,
                        total_xp: totalXP,
                        max_xp: maxXP,
                        quests_done: questsDone,
                        completed_quests: completedQuests,
                        custom_quests: customQuests,
                        active_challenges: activeChallenges,
                        completed_challenges: completedChallenges,
                        avatar_data: avatarData ? JSON.parse(avatarData) : null,
                        preferences: {
                            density: localStorage.getItem('focusforge_density') || 'comfortable',
                            animations: localStorage.getItem('focusforge_animations') !== 'false'
                        }
                    };
                    
                    console.log(' Data to save:', dataToSave);
                    
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .update(dataToSave)
                        .eq('id', currentUser.id)
                        .select();
                    
                    if (error) {
                        console.error(' Error saving to database:', error);
                        console.error('Error details:', JSON.stringify(error, null, 2));
                    } else {
                        console.log(' Progress synced to cloud successfully');
                        console.log(' Database response:', data);
                        
                        // Check for badge unlocks
                        await checkBadges();
                    }
                } catch (error) {
                    console.error(' Exception in saveProgress:', error);
                    console.error('Error stack:', error.stack);
                }
            } else {
                console.log(' Not saving to database. userType:', userType, 'currentUser:', currentUser ? 'exists' : 'null', 'supabaseClient:', supabaseClient ? 'exists' : 'null');
            }
        }

        // Load progress from database (for logged-in users) or localStorage (for guests)
        async function loadProgress() {
            // If logged in, load from database first
            if (userType === 'logged-in' && currentUser && supabaseClient) {
                try {
                    console.log(' Loading progress from database...');
                    
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (error) throw error;
                    
                    if (data) {
                        console.log(' Database data received:', data);
                        
                        // Load from database
                        currentLevel = data.level || 1;
                        currentXP = data.current_xp || 0;
                        totalXP = data.total_xp || 0;
                        maxXP = data.max_xp || 100;
                        questsDone = data.quests_done || 0;
                        
                        console.log(' Loaded from database:', { 
                            currentLevel, 
                            currentXP, 
                            totalXP, 
                            maxXP, 
                            questsDone 
                        });
                        
                        // Save to localStorage as backup
                        localStorage.setItem('focusforge_xp', currentXP);
                        localStorage.setItem('focusforge_totalXP', totalXP);
                        localStorage.setItem('focusforge_level', currentLevel);
                        localStorage.setItem('focusforge_maxXP', maxXP);
                        localStorage.setItem('focusforge_questsDone', questsDone);
                        
                        // Load arrays
                        if (data.completed_quests) {
                            localStorage.setItem('focusforge_completedQuests', JSON.stringify(data.completed_quests));
                        }
                        if (data.custom_quests) {
                            localStorage.setItem('focusforge_customQuests', JSON.stringify(data.custom_quests));
                        }
                        if (data.active_challenges) {
                            localStorage.setItem('focusforge_activeChallenges', JSON.stringify(data.active_challenges));
                        }
                        if (data.completed_challenges) {
                            localStorage.setItem('focusforge_completedChallenges', JSON.stringify(data.completed_challenges));
                        }
                        if (data.avatar_data) {
                            localStorage.setItem('focusforge_avatar_data', JSON.stringify(data.avatar_data));
                        }
                        if (data.preferences) {
                            if (data.preferences.density) {
                                localStorage.setItem('focusforge_density', data.preferences.density);
                            }
                            if (data.preferences.animations !== undefined) {
                                localStorage.setItem('focusforge_animations', data.preferences.animations);
                            }
                        }
                        
                        console.log(' Progress loaded from database');
                    } else {
                        console.warn(' No data returned from database for user:', currentUser.id);
                    }
                } catch (error) {
                    console.error(' Error loading from database, using localStorage:', error);
                }
            }
            
            // Load from localStorage (fallback or for guests)
            // Check if it's a new day
            const lastDate = localStorage.getItem('focusforge_lastDate');
            const today = new Date().toDateString();
            
            if (lastDate && lastDate !== today) {
                // New day detected - reset quests but keep XP
                console.log(' New day detected! Resetting quests...');
                resetDailyQuests();
            }
            
            // Save today's date
            localStorage.setItem('focusforge_lastDate', today);
            
            // If not loaded from database, load from localStorage
            if (userType !== 'logged-in') {
                const savedXP = localStorage.getItem('focusforge_xp');
                const savedTotalXP = localStorage.getItem('focusforge_totalXP');
                const savedLevel = localStorage.getItem('focusforge_level');
                const savedMaxXP = localStorage.getItem('focusforge_maxXP');
                const savedQuestsDone = localStorage.getItem('focusforge_questsDone');
                
                if (savedXP) currentXP = parseInt(savedXP);
                if (savedTotalXP) totalXP = parseInt(savedTotalXP);
                if (savedLevel) currentLevel = parseInt(savedLevel);
                if (savedMaxXP) maxXP = parseInt(savedMaxXP);
                if (savedQuestsDone) questsDone = parseInt(savedQuestsDone);
            }
            
            console.log(' Loaded progress:', { currentXP, totalXP, currentLevel, maxXP, questsDone });
            
            // Update all UI elements
            updateXPDisplay();
        }

        function resetDailyQuests() {
            // Reset quest completion tracking
            localStorage.removeItem('focusforge_completedQuests');
            
            // Reset quests done counter (but keep XP and level)
            questsDone = 0;
            localStorage.setItem('focusforge_questsDone', '0');
            
            // NOTE: Custom quests are now PERMANENT - they stay forever!
            // We only uncheck them, not remove them
            
            // Uncheck all quest checkboxes in the DOM
            document.querySelectorAll('.quest-checkbox.checked').forEach(checkbox => {
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                checkbox.closest('.quest-card').classList.remove('completed');
            });
            
            // Update display
            updateXPDisplay();
            
            console.log(' Daily quests reset complete! (Custom quests preserved)');
        }

        // Quest persistence
        function saveQuestCompletion(questId) {
            const completedQuests = JSON.parse(localStorage.getItem('focusforge_completedQuests') || '[]');
            if (!completedQuests.includes(questId)) {
                completedQuests.push(questId);
                localStorage.setItem('focusforge_completedQuests', JSON.stringify(completedQuests));
            }
        }

        function loadCompletedQuests() {
            const completedQuests = JSON.parse(localStorage.getItem('focusforge_completedQuests') || '[]');
            
            completedQuests.forEach(questId => {
                const card = document.querySelector(`[data-quest-id="${questId}"]`);
                if (card) {
                    const checkbox = card.querySelector('.quest-checkbox');
                    if (checkbox && !checkbox.classList.contains('checked')) {
                        checkbox.classList.add('checked');
                        checkbox.innerHTML = '';
                        card.classList.add('completed');
                    }
                }
            });
        }

        function loadCustomQuests() {
            const customQuests = JSON.parse(localStorage.getItem('focusforge_customQuests') || '[]');
            
            customQuests.forEach(quest => {
                addQuestCardToDOM(quest);
            });
        }

        // Load progress and quests on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure all DOM elements are rendered
            setTimeout(() => {
                loadProgress();
                loadCustomQuests();
                loadCompletedQuests();
                loadProfileData();
                loadAnimationPreference();
                loadDensityPreference();
                loadSavedAvatar();
                loadNotificationSettings();
                loadChallengeState();
                console.log(' All data loaded');
                
                // Verify challenge functions are available
                console.log(' Checking challenge functions...');
                console.log('startChallenge available:', typeof window.startChallenge);
                console.log('abandonChallenge available:', typeof window.abandonChallenge);
                
                // Verify createQuest is accessible
                console.log(' Testing createQuest function:', typeof window.createQuest);
                if (typeof window.createQuest !== 'function') {
                    console.error(' createQuest is not defined!');
                } else {
                    console.log(' createQuest is properly defined');
                }
                
                // Verify deleteQuest is accessible
                console.log(' Testing deleteQuest function:', typeof window.deleteQuest);
                if (typeof window.deleteQuest !== 'function') {
                    console.error(' deleteQuest is not defined!');
                } else {
                    console.log(' deleteQuest is properly defined');
                }
                
                // GUARANTEED FIX: Bypass form submit, use direct button click
                const questForm = document.getElementById('createQuestForm');
                if (questForm) {
                    console.log(' Found quest form');
                    
                    const submitBtn = questForm.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        console.log(' Found submit button, attaching DIRECT click handler...');
                        
                        // Remove type="submit" to prevent form submission
                        submitBtn.type = 'button';
                        
                        // Direct click handler
                        submitBtn.addEventListener('click', function(e) {
                            console.log(' Direct button click - calling createQuest');
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Create a fake event object
                            const fakeEvent = {
                                preventDefault: () => {},
                                stopPropagation: () => {}
                            };
                            
                            window.createQuest(fakeEvent);
                        });
                        
                        console.log(' Direct click handler attached!');
                    } else {
                        console.error(' Submit button not found!');
                    }
                } else {
                    console.error(' Quest form not found!');
                }
            }, 100);
        });

        // Dark mode toggle
        function toggleDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('focusforge_darkMode', 'true');
                console.log(' Dark mode enabled');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('focusforge_darkMode', 'false');
                console.log(' Light mode enabled');
            }
        }

        // Load dark mode preference on page load
        window.addEventListener('DOMContentLoaded', function() {
            const darkModeEnabled = localStorage.getItem('focusforge_darkMode') === 'true';
            if (darkModeEnabled) {
                document.body.classList.add('dark-mode');
                // Set the toggle switch to checked
                const darkModeToggle = document.querySelector('#darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.checked = true;
                }
            }
        });

        // Accent color selection
        function selectAccentColor(element, color) {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            // Calculate lighter variations
            const lighterColor = adjustBrightness(color, 20);
            const lightestColor = adjustBrightness(color, 40);
            const tintColor = adjustBrightness(color, 80);
            
            // Update CSS variables
            document.documentElement.style.setProperty('--accent', color);
            document.documentElement.style.setProperty('--accent-light', lighterColor);
            document.documentElement.style.setProperty('--accent-lighter', lightestColor);
            document.documentElement.style.setProperty('--accent-tint', tintColor);
            
            // Save to localStorage
            localStorage.setItem('focusforge_accentColor', color);
            localStorage.setItem('focusforge_accentLight', lighterColor);
            localStorage.setItem('focusforge_accentLighter', lightestColor);
            localStorage.setItem('focusforge_accentTint', tintColor);
            
            console.log(` Accent color changed to ${element.querySelector('.color-name').textContent}`);
        }
        
        // Helper function to adjust color brightness
        function adjustBrightness(hex, percent) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Convert to RGB
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            
            // Increase brightness
            r = Math.min(255, r + Math.floor((255 - r) * (percent / 100)));
            g = Math.min(255, g + Math.floor((255 - g) * (percent / 100)));
            b = Math.min(255, b + Math.floor((255 - b) * (percent / 100)));
            
            // Convert back to hex
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }
        
        // Load accent color on page load
        function loadAccentColor() {
            const savedAccent = localStorage.getItem('focusforge_accentColor');
            const savedLight = localStorage.getItem('focusforge_accentLight');
            const savedLighter = localStorage.getItem('focusforge_accentLighter');
            const savedTint = localStorage.getItem('focusforge_accentTint');
            
            if (savedAccent) {
                document.documentElement.style.setProperty('--accent', savedAccent);
                document.documentElement.style.setProperty('--accent-light', savedLight);
                document.documentElement.style.setProperty('--accent-lighter', savedLighter);
                document.documentElement.style.setProperty('--accent-tint', savedTint);
                
                // Update selected color option
                const colorOption = document.querySelector(`.color-option[onclick*="${savedAccent}"]`);
                if (colorOption) {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    colorOption.classList.add('selected');
                }
            }
        }

        // Edit Profile Functions
        function openEditProfile() {
            console.log(' Opening Edit Profile with values:', {
                userDisplayName,
                userUsername,
                userEmail,
                userAvatar
            });
            
            // Load current values
            document.getElementById('editDisplayName').value = userDisplayName || 'Guest';
            document.getElementById('editUsername').value = userUsername || 'guest';
            document.getElementById('editEmail').value = userEmail || 'guest@focusforge.app';
            
            // Load avatar properly (emoji or custom image)
            const editAvatarEl = document.getElementById('editAvatar');
            const savedData = localStorage.getItem('focusforge_avatar_data');
            
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.type === 'custom' && parsed.avatar) {
                        // Custom image - use img tag
                        editAvatarEl.style.padding = '0';
                        editAvatarEl.style.overflow = 'hidden';
                        editAvatarEl.innerHTML = `<img src="${parsed.avatar}" 
                            style="width: 100%; 
                                   height: 100%; 
                                   object-fit: cover; 
                                   border-radius: 50%; 
                                   display: block;"
                            onerror="console.error('Failed to load avatar'); this.style.display='none';">`;
                    } else {
                        // Emoji - use text
                        editAvatarEl.style.padding = '';
                        editAvatarEl.style.overflow = '';
                        editAvatarEl.innerHTML = '';
                        editAvatarEl.textContent = parsed.avatar || userAvatar || '';
                    }
                } catch (e) {
                    console.error('Error loading avatar:', e);
                    editAvatarEl.textContent = userAvatar || '';
                }
            } else {
                // No saved data - use default
                editAvatarEl.textContent = userAvatar || '';
            }
            
            console.log(' Values set in form');
            
            // Show page with animation
            const editPage = document.getElementById('editProfilePage');
            editPage.style.display = 'block';
            
            // Add real-time validation
            setupInputValidation();
        }

        function closeEditProfile() {
            const editPage = document.getElementById('editProfilePage');
            editPage.style.animation = 'slideOutRight 0.3s ease-out';
            
            setTimeout(() => {
                editPage.style.display = 'none';
                editPage.style.animation = '';
                
                // Reload avatar to ensure it shows correctly on account page
                loadSavedAvatar();
            }, 300);
        }

        function setupInputValidation() {
            const displayNameInput = document.getElementById('editDisplayName');
            const usernameInput = document.getElementById('editUsername');
            
            displayNameInput.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    this.classList.remove('invalid');
                    this.classList.add('valid');
                } else {
                    this.classList.remove('valid');
                    this.classList.add('invalid');
                }
            });
            
            usernameInput.addEventListener('input', function() {
                const usernameRegex = /^[a-zA-Z0-9_]+$/;
                if (this.value.length >= 3 && usernameRegex.test(this.value)) {
                    this.classList.remove('invalid');
                    this.classList.add('valid');
                } else if (this.value.length > 0) {
                    this.classList.remove('valid');
                    this.classList.add('invalid');
                }
            });
        }

        function saveProfileChanges(event) {
            event.preventDefault();
            
            const newDisplayName = document.getElementById('editDisplayName').value.trim();
            const newUsername = document.getElementById('editUsername').value.trim();
            
            // Validation
            if (newDisplayName.length < 2) {
                showEditError('displayNameError', 'Display name must be at least 2 characters');
                return;
            }
            
            if (newUsername && !/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                showEditError('usernameError', 'Username can only contain letters, numbers, and underscores');
                return;
            }
            
            // Save changes
            userDisplayName = newDisplayName;
            userUsername = newUsername || newDisplayName.toLowerCase().replace(/\s/g, '_');
            userName = userDisplayName; // Update global userName
            
            // Save to localStorage
            localStorage.setItem('focusforge_displayName', userDisplayName);
            localStorage.setItem('focusforge_username', userUsername);
            localStorage.setItem('focusforge_avatar', userAvatar);
            
            // Update UI across app
            updateProfileDisplay();
            
            // Show success toast
            const popup = document.getElementById('xpPopup');
            popup.textContent = ' Profile Updated';
            popup.style.background = '#22C55E';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 2000);
            
            // Close edit page
            closeEditProfile();
        }

        function updateProfileDisplay() {
            // Update Account tab
            document.getElementById('profileName').textContent = userDisplayName;
            document.getElementById('profileAvatar').textContent = userAvatar;
            
            // Update Dashboard header
            document.querySelector('.user-info h1').textContent = `Welcome, ${userDisplayName}!`;
            
            console.log(' Profile updated:', { displayName: userDisplayName, username: userUsername });
        }

        function showEditError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 3000);
        }

        function changeProfilePhoto() {
            const emojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            userAvatar = randomEmoji;
            document.getElementById('editAvatar').textContent = randomEmoji;
            
            // Show preview
            const popup = document.getElementById('xpPopup');
            popup.textContent = `Avatar changed to ${randomEmoji}`;
            popup.style.background = '#4F46E5';
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                popup.style.background = '#22C55E';
            }, 1500);
        }

        // Load profile data on page load
        function loadProfileData() {
            const savedDisplayName = localStorage.getItem('focusforge_displayName');
            const savedUsername = localStorage.getItem('focusforge_username');
            const savedAvatar = localStorage.getItem('focusforge_avatar');
            
            if (savedDisplayName) userDisplayName = savedDisplayName;
            if (savedUsername) userUsername = savedUsername;
            if (savedAvatar) userAvatar = savedAvatar;
            
            updateProfileDisplay();
        }

        // ==================== BADGES SYSTEM ====================
        
        // Badge state
        let allBadges = [];
        let userBadges = [];

        // Open/Close Badges Screen with animation
        window.openBadgesPage = async function() {
            const screen = document.getElementById('badgesScreen');
            screen.classList.add('active');
            await loadBadges();
        }

        window.closeBadgesScreen = function() {
            const screen = document.getElementById('badgesScreen');
            screen.classList.remove('active');
        }

        // Load all badges and user's earned badges
        async function loadBadges() {
            if (userType !== 'logged-in' || !currentUser || !supabaseClient) {
                console.log('Not logged in, skipping badge load');
                return;
            }

            try {
                // Load all badge definitions
                const { data: badges, error: badgesError } = await supabaseClient
                    .from('badges')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (badgesError) throw badgesError;

                allBadges = badges || [];

                // Load user's earned badges
                const { data: earned, error: earnedError } = await supabaseClient
                    .from('user_badges')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (earnedError) throw earnedError;

                userBadges = earned || [];

                // Render badges
                renderBadges();

            } catch (error) {
                console.error('Error loading badges:', error);
            }
        }

        // Render badges by category
        function renderBadges() {
            const categories = ['getting-started', 'consistency', 'progress', 'quest', 'time', 'personalization', 'milestone'];
            
            let earnedCount = userBadges.length;
            let totalCount = allBadges.length;

            document.getElementById('badgesEarnedCount').textContent = earnedCount;
            document.getElementById('badgesTotalCount').textContent = totalCount;

            categories.forEach(category => {
                const container = document.getElementById(`category-${category}`);
                if (!container) return;

                const categoryBadges = allBadges.filter(b => b.category === category);
                
                container.innerHTML = categoryBadges.map(badge => {
                    const isEarned = userBadges.some(ub => ub.badge_id === badge.id);
                    const earnedBadge = userBadges.find(ub => ub.badge_id === badge.id);
                    const earnedDate = earnedBadge ? new Date(earnedBadge.earned_at).toLocaleDateString() : '';

                    return `
                        <div class="badge-card-item ${isEarned ? 'earned' : 'locked'}" 
                             onclick="openBadgeModal('${badge.id}', ${isEarned})">
                            ${!isEarned ? '<div class="badge-card-lock"></div>' : ''}
                            <div class="badge-card-icon">${badge.icon}</div>
                            <div class="badge-card-title">${badge.title}</div>
                            <div class="badge-card-description">${badge.description}</div>
                            ${isEarned ? `<div class="badge-card-date">Earned ${earnedDate}</div>` : ''}
                        </div>
                    `;
                }).join('');
            });
        }

        // Open badge detail modal
        window.openBadgeModal = function(badgeId, isEarned) {
            const badge = allBadges.find(b => b.id === badgeId);
            if (!badge) return;

            const earnedBadge = userBadges.find(ub => ub.badge_id === badgeId);
            
            document.getElementById('badgeModalIcon').textContent = badge.icon;
            document.getElementById('badgeModalTitle').textContent = badge.title;
            document.getElementById('badgeModalDescription').textContent = badge.description;
            
            const statusEl = document.getElementById('badgeModalStatus');
            const statusText = document.getElementById('badgeModalStatusText');
            
            if (isEarned) {
                statusEl.className = 'badge-modal-status earned';
                const date = new Date(earnedBadge.earned_at).toLocaleDateString();
                statusText.textContent = ` Earned on ${date}`;
            } else {
                statusEl.className = 'badge-modal-status locked';
                statusText.textContent = ' Not yet earned';
            }

            document.getElementById('badgeModalOverlay').classList.add('show');
            document.getElementById('badgeModal').classList.add('show');
        }

        window.closeBadgeModal = function() {
            document.getElementById('badgeModalOverlay').classList.remove('show');
            document.getElementById('badgeModal').classList.remove('show');
        }

        // Award a badge to user
        async function awardBadge(badgeId) {
            if (userType !== 'logged-in' || !currentUser || !supabaseClient) {
                return;
            }

            // Check if already earned
            if (userBadges.some(ub => ub.badge_id === badgeId)) {
                return; // Already earned
            }

            try {
                const { data, error } = await supabaseClient
                    .from('user_badges')
                    .insert([
                        {
                            user_id: currentUser.id,
                            badge_id: badgeId
                        }
                    ])
                    .select();

                if (error) throw error;

                // Add to local array
                userBadges.push(data[0]);

                // Show unlock animation
                const badge = allBadges.find(b => b.id === badgeId);
                if (badge) {
                    showBadgeUnlock(badge);
                }

                console.log(' Badge earned:', badgeId);

            } catch (error) {
                console.error('Error awarding badge:', error);
            }
        }

        // Show badge unlock popup
        function showBadgeUnlock(badge) {
            const overlay = document.getElementById('badgeUnlockOverlay');
            const popup = document.getElementById('badgeUnlockPopup');
            
            document.getElementById('badgeUnlockIcon').textContent = badge.icon;
            document.getElementById('badgeUnlockTitle').textContent = badge.title;
            document.getElementById('badgeUnlockDesc').textContent = badge.description;

            overlay.classList.add('show');
            popup.classList.add('show');

            // Auto-close after 3 seconds
            setTimeout(() => {
                closeBadgeUnlock();
            }, 3000);
        }

        window.closeBadgeUnlock = function() {
            document.getElementById('badgeUnlockOverlay').classList.remove('show');
            document.getElementById('badgeUnlockPopup').classList.remove('show');
        }

        // Check and award badges based on user actions
        async function checkBadges() {
            if (userType !== 'logged-in' || !currentUser) return;

            // ========== GETTING STARTED BADGES ==========
            
            // First Step - Complete your first quest
            if (questsDone >= 1) {
                await awardBadge('first-step');
            }

            // Getting the Hang of It - Complete 3 quests
            if (questsDone >= 3) {
                await awardBadge('getting-hang');
            }

            // Explorer - Open every main section (Dashboard, Quests, Challenges, Profile)
            // This is checked separately when navigating
            
            // ========== CONSISTENCY & HABIT BADGES ==========
            
            // Day One - Use app 2 days in a row
            if (currentStreak >= 2) {
                await awardBadge('day-one');
            }

            // Three-Day Flow - 3-day streak
            if (currentStreak >= 3) {
                await awardBadge('three-day-flow');
            }

            // Weekly Warrior - 7-day streak
            if (currentStreak >= 7) {
                await awardBadge('weekly-warrior');
            }

            // Steady Builder - 14-day streak
            if (currentStreak >= 14) {
                await awardBadge('steady-builder');
            }

            // Habit Formed - 30-day streak
            if (currentStreak >= 30) {
                await awardBadge('habit-formed');
            }

            // ========== PROGRESS & XP BADGES ==========
            
            // Level Up! - Reach level 2
            if (currentLevel >= 2) {
                await awardBadge('level-up');
            }

            // Rising Star - Reach level 5
            if (currentLevel >= 5) {
                await awardBadge('rising-star');
            }

            // Focused Mind - Reach level 10
            if (currentLevel >= 10) {
                await awardBadge('focused-mind');
            }

            // XP Collector - Earn 1,000 XP
            if (totalXP >= 1000) {
                await awardBadge('xp-collector');
            }

            // XP Master - Earn 10,000 XP
            if (totalXP >= 10000) {
                await awardBadge('xp-master');
            }

            // ========== QUEST-BASED BADGES ==========
            
            // Quest Finisher - Complete 10 quests
            if (questsDone >= 10) {
                await awardBadge('quest-finisher');
            }

            // On a Roll - Complete 5 quests in one day
            if (questsCompletedToday >= 5) {
                await awardBadge('on-a-roll');
            }

            // Productive Day - Finish all daily quests
            const todayQuests = document.querySelectorAll('#todayQuests .quest-card');
            const completedToday = document.querySelectorAll('#todayQuests .quest-card.completed');
            if (todayQuests.length > 0 && completedToday.length === todayQuests.length) {
                await awardBadge('productive-day');
            }

            // ========== MILESTONE BADGES ==========
            
            // Halfway There - Reach 50% of next level
            const progress = (currentXP / maxXP) * 100;
            if (progress >= 50) {
                await awardBadge('halfway-there');
            }

            // Legend in the Making - Reach level 25+
            if (currentLevel >= 25) {
                await awardBadge('legend-making');
            }
        }

        // Check personalization badges
        async function checkPersonalizationBadges() {
            if (userType !== 'logged-in' || !currentUser) return;

            // Make It Yours - Customize profile (avatar changed)
            const avatarData = localStorage.getItem('focusforge_avatar_data');
            if (avatarData && avatarData !== 'null') {
                await awardBadge('make-it-yours');
            }

            // Tuned In - Adjust settings (check if density or animations changed)
            const density = localStorage.getItem('focusforge_density');
            const animations = localStorage.getItem('focusforge_animations');
            if (density || animations !== null) {
                await awardBadge('tuned-in');
            }
        }

        // Update streak on quest completion
        function updateStreak() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem('focusforge_lastActiveDate');
            
            if (savedDate !== today) {
                // New day
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (savedDate === yesterdayStr) {
                    // Continued streak
                    currentStreak++;
                } else if (savedDate === null) {
                    // First time
                    currentStreak = 1;
                } else {
                    // Streak broken
                    currentStreak = 1;
                }
                
                // Update longest streak
                if (currentStreak > longestStreak) {
                    longestStreak = currentStreak;
                    localStorage.setItem('focusforge_longestStreak', longestStreak);
                }
                
                localStorage.setItem('focusforge_currentStreak', currentStreak);
                localStorage.setItem('focusforge_lastActiveDate', today);
                
                // Reset daily quest counter
                questsCompletedToday = 0;
                localStorage.setItem('focusforge_questsToday', 0);
            }
            
            // Update UI
            const currentStreakEl = document.getElementById('currentStreak');
            const longestStreakEl = document.getElementById('longestStreak');
            if (currentStreakEl) currentStreakEl.textContent = currentStreak;
            if (longestStreakEl) longestStreakEl.textContent = longestStreak;
        }

        // Load streak data
        function loadStreakData() {
            currentStreak = parseInt(localStorage.getItem('focusforge_currentStreak') || '0');
            longestStreak = parseInt(localStorage.getItem('focusforge_longestStreak') || '0');
            lastActiveDate = localStorage.getItem('focusforge_lastActiveDate');
            questsCompletedToday = parseInt(localStorage.getItem('focusforge_questsToday') || '0');
            
            updateStreak();
        }

        // Award "Signed & Ready" badge on signup
        async function awardSignupBadge() {
            if (userType === 'logged-in' && currentUser) {
                await awardBadge('signed-ready');
            }
        }

        // ==================== END BADGES SYSTEM ====================

        // ==================== GUIDED BANNER SYSTEM ====================
        
        // Guided banner state
        let guidanceStep = 0;
        let previousQuestCount = 0;
        
        // Start guided experience
        function startGuidedExperience() {
            console.log(' Starting guided experience...');
            
            // Check if user has seen guidance before
            const hasSeenGuidance = localStorage.getItem('focusforge_guidanceCompleted');
            if (hasSeenGuidance === 'true') {
                console.log(' User has already seen guidance, skipping');
                return;
            }
            
            // Start with step 1
            guidanceStep = 1;
            previousQuestCount = questsDone;
            localStorage.setItem('focusforge_guidanceStep', '1');
            
            // Show first banner
            setTimeout(() => {
                showGuideBanner('Scroll down to find your quests', 'step-scroll');
                
                // Auto-advance to step 2 after 10 seconds
                setTimeout(() => {
                    hideGuideBanner();
                    setTimeout(() => {
                        guidanceStep = 2;
                        localStorage.setItem('focusforge_guidanceStep', '2');
                        showGuideBanner('Complete your first quest', 'step-quest');
                    }, 500);
                }, 10000);
            }, 1000);
        }
        
        // Show banner with specific text and style
        function showGuideBanner(text, stepClass) {
            const banner = document.getElementById('guidedBanner');
            const bannerText = document.getElementById('guidedBannerText');
            
            if (!banner || !bannerText) return;
            
            // Set text and style
            bannerText.textContent = text;
            banner.className = 'guided-banner ' + stepClass;
            
            // Show banner
            banner.style.display = 'block';
            setTimeout(() => {
                banner.classList.add('show');
            }, 10);
            
            console.log(' Showing banner:', text);
        }
        
        // Hide banner
        function hideGuideBanner() {
            const banner = document.getElementById('guidedBanner');
            if (!banner) return;
            
            banner.classList.remove('show');
            banner.classList.add('hide');
            
            setTimeout(() => {
                banner.style.display = 'none';
                banner.classList.remove('hide');
            }, 500);
            
            console.log(' Hiding banner');
        }
        
        // Check guidance progress
        function checkGuidanceProgress() {
            const savedStep = parseInt(localStorage.getItem('focusforge_guidanceStep') || '0');
            
            if (savedStep === 0) return; // Not in guidance mode
            
            // Step 2: Waiting for first quest completion
            if (savedStep === 2 && questsDone > previousQuestCount) {
                console.log(' First quest completed! Moving to step 3');
                guidanceStep = 3;
                previousQuestCount = questsDone;
                localStorage.setItem('focusforge_guidanceStep', '3');
                
                // Hide current banner
                hideGuideBanner();
                
                // Show "Go to Account" banner
                setTimeout(() => {
                    showGuideBanner('Go to Account to see your badges', 'step-badges');
                }, 500);
            }
        }
        
        // Check if navigated to Account tab
        function checkAccountNavigation(viewName) {
            const savedStep = parseInt(localStorage.getItem('focusforge_guidanceStep') || '0');
            
            if (savedStep === 3 && viewName === 'account') {
                console.log(' Navigated to Account! Moving to step 4');
                guidanceStep = 4;
                localStorage.setItem('focusforge_guidanceStep', '4');
                
                // Hide current banner
                hideGuideBanner();
                
                // Show final banner
                setTimeout(() => {
                    showGuideBanner('Now explore the app and all the main tabs', 'step-explore');
                    
                    // Complete guidance after 10 seconds
                    setTimeout(() => {
                        hideGuideBanner();
                        localStorage.setItem('focusforge_guidanceCompleted', 'true');
                        localStorage.removeItem('focusforge_guidanceStep');
                        console.log(' Guidance completed!');
                    }, 10000);
                }, 500);
            }
        }

        // ==================== END GUIDED BANNER SYSTEM ====================

        // Platform Hopper - Endless Platformer Game
        function openBreakGames() {
            document.getElementById('breakGamesPage').style.display = 'block';
            document.getElementById('platformerStartScreen').style.display = 'flex';
            document.getElementById('platformerGameContainer').style.display = 'none';
        }

        function closeBreakGames() {
            const page = document.getElementById('breakGamesPage');
            page.style.animation = 'slideDownFade 0.3s ease-out';
            setTimeout(() => {
                page.style.display = 'none';
                page.style.animation = '';
            }, 300);
        }

        function backToPlatformerMenu() {
            document.getElementById('platformerGameContainer').style.display = 'none';
            document.getElementById('platformerStartScreen').style.display = 'flex';
            document.getElementById('platformerGameOver').style.display = 'none';
            if (window.platformerGameLoop) cancelAnimationFrame(window.platformerGameLoop);
        }

        function startPlatformerGame() {
            document.getElementById('platformerStartScreen').style.display = 'none';
            document.getElementById('platformerGameContainer').style.display = 'block';
            document.getElementById('platformerGameOver').style.display = 'none';
            
            const canvas = document.getElementById('platformerCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            runPlatformerGame(canvas);
        }

        function runPlatformerGame(canvas) {
            const ctx = canvas.getContext('2d');
            
            const game = {
                player: {
                    x: 150,
                    y: 200,
                    width: 30,
                    height: 30,
                    velocityY: 0,
                    velocityX: 0,
                    speed: 5,
                    gravity: 0.6,
                    jumpPower: -12,
                    maxJumpPower: -11.05,
                    minJumpPower: -8,
                    isJumping: false,
                    jumpHoldTime: 0,
                    onGround: false,
                    color: '#4F46E5'
                },
                platforms: [],
                coins: [],
                drone: null,
                projectiles: [],
                camera: { x: 0 },
                score: 0,
                coinsCollected: 0,
                distance: 0,
                gameOver: false,
                difficulty: 1,
                lastDroneScore: 0
            };

            // Generate initial platforms - ALWAYS spawn one under player
            game.platforms.push({
                x: 50,
                y: 350,
                width: 200,
                height: 20,
                moving: false,
                moveSpeed: 0,
                moveRange: 0,
                startY: 350
            });

            let lastPlatformX = 250;
            for (let i = 0; i < 15; i++) {
                const platformWidth = 120;
                const gap = 100 + Math.random() * 150;
                const height = 300 + Math.random() * 200;
                
                lastPlatformX += gap;
                game.platforms.push({
                    x: lastPlatformX,
                    y: height,
                    width: platformWidth,
                    height: 20,
                    moving: Math.random() < 0.2,
                    moveSpeed: Math.random() < 0.5 ? 1 : -1,
                    moveRange: 50,
                    startY: height
                });
            }

            // Input handling with variable jump (supports both Arrow keys AND WASD)
            const keys = {};
            window.addEventListener('keydown', e => {
                // Jump on ArrowUp, Space, OR W key
                if ((e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') && game.player.onGround && !keys[e.code]) {
                    game.player.velocityY = game.player.minJumpPower;
                    game.player.onGround = false;
                    game.player.isJumping = true;
                    game.player.jumpHoldTime = 0;
                    playJumpSound();
                }
                keys[e.code] = true;
            });
            
            window.addEventListener('keyup', e => {
                // Stop jumping on release
                if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') {
                    game.player.isJumping = false;
                }
                keys[e.code] = false;
            });

            // Touch/Click to jump
            let touchJumping = false;
            canvas.addEventListener('touchstart', () => {
                if (game.player.onGround && !game.gameOver) {
                    game.player.velocityY = game.player.minJumpPower;
                    game.player.onGround = false;
                    touchJumping = true;
                    game.player.jumpHoldTime = 0;
                    playJumpSound();
                }
            });
            
            canvas.addEventListener('touchend', () => {
                touchJumping = false;
            });

            canvas.addEventListener('click', () => {
                if (game.player.onGround && !game.gameOver) {
                    game.player.velocityY = game.player.minJumpPower;
                    game.player.onGround = false;
                    game.player.isJumping = true;
                    game.player.jumpHoldTime = 0;
                    playJumpSound();
                }
            });

            // Mobile button controls
            const mobileLeft = document.getElementById('mobileLeft');
            const mobileRight = document.getElementById('mobileRight');
            const mobileJump = document.getElementById('mobileJump');

            let mobileLeftPressed = false;
            let mobileRightPressed = false;
            let mobileJumpPressed = false;

            // Left button - Touch
            mobileLeft.addEventListener('touchstart', (e) => {
                e.preventDefault();
                mobileLeftPressed = true;
            });
            mobileLeft.addEventListener('touchend', (e) => {
                e.preventDefault();
                mobileLeftPressed = false;
            });

            // Left button - Mouse
            mobileLeft.addEventListener('mousedown', (e) => {
                e.preventDefault();
                mobileLeftPressed = true;
            });
            mobileLeft.addEventListener('mouseup', (e) => {
                e.preventDefault();
                mobileLeftPressed = false;
            });
            mobileLeft.addEventListener('mouseleave', (e) => {
                mobileLeftPressed = false;
            });

            // Right button - Touch
            mobileRight.addEventListener('touchstart', (e) => {
                e.preventDefault();
                mobileRightPressed = true;
            });
            mobileRight.addEventListener('touchend', (e) => {
                e.preventDefault();
                mobileRightPressed = false;
            });

            // Right button - Mouse
            mobileRight.addEventListener('mousedown', (e) => {
                e.preventDefault();
                mobileRightPressed = true;
            });
            mobileRight.addEventListener('mouseup', (e) => {
                e.preventDefault();
                mobileRightPressed = false;
            });
            mobileRight.addEventListener('mouseleave', (e) => {
                mobileRightPressed = false;
            });

            // Jump button - Touch
            mobileJump.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (game.player.onGround && !game.gameOver) {
                    game.player.velocityY = game.player.minJumpPower;
                    game.player.onGround = false;
                    mobileJumpPressed = true;
                    game.player.jumpHoldTime = 0;
                    playJumpSound();
                }
            });
            mobileJump.addEventListener('touchend', (e) => {
                e.preventDefault();
                mobileJumpPressed = false;
            });

            // Jump button - Mouse
            mobileJump.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (game.player.onGround && !game.gameOver) {
                    game.player.velocityY = game.player.minJumpPower;
                    game.player.onGround = false;
                    mobileJumpPressed = true;
                    game.player.jumpHoldTime = 0;
                    playJumpSound();
                }
            });
            mobileJump.addEventListener('mouseup', (e) => {
                e.preventDefault();
                mobileJumpPressed = false;
            });
            mobileJump.addEventListener('mouseleave', (e) => {
                mobileJumpPressed = false;
            });

            function spawnCoin(platformX, platformY) {
                if (Math.random() < 0.4) {
                    game.coins.push({
                        x: platformX + Math.random() * 80,
                        y: platformY - 60,
                        size: 12,
                        collected: false,
                        sparkle: 0
                    });
                }
            }

            function updateDrone() {
                // Spawn/despawn drone based on score
                const scoreThreshold = Math.floor(game.score / 50);
                
                // Drone appears at 50, 150, 250, etc (odd multiples of 50)
                // Drone disappears at 100, 200, 300, etc (even multiples of 50)
                if (scoreThreshold % 2 === 1 && !game.drone) {
                    // Spawn drone from top right
                    game.drone = {
                        x: game.camera.x + canvas.width + 50,
                        y: 80,
                        targetY: 80,
                        width: 40,
                        height: 30,
                        shootTimer: 0,
                        shootInterval: 2000
                    };
                } else if (scoreThreshold % 2 === 0 && game.drone) {
                    // Remove drone
                    game.drone = null;
                }

                // Update drone position and shooting
                if (game.drone) {
                    // Keep drone on right side of screen
                    game.drone.x = game.camera.x + canvas.width - 100;
                    
                    // Slowly move up and down
                    game.drone.targetY = 80 + Math.sin(Date.now() / 1000) * 40;
                    game.drone.y += (game.drone.targetY - game.drone.y) * 0.05;

                    // Shoot laser bullets
                    game.drone.shootTimer += 16;
                    if (game.drone.shootTimer > game.drone.shootInterval) {
                        game.drone.shootTimer = 0;
                        
                        // Play laser sound
                        playLaserSound();
                        
                        // Shoot toward player
                        const angle = Math.atan2(game.player.y - game.drone.y, game.player.x - game.drone.x);
                        game.projectiles.push({
                            x: game.drone.x,
                            y: game.drone.y,
                            velocityX: Math.cos(angle) * 3.6,
                            velocityY: Math.sin(angle) * 3.6,
                            size: 6
                        });
                    }
                }
            }

            // Coin collect sound effect
            function playCoinSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Coin sound: quick bright ascending tone
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.08);
                
                gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.08);
            }

            // Laser shoot sound effect
            function playLaserSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Spire rifle-like sound: high pitched descending tone
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.15);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            }

            // Jump sound effect
            function playJumpSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Jump sound: quick ascending tone
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            // Death/Fail sound effect
            function playFailSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Fail sound: descending "game over" tone
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            }

            function update() {
                if (game.gameOver) return;

                // Variable jump height - hold jump for higher jump
                if ((game.player.isJumping || touchJumping || mobileJumpPressed) && game.player.velocityY < 0) {
                    game.player.jumpHoldTime += 16;
                    if (game.player.jumpHoldTime < 100) { // Max hold time 100ms for full jump
                        game.player.velocityY += (game.player.maxJumpPower - game.player.minJumpPower) * 0.4; // Adjusted rate for 100ms
                    }
                } else {
                    game.player.isJumping = false;
                }

                // Player horizontal movement (Arrow keys, WASD, + mobile buttons)
                game.player.velocityX = 0;
                if (keys['ArrowLeft'] || keys['KeyA'] || mobileLeftPressed) {
                    game.player.velocityX = -game.player.speed;
                }
                if (keys['ArrowRight'] || keys['KeyD'] || mobileRightPressed) {
                    game.player.velocityX = game.player.speed;
                }

                game.player.x += game.player.velocityX;

                // Player physics
                game.player.velocityY += game.player.gravity;
                game.player.y += game.player.velocityY;

                // Update camera to follow player horizontally
                game.camera.x = Math.max(0, game.player.x - 200);

                // Keep player in horizontal bounds
                game.player.x = Math.max(game.camera.x + 10, game.player.x);

                // Platform collision
                game.player.onGround = false;
                game.platforms.forEach(platform => {
                    // Moving platforms
                    if (platform.moving) {
                        platform.y += platform.moveSpeed;
                        if (Math.abs(platform.y - platform.startY) > platform.moveRange) {
                            platform.moveSpeed *= -1;
                        }
                    }

                    // Collision detection
                    if (game.player.x + game.player.width > platform.x &&
                        game.player.x < platform.x + platform.width &&
                        game.player.y + game.player.height > platform.y &&
                        game.player.y + game.player.height < platform.y + platform.height + 10 &&
                        game.player.velocityY > 0) {
                        game.player.y = platform.y - game.player.height;
                        game.player.velocityY = 0;
                        game.player.onGround = true;
                        game.player.isJumping = false;
                    }
                });

                // Coin collection
                game.coins.forEach(coin => {
                    if (!coin.collected &&
                        Math.hypot(game.player.x + 15 - coin.x, game.player.y + 15 - coin.y) < 25) {
                        coin.collected = true;
                        game.coinsCollected++;
                        game.score += 10;
                        playCoinSound();
                    }
                    coin.sparkle += 0.1;
                });
                game.coins = game.coins.filter(c => !c.collected && c.x > game.camera.x - 100);

                // Update drone
                updateDrone();

                // Projectile movement and collision
                game.projectiles.forEach(proj => {
                    proj.x += proj.velocityX;
                    proj.y += proj.velocityY;

                    // Hit player
                    if (Math.hypot(game.player.x + 15 - proj.x, game.player.y + 15 - proj.y) < 20) {
                        endGame();
                    }
                });
                game.projectiles = game.projectiles.filter(p => p.x > game.camera.x - 100 && p.x < game.camera.x + canvas.width);

                // Generate new platforms
                const lastPlatform = game.platforms[game.platforms.length - 1];
                if (lastPlatform.x < game.camera.x + canvas.width + 500) {
                    const platformWidth = Math.max(80, 120 - game.difficulty * 3);
                    const gap = 120 + Math.random() * (150 + game.difficulty * 10);
                    const height = 250 + Math.random() * 250;
                    
                    const newPlatform = {
                        x: lastPlatform.x + gap,
                        y: height,
                        width: platformWidth,
                        height: 20,
                        moving: Math.random() < 0.25,
                        moveSpeed: Math.random() < 0.5 ? 1.5 : -1.5,
                        moveRange: 60,
                        startY: height
                    };
                    
                    game.platforms.push(newPlatform);
                    spawnCoin(newPlatform.x, newPlatform.y);
                }

                // Remove old platforms
                game.platforms = game.platforms.filter(p => p.x > game.camera.x - 200);

                // Update score and difficulty
                game.distance = Math.floor(game.player.x / 100);
                game.score = game.distance + game.coinsCollected * 10;
                game.difficulty = 1 + Math.floor(game.distance / 500);

                // Fall off screen
                if (game.player.y > canvas.height) {
                    endGame();
                }

                // Update HUD
                document.getElementById('platformerScore').textContent = game.score;
                document.getElementById('platformerCoins').textContent = game.coinsCollected;
            }

            function draw() {
                // Sky background
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#E0F6FF');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.save();
                ctx.translate(-game.camera.x, 0);

                // Platforms
                game.platforms.forEach(platform => {
                    ctx.fillStyle = '#CBD5E1';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetY = 4;
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Highlight
                    ctx.fillStyle = '#94A3B8';
                    ctx.fillRect(platform.x, platform.y, platform.width, 3);
                    ctx.shadowBlur = 0;
                });

                // Coins
                ctx.shadowBlur = 0;
                game.coins.forEach(coin => {
                    const sparkle = Math.sin(coin.sparkle) * 2;
                    ctx.fillStyle = '#FACC15';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.size + sparkle, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Sparkle effect
                    ctx.strokeStyle = 'rgba(250, 204, 21, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.size + sparkle + 3, 0, Math.PI * 2);
                    ctx.stroke();
                });

                // Drone
                if (game.drone) {
                    ctx.fillStyle = '#EF4444';
                    ctx.shadowColor = 'rgba(239, 68, 68, 0.5)';
                    ctx.shadowBlur = 10;
                    
                    // Drone body
                    ctx.fillRect(game.drone.x - game.drone.width/2, game.drone.y - game.drone.height/2, game.drone.width, game.drone.height);
                    
                    // Propellers
                    ctx.fillStyle = '#DC2626';
                    ctx.fillRect(game.drone.x - game.drone.width/2 - 5, game.drone.y - game.drone.height/2 - 3, 8, 3);
                    ctx.fillRect(game.drone.x + game.drone.width/2 - 3, game.drone.y - game.drone.height/2 - 3, 8, 3);
                    
                    // Eye/Camera
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(game.drone.x, game.drone.y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.shadowBlur = 0;
                }

                // Laser Projectiles
                game.projectiles.forEach(proj => {
                    // Bigger outer glow trail
                    ctx.strokeStyle = 'rgba(239, 68, 68, 0.4)';
                    ctx.lineWidth = 16;
                    ctx.beginPath();
                    ctx.moveTo(proj.x - proj.velocityX * 8, proj.y - proj.velocityY * 8);
                    ctx.lineTo(proj.x, proj.y);
                    ctx.stroke();
                    
                    // Medium glow trail
                    ctx.strokeStyle = 'rgba(239, 68, 68, 0.7)';
                    ctx.lineWidth = 10;
                    ctx.beginPath();
                    ctx.moveTo(proj.x - proj.velocityX * 6, proj.y - proj.velocityY * 6);
                    ctx.lineTo(proj.x, proj.y);
                    ctx.stroke();
                    
                    // Bright core trail
                    ctx.strokeStyle = 'rgba(248, 113, 113, 0.9)';
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(proj.x - proj.velocityX * 4, proj.y - proj.velocityY * 4);
                    ctx.lineTo(proj.x, proj.y);
                    ctx.stroke();
                    
                    // Outer bullet glow
                    ctx.fillStyle = '#EF4444';
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, proj.size + 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Laser core
                    ctx.fillStyle = '#FEE2E2';
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, proj.size, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Player
                ctx.fillStyle = game.player.color;
                ctx.shadowColor = 'rgba(79, 70, 229, 0.5)';
                ctx.shadowBlur = 10;
                ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
                
                // Player eyes
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#FFF';
                ctx.fillRect(game.player.x + 8, game.player.y + 8, 6, 6);
                ctx.fillRect(game.player.x + 16, game.player.y + 8, 6, 6);

                ctx.restore();
            }

            function endGame() {
                game.gameOver = true;
                
                // Play fail sound
                playFailSound();
                
                // Screen shake and flash
                ctx.fillStyle = 'rgba(239, 68, 68, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Update high score
                const highScore = parseInt(localStorage.getItem('platformer_highScore') || '0');
                if (game.score > highScore) {
                    localStorage.setItem('platformer_highScore', game.score);
                    document.getElementById('highScoreText').textContent = 'NEW HIGH SCORE! ';
                    document.getElementById('highScoreValue').textContent = game.score;
                } else {
                    document.getElementById('highScoreText').textContent = 'High Score:';
                    document.getElementById('highScoreValue').textContent = highScore;
                }
                
                document.getElementById('finalScore').textContent = game.score;
                document.getElementById('finalCoins').textContent = game.coinsCollected;
                document.getElementById('platformerGameOver').style.display = 'block';
                
                if (window.platformerGameLoop) cancelAnimationFrame(window.platformerGameLoop);
            }

            function gameLoop() {
                update();
                draw();
                if (!game.gameOver) {
                    window.platformerGameLoop = requestAnimationFrame(gameLoop);
                }
            }

            gameLoop();
        }

        // Privacy functions
        function viewStoredData() {
            alert('Stored Data:\n\n' +
                  `Total XP: ${totalXP}\n` +
                  `Level: ${currentLevel}\n` +
                  `Quests Completed: ${questsDone}\n` +
                  `Current XP Progress: ${currentXP}/${maxXP}`);
        }

        function confirmDeleteData() {
            document.getElementById('confirmModalTitle').textContent = 'Delete All Data?';
            document.getElementById('confirmModalText').textContent = 'This will permanently delete all your progress, quests, XP, and settings. This action cannot be undone!';
            confirmAction = 'deleteData';
            document.getElementById('confirmModalOverlay').classList.add('show');
        }

        function viewPrivacyPolicy() {
            alert('Privacy Policy - Coming soon! This will display FocusForge\'s privacy policy.');
        }

        function viewTermsOfService() {
            alert('Terms of Service - Coming soon! This will display FocusForge\'s terms of service.');
        }

        // Confirmation modal functions
        function confirmResetProgress() {
            document.getElementById('confirmModalTitle').textContent = 'Reset Progress?';
            document.getElementById('confirmModalText').textContent = 'This will reset your daily quest progress. Your total XP and level will not be affected. This action cannot be undone.';
            confirmAction = 'reset';
            document.getElementById('confirmModalOverlay').classList.add('show');
        }

        function confirmLogout() {
            document.getElementById('confirmModalTitle').textContent = 'Log Out?';
            document.getElementById('confirmModalText').textContent = 'Are you sure you want to log out? Your progress has been saved.';
            confirmAction = 'logout';
            document.getElementById('confirmModalOverlay').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModalOverlay').classList.remove('show');
            confirmAction = null;
        }

        function executeConfirmedAction() {
            if (confirmAction === 'reset') {
                // Clear ALL saved data from localStorage
                localStorage.removeItem('focusforge_completedQuests');
                localStorage.removeItem('focusforge_xp');
                localStorage.removeItem('focusforge_totalXP');
                localStorage.removeItem('focusforge_level');
                localStorage.removeItem('focusforge_maxXP');
                localStorage.removeItem('focusforge_questsDone');
                
                // Reset variables
                currentXP = 0;
                totalXP = 0;
                questsDone = 0;
                currentLevel = 1;
                maxXP = 100;
                
                // Update UI
                document.getElementById('questsDoneCount').textContent = '0';
                document.getElementById('totalXP').textContent = '0';
                document.getElementById('xpBarFill').style.width = '0%';
                document.getElementById('xpBarText').textContent = '0 / 100 XP';
                document.querySelector('.user-level').textContent = 'LEVEL 1 FORGE BEGINNER';
                
                // Reset all quest checkboxes
                document.querySelectorAll('.quest-checkbox.checked').forEach(checkbox => {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                    checkbox.closest('.quest-card').classList.remove('completed');
                });

                const popup = document.getElementById('xpPopup');
                popup.textContent = ' Progress Reset';
                popup.style.background = '#F59E0B';
                popup.classList.add('show');
                
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.background = '#22C55E';
                }, 1500);
                
            } else if (confirmAction === 'logout') {
                // Sign out from Supabase
                supabaseClient.auth.signOut().then(() => {
                    // CLEAR ALL LOCALSTORAGE to prevent data bleeding between users
                    localStorage.clear();
                    console.log(' LocalStorage cleared on logout');
                    
                    // Show popup
                    const popup = document.getElementById('xpPopup');
                    popup.textContent = ' Logged Out';
                    popup.style.background = '#4F46E5';
                    popup.classList.add('show');
                    
                    setTimeout(() => {
                        popup.classList.remove('show');
                        popup.style.background = '#22C55E';
                        
                        // Return to auth page
                        document.body.classList.remove('authenticated');
                        document.getElementById('appContainer').style.display = 'none';
                        document.getElementById('authPage').style.display = 'flex';
                        
                        // Reset user state
                        userName = 'Guest';
                        userType = 'guest';
                        isAuthenticated = false;
                        currentUser = null;
                        
                        // Reset app state
                        currentXP = 0;
                        totalXP = 0;
                        questsDone = 0;
                        currentLevel = 1;
                        maxXP = 100;
                    }, 1500);
                });
                
            } else if (confirmAction === 'deleteData') {
                // Delete all data
                currentXP = 0;
                maxXP = 100;
                totalXP = 0;
                questsDone = 0;
                currentLevel = 1;

                // Reset UI
                document.getElementById('xpBarFill').style.width = '0%';
                document.getElementById('xpBarText').textContent = '0 / 100 XP';
                document.getElementById('totalXP').textContent = '0';
                document.getElementById('questsDoneCount').textContent = '0';
                document.querySelector('.user-level').textContent = 'LEVEL 1 FORGE BEGINNER';

                // Reset all quests
                document.querySelectorAll('.quest-checkbox.checked').forEach(checkbox => {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                    checkbox.closest('.quest-card').classList.remove('completed');
                });

                const popup = document.getElementById('xpPopup');
                popup.textContent = ' All Data Deleted';
                popup.style.background = '#EF4444';
                popup.classList.add('show');
                
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.background = '#22C55E';
                    switchView('dashboard');
                }, 1500);
            }

            closeConfirmModal();
        }
        
        } // End of FocusForgeApp namespace protection
    </script>
    <!-- Avatar Selector Modal -->
    <div class="avatar-selector-overlay" id="avatarSelectorOverlay" onclick="closeAvatarSelector()">
        <div class="avatar-selector-modal" onclick="event.stopPropagation()">
            <div class="avatar-selector-header">
                <h2 class="avatar-selector-title">Choose Your Avatar</h2>
                <p class="avatar-selector-subtitle">Upload your own or select an animal</p>
            </div>
            
            <div class="avatar-grid" id="avatarGrid">
                <!-- Camera upload option (first) -->
                <div class="avatar-option camera-option" onclick="document.getElementById('avatarUpload').click()">
                    
                </div>
                <!-- Animal avatars will be populated here -->
            </div>
            
            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
            
            <div class="avatar-selector-footer">
                <button class="avatar-cancel-btn" onclick="closeAvatarSelector()">Cancel</button>
                <button class="avatar-save-btn" onclick="saveAvatar()">Save</button>
            </div>
        </div>
    </div>

    <!-- Image Cropper Modal -->
    <div class="cropper-overlay" id="cropperOverlay" onclick="closeCropper()">
        <div class="cropper-modal" onclick="event.stopPropagation()">
            <div class="cropper-header">
                <h2 class="cropper-title">Crop Your Image</h2>
                <p class="cropper-subtitle">Zoom and position your image</p>
            </div>
            
            <div class="cropper-container">
                <div class="cropper-canvas-wrapper">
                    <canvas id="cropperCanvas"></canvas>
                    <div class="cropper-circle-overlay"></div>
                </div>
                
                <div class="cropper-controls">
                    <div class="cropper-control-group">
                        <label class="cropper-label">Zoom</label>
                        <input type="range" id="zoomSlider" class="cropper-slider" min="1" max="3" step="0.01" value="1">
                    </div>
                </div>
            </div>
            
            <div class="cropper-footer">
                <button class="cropper-cancel-btn" onclick="closeCropper()">Cancel</button>
                <button class="cropper-save-btn" onclick="saveCroppedImage()">Apply Crop</button>
            </div>
        </div>
    </div>

</body>
</html>
